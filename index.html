<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Open Card Sorting Tool - Researcher Accounts</title>
  <style>
    /* --- (styles unchanged, shortened for clarity; keep your original styles here) --- */
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <header><h1>Open Card Sorting Tool</h1></header>

    <!-- Login / Signup -->
    <div id="authView" class="view active">
      <h2 id="authHeading">Researcher Login</h2>
      <form id="authForm" novalidate>
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="name@example.com" required>
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Password" required>
        <div>
          <button id="loginBtn" type="submit" class="btn">Login</button>
          <button id="signupBtn" type="button" class="btn btn-accent">Sign Up</button>
        </div>
      </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboardView" class="view">
      <h2>Dashboard</h2>
      <div>
        <button id="createStudyBtn" class="btn">Create New Study</button>
        <button id="logoutBtn" class="btn btn-accent">Logout</button>
      </div>
      <h3>Your Studies</h3>
      <div id="studiesList" aria-live="polite"></div>
    </div>

    <!-- Create Study -->
    <div id="setupView" class="view">
      <h2>Create a New Study</h2>
      <label for="studyName">Study name</label>
      <input type="text" id="studyName" required>
      <label for="cardsInput">Cards (one per line)</label>
      <textarea id="cardsInput" rows="8" required></textarea>
      <label for="instructionsInput">Instructions (optional)</label>
      <textarea id="instructionsInput" rows="4"></textarea>
      <div>
        <button id="saveStudyBtn" class="btn btn-success">Save Study</button>
        <button id="cancelCreateBtn" class="btn">Cancel</button>
      </div>
    </div>

    <!-- Share Link -->
    <div id="studyCreatedView" class="view">
      <h2>Study Created!</h2>
      <label for="studyLink">Share this link with participants</label>
      <input type="text" id="studyLink" readonly>
      <div>
        <button id="copyLinkBtn" class="btn">Copy Link</button>
        <button id="backToDashboardBtn" class="btn">Back to Dashboard</button>
      </div>
    </div>

    <!-- Participant, Results and Modals remain unchanged -->
    <!-- keep your existing participantView, participantModal, instructionsModal, resultsView HTML here -->
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const firebaseConfig = {/* your firebaseConfig */};
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // DOM references
  const authView = document.getElementById('authView');
  const dashboardView = document.getElementById('dashboardView');
  const setupView = document.getElementById('setupView');
  const studyCreatedView = document.getElementById('studyCreatedView');
  const studiesList = document.getElementById('studiesList');
  const studyNameInput = document.getElementById('studyName');
  const cardsInput = document.getElementById('cardsInput');
  const instructionsInput = document.getElementById('instructionsInput');
  const studyLinkInput = document.getElementById('studyLink');

  // Auth handlers
  async function doLogin(){ try{ await auth.signInWithEmailAndPassword(email.value, password.value);}catch(e){alert(e.message);} }
  async function doSignup(){ try{ await auth.createUserWithEmailAndPassword(email.value, password.value);}catch(e){alert(e.message);} }

  document.getElementById('authForm').onsubmit = e => { e.preventDefault(); doLogin(); }
  document.getElementById('loginBtn').onclick = doLogin;
  document.getElementById('signupBtn').onclick = doSignup;
  document.getElementById('logoutBtn').onclick = ()=>auth.signOut();

  // Create Study
  document.getElementById('createStudyBtn').onclick = () => { show(setupView); };
  document.getElementById('cancelCreateBtn').onclick = () => { show(dashboardView); };
  document.getElementById('saveStudyBtn').onclick = () => {
    const user = auth.currentUser;
    if(!user) return alert('Login required');
    const studyId = 'study_'+Date.now();
    const study = { 
      id: studyId, 
      name: studyNameInput.value.trim(), 
      cards: cardsInput.value.split('\n').map(l=>l.trim()).filter(Boolean),
      instructions: instructionsInput.value.trim(),
      createdAt: new Date().toISOString(),
      ownerUid: user.uid,
      isPublic: true
    };
    db.ref(`users/${user.uid}/studies/${studyId}`).set(study).then(()=>{
      studyLinkInput.value = location.origin+location.pathname+`?uid=${user.uid}&study=${studyId}`;
      show(studyCreatedView);
    });
  };
  document.getElementById('backToDashboardBtn').onclick = () => show(dashboardView);

  // Auth state listener
  auth.onAuthStateChanged(user=>{
    if(user){ show(dashboardView); showDashboard(user.uid); }
    else show(authView);
  });

  // Dashboard listing (simplified: only from users branch)
  function showDashboard(uid){
    studiesList.innerHTML='';
    db.ref(`users/${uid}/studies`).once('value').then(snap=>{
      const data = snap.val()||{};
      Object.entries(data).forEach(([id,study])=>{
        addStudyToDashboard(uid, id, study);
      });
    });
  }

  function addStudyToDashboard(uid, studyId, study){
    const div=document.createElement('div');
    div.textContent=study.name||'(Untitled)';
    studiesList.appendChild(div);
  }

  function show(view){
    [authView,dashboardView,setupView,studyCreatedView].forEach(v=>v.classList.remove('active'));
    view.classList.add('active');
  }
});
</script>
</body>
</html>
