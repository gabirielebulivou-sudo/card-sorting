<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Open Card Sorting Tool - Researcher Accounts</title>
  <style>
    :root {
      --primary:#4a6fa5;
      --secondary:#6b8cae;
      --accent:#ff6b6b;
      --light:#f8f9fa;
      --dark:#343a40;
      --success:#28a745;
      --border:#dee2e6;
    }

    * { box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI', system-ui, -apple-system, Roboto, Arial, sans-serif }

    body { background:#f5f7fa; color:var(--dark); line-height:1.5 }

    .container { max-width:1200px; margin:0 auto; padding:20px }

    header { background:var(--primary); color:white; padding:1rem; text-align:center; margin-bottom:2rem; border-radius:5px }

    .view { display:none; background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1); margin-bottom:2rem }
    .active { display:block }

    .btn { padding:.5rem 1rem; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer; margin:.25rem; touch-action:manipulation }
    .btn:hover { background:var(--secondary) }
    .btn:disabled { opacity:.6; cursor:not-allowed }
    .btn-success { background:var(--success) }
    .btn-accent { background:var(--accent); color:#fff }
    .btn-accent:hover { filter:brightness(0.95) }

    .hidden { display:none !important }

    label { display:block; margin:.25rem 0 .25rem; font-weight:600 }
    input, textarea {
      width:100%; padding:.5rem; margin-bottom:1rem; border:1px solid var(--border); border-radius:4px;
    }

    .study-item {
      border:1px solid var(--border); padding:.75rem; margin-bottom:.5rem;
      display:flex; justify-content:space-between; align-items:center; gap:.5rem; flex-wrap:wrap;
    }
    .study-actions { display:flex; gap:.25rem; flex-wrap:wrap }

    .instructions { background:#e9ecef; padding:1rem; margin-bottom:1rem; border-radius:4px }

    .category-card { background:#eee; padding:.25rem .5rem; border-radius:4px; margin:.25rem; display:inline-block }

    .table-wrap { overflow:auto; margin-top:1rem; border:1px solid var(--border); border-radius:6px }
    table { border-collapse:collapse; min-width:600px; width:100% }
    th, td { border:1px solid var(--border); padding:.5rem; text-align:center; white-space:nowrap }

    .card { background:white; border:1px solid var(--border); padding:1rem; margin:.25rem; border-radius:6px; cursor:grab; user-select:none; box-shadow:0 1px 0 rgba(0,0,0,0.05) }
    .card:active { cursor:grabbing }

    .muted { color:#6c757d }
    .badge { display:inline-block; padding:.1rem .4rem; border-radius:.25rem; font-size:.8rem; background:#edf2ff; color:#2f4e8b; border:1px solid #dbe4ff }

    /* Workspace layout */
    .workspace { display:grid; grid-template-columns: 340px 1fr; gap:18px; align-items:start; }
    .left-panel {
      background:#d1d1cf; border:1px solid #c5c5c3; border-radius:10px; padding:12px;
      position:sticky; top:12px; max-height:calc(100vh - 180px); overflow:auto;
    }
    .left-panel h3 { margin:.25rem 0 .5rem; }
    .cards-list { display:flex; flex-direction:column; gap:.5rem; }

    .right-panel { min-height:60vh; }
    .toolbar { margin-bottom:.5rem; display:flex; gap:.5rem; align-items:center; flex-wrap:wrap }

    /* Steps before creating categories */
    .steps { display:flex; flex-direction:column; gap:18px; margin-bottom:18px; }
    .stepbox {
      border:2px dashed #ddd; border-radius:14px; padding:18px; background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }

    /* Categories canvas */
    .categories-wrap {
      display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap:16px;
      transition: box-shadow 0.25s ease;
    }
    .categories-wrap.glow {
      box-shadow: 0 0 12px 3px rgba(74,111,165,0.35);
      border-radius:12px;
    }

    /* Category card */
    .category {
      background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.06); border:1px solid var(--border); overflow:hidden;
      transform:scale(0.9); opacity:0; animation:popIn .25s ease forwards;
    }
    @keyframes popIn {
      to { transform:scale(1); opacity:1; }
    }
    .cat-header {
      background:#3d4038; color:#fff; padding:.5rem .75rem; font-weight:600; text-align:center; position:relative;
    }
    .cat-title { cursor:text }
    .cat-delete, .cat-toggle {
      position:absolute; top:6px; color:#fff; cursor:pointer; opacity:.9; user-select:none
    }
    .cat-delete { left:8px }
    .cat-toggle { right:8px }
    .cat-body {
      padding:.5rem; background:#fff; margin:.5rem; border:1px solid var(--border); border-radius:8px; min-height:80px;
    }
    .cat-footer { text-align:center; font-size:.75rem; color:#6b6b6b; padding:.25rem .5rem .6rem; text-transform:uppercase; letter-spacing:.02em }

    /* Modal */
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:flex; align-items:center; justify-content:center;
      z-index:9999; padding:1rem;
    }
    .modal { background:#fff; border-radius:10px; width:min(640px, 100%); padding:1.25rem 1.25rem 1rem; box-shadow:0 10px 30px rgba(0,0,0,.25); }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <header><h1>Open Card Sorting Tool</h1></header>

    <!-- Participant -->
    <div id="participantView" class="view active">
      <h2 id="participantStudyName"></h2>
      <div id="participantInstructions" class="instructions hidden" aria-live="polite"></div>
      <div id="participantStatus" class="muted"></div>

      <div class="workspace">
        <aside class="left-panel">
          <h3>Cards</h3>
          <div class="muted" style="margin-bottom:.5rem;">Drag cards into groups on the right.</div>
          <div id="availableCards" class="cards-list"></div>
        </aside>

        <section class="right-panel">
          <div id="stepsWrap" class="steps">
            <div class="stepbox">
              <h3>How to sort</h3>
              <ol>
                <li>Review the list of cards on the left.</li>
                <li>Drag a card into the right panel to start a new category.</li>
                <li>Drop cards onto existing categories to group them.</li>
              </ol>
            </div>
          </div>

          <div class="toolbar">
            <!-- No Add Category button anymore -->
            <button id="submitSortingBtn" class="btn btn-success">Finish</button>
          </div>

          <div id="sortingArea" class="categories-wrap"></div>
        </section>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const availableCardsContainer = document.getElementById('availableCards');
  const sortingArea = document.getElementById('sortingArea');
  const stepsWrap = document.getElementById('stepsWrap');

  function updateStepsVisibility(){
    const hasAny = sortingArea.querySelectorAll('.category').length > 0;
    stepsWrap.classList.toggle('hidden', hasAny);
  }
  function updateCategoryCount(cat){
    const count = cat.querySelectorAll('.cat-body .card').length;
    cat.querySelector('.cat-footer').textContent = (count===1 ? '1 CARD' : `${count} CARDS`);
    updateStepsVisibility();
  }
  function makeCategory(name='Click to rename'){
    const cat = document.createElement('div'); cat.className='category';
    cat.innerHTML = `
      <div class="cat-header">
        <span class="cat-delete" title="Delete">ðŸ—‘</span>
        <span class="cat-title">${name}</span>
        <span class="cat-toggle" title="Collapse">â–´</span>
      </div>
      <div class="cat-body"></div>
      <div class="cat-footer">0 CARDS</div>
    `;
    sortingArea.appendChild(cat);

    // Events
    cat.querySelector('.cat-delete').onclick = () => deleteCategory(cat);
    cat.querySelector('.cat-toggle').onclick = () => toggleCollapse(cat);

    // Sortable for the category body
    new Sortable(cat.querySelector('.cat-body'), {
      group:'cards', animation:150,
      onAdd: () => updateCategoryCount(cat),
      onRemove: () => updateCategoryCount(cat)
    });

    updateStepsVisibility();
    return cat;
  }
  function deleteCategory(cat){
    const cards = [...cat.querySelectorAll('.cat-body .card')];
    cards.forEach(c => availableCardsContainer.appendChild(c));
    cat.remove();
    updateStepsVisibility();
  }
  function toggleCollapse(cat){
    const body = cat.querySelector('.cat-body'); const icon = cat.querySelector('.cat-toggle');
    const isHidden = body.classList.toggle('hidden');
    icon.textContent = isHidden ? 'â–¾' : 'â–´';
  }

  // Make left panel sortable
  new Sortable(availableCardsContainer, { group:'cards', animation:150 });

  // Magic: dropping directly into the area spawns a new category
  new Sortable(sortingArea, {
    group:'cards',
    animation:150,
    sort:false,
    onAdd: evt => {
      const item = evt.item;
      const cat = makeCategory();
      cat.querySelector('.cat-body').appendChild(item);
      updateCategoryCount(cat);
    }
  });

  // Visual polish: glow when dragging
  document.addEventListener('dragstart', () => sortingArea.classList.add('glow'), true);
  document.addEventListener('dragend', () => sortingArea.classList.remove('glow'), true);

  // Demo cards
  ["Apples","Bananas","Oranges","Grapes","Pineapples"].forEach(text=>{
    const c=document.createElement('div'); c.className='card'; c.textContent=text; c.dataset.cardText=text;
    availableCardsContainer.appendChild(c);
  });
});
</script>
</body>
</html>
