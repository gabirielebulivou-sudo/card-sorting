<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pasifika Open Card Sorting Tool</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #4a6fa5; --secondary: #6b8cae; --accent: #ff6b6b; --light: #f8f9fa; --dark: #343a40;
      --success: #28a745; --border: #dee2e6; --orange: #f59e0b; --orange-dark: #d97706;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', 'Segoe UI', system-ui, -apple-system, Roboto, Arial, sans-serif; }
    html, body { height: 100%; }
    body { background: #f8fafc; color: var(--dark); line-height: 1.6; font-size: 16px; }

    /* NEW: App Layout */
    .app-layout { display: grid; grid-template-rows: auto 1fr; grid-template-columns: 60px 1fr; height: 100%; }
    #appHeader { grid-area: 1 / 2 / 2 / 3; background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: flex-end; padding: 0 2rem; height: 60px; }
    #appSidebar { grid-area: 1 / 1 / 3 / 2; background: #fff; border-right: 1px solid var(--border); padding: 1rem 0; display: flex; flex-direction: column; align-items: center; gap: 1rem; }
    #appMain { grid-area: 2 / 2 / 3 / 3; overflow-y: auto; padding: 2rem; }
    .sidebar-icon { font-size: 1.5rem; cursor: pointer; color: #9ca3af; }
    .sidebar-icon:hover { color: var(--primary); }
    #userProfile { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
    #userAvatar { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; }

    .container { max-width: 1200px; margin: 0 auto; }
    .simple-header { text-align: center; margin-bottom: 2rem; }
    
    .view { display: none; background: transparent; padding: 0; border-radius: 0; box-shadow: none; }
    .view.active { display: block; }
    .view-card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.05); border: 1px solid var(--border); }
    
    .btn { padding: .5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 600; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-orange { background: var(--orange); color: white; }
    .btn-orange:hover { background: var(--orange-dark); }
    .btn-secondary { background: #e2e8f0; color: var(--dark); }
    .btn-secondary:hover { background: #cbd5e1; }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-accent:hover { filter: brightness(0.95); }

    .hidden { display: none !important; }
    .muted { color: #64748b; }
    
    /* NEW: Dashboard Styles */
    #dashboardView .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    #dashboardView h2 { font-size: 2rem; }
    .study-card { background: #fff; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 1.5rem; padding: 1.5rem; }
    .study-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .study-card-title { display: flex; align-items: center; gap: 1rem; }
    .study-card-title h3 { margin: 0; font-size: 1.25rem; }
    .study-card-icon { font-size: 1.5rem; color: var(--primary); }
    .study-card-body { padding-top: 1rem; }
    .actions-menu { position: relative; }
    .actions-menu-content { display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100; min-width: 200px; }
    .actions-menu:hover .actions-menu-content { display: block; }
    .actions-menu-content button { display: block; width: 100%; text-align: left; background: none; border: none; padding: 0.75rem 1rem; cursor: pointer; }
    .actions-menu-content button:hover { background: #f1f5f9; }
    .empty-dashboard { text-align: center; padding: 4rem 2rem; border: 2px dashed var(--border); border-radius: 12px; background: #f8fafc; }
    
    /* NEW: Setup/Edit View Styles */
    #setupView .setup-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
    #setupStudyName { font-size: 1.5rem; margin: 0; }
    #setupView .tabs { margin: 0 0 1.5rem 0; }
    .builder-row { display: grid; grid-template-columns: 1fr 2fr auto; gap: .5rem; align-items: center; }
    .builder-row input { margin: 0; }
    .builder-wrap { border: 1px solid var(--border); border-radius: 8px; padding: .75rem; background: #fafafa; margin-top: .5rem; }
    .builder-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: .5rem; }
    .builder-rows { display: flex; flex-direction: column; gap: .5rem; }
    
    /* Cards */
    .card { background: white; border: 1px solid var(--border); padding: 1rem; margin: .25rem; border-radius: 6px; cursor: grab; user-select: none; box-shadow: 0 1px 0 rgba(0,0,0,0.05); position: relative; font-size: 1rem; }
    .info-icon { position: absolute; top: 6px; right: 6px; background: transparent; border: none; color: #6b7280; font-size: 18px; cursor: pointer; }
    
    /* Participant Workspace */
    .workspace { display: grid; grid-template-columns: 300px 1fr 1fr 1fr; gap: 16px; align-items: start; }
    #availableCardsContainer { background: #e2e8f0; border-radius: 10px; padding: 12px; position: sticky; top: 12px; max-height: calc(100vh - 180px); overflow-y: auto; }
    .category-columns-wrap { grid-column: 2 / 5; display: contents; }
    .category-column { min-height: 60vh; display: flex; flex-direction: column; gap: 16px; }
    .drop-zone-placeholder { border: 2px dashed #cbd5e1; border-radius: 10px; min-height: 110px; padding: 14px; background: #f8fafc; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-weight: 600; text-align: center; }
    .toolbar { margin-bottom: .5rem; display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; justify-content: flex-end; grid-column: 1 / -1; }
    .category { background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.06); border: 1px solid var(--border); }
    .cat-header { background: #334155; color: #fff; padding: .5rem .75rem; }
    .cat-title-input { background: transparent; border: none; color: #fff; font-weight: 600; width: 100%; outline: none; padding: .15rem .25rem; font-size: 1rem; }
    .cat-body { padding: .5rem; background: #f8fafc; margin: .5rem; border: 1px solid var(--border); border-radius: 8px; min-height: 80px; }
    .cat-footer { text-align: center; font-size: .75rem; color: #64748b; padding: .25rem .5rem .6rem; text-transform: uppercase; }

    /* Results Page Styles */
    .tabs { display: flex; gap: .5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border); }
    .tab-btn { background: transparent; border: none; padding: .5rem .75rem; cursor: pointer; border-bottom: 3px solid transparent; }
    .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 600; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }
    #participantsPieChartWrap { display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid var(--border); }
    #participantsPieChart { width: 100px; height: 100px; border-radius: 50%; }
    .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
    .matrix-table-wrap { overflow-x: auto; padding: 1rem; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
    .similarity-matrix { border-collapse: collapse; width: 100%; font-size: 0.9rem; color: var(--dark); }
    .similarity-matrix th, .similarity-matrix td { border: 1px solid #dee2e6; padding: 0.5rem; text-align: center; min-width: 60px; height: 36px; }
    .similarity-matrix .label-cell { text-align: left; font-weight: 600; background-color: #e9ecef; padding-left: 1rem; }
    .similarity-matrix thead th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
    #matrixTooltip { position: absolute; display: none; background: rgba(10,20,30,0.9); color: white; padding: 8px 12px; border-radius: 6px; z-index: 10000; pointer-events: none; }
    .results-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.95rem; }
    .results-table th, .results-table td { border: 1px solid var(--border); padding: 0.75rem; text-align: left; }
    
    /* Participant Modals */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 1rem; }
    .modal { background: #fff; border-radius: 10px; width: min(640px, 100%); padding: 1.25rem; box-shadow: 0 10px 30px rgba(0,0,0,.25); max-height: 90vh; overflow: auto; overscroll-behavior: contain; }
    .modal .actions { display: flex; justify-content: flex-end; gap: .5rem; margin-top: .25rem; }

  </style>
</head>
<body>

  <!-- App Shell for Researchers -->
  <div class="app-layout">
    <header id="appHeader" class="hidden">
      <div id="userProfile">
        <span id="userName"></span>
        <div id="userAvatar"></div>
        <button id="logoutBtn" class="btn btn-secondary" style="margin-left: 1rem;">Logout</button>
      </div>
    </header>
    <aside id="appSidebar" class="hidden">
      <div class="sidebar-icon">üè†</div>
      <div class="sidebar-icon">üí°</div>
      <div class="sidebar-icon">üë•</div>
    </aside>

    <main id="appMain">
      <div class="container">
        <!-- Views will be rendered here -->
      </div>
    </main>
  </div>
  
  <div id="matrixTooltip"></div>
  <div id="participantModalsContainer"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const firebaseConfig = {
        apiKey: "AIzaSyAu1hawycY2uQgzWolaHeTfCdWtSWux7XA",
        authDomain: "card-sorting-tool-762a3.firebaseapp.com",
        databaseURL: "https://card-sorting-tool-762a3-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "card-sorting-tool-762a3",
        storageBucket: "card-sorting-tool-762a3.firebasestorage.app",
        messagingSenderId: "361630774945",
        appId: "1:361630774945:web:402edb363d388a61baa2e0",
        measurementId: "G-BGV3P2HQZP"
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.database();

      const appHeader = document.getElementById('appHeader');
      const appSidebar = document.getElementById('appSidebar');
      const appMainContainer = document.querySelector('#appMain .container');

      let lastResultsCache = null;
      let currentEditingStudyId = null;

      // --- HELPERS ---
      function sanitizeText(v) { return String(v ?? '').replace(/<[^>]*>/g, '').replace(/[\u0000-\u001F\u007F]/g, '').replace(/\s+/g, ' ').trimStart().slice(0, 500); }
      function finalSanitize(v) { return sanitizeText(v).trim(); }
      function makeShareLink(uid, studyId) { const base = new URL(location.href); base.search = ''; base.hash = ''; return `${base.toString()}?uid=${uid}&study=${studyId}`; }
      
      // --- TEMPLATES ---
      const getAuthViewHTML = () => `<div class="view" id="authView"><div style="max-width: 400px; margin: 4rem auto;"><div class="view-card"><h2 style="text-align: center; margin-bottom: 2rem;">Researcher Login</h2><form id="authForm" novalidate><label for="displayName">Full name (for new sign-ups)</label><input type="text" id="displayName" autocomplete="name"/><label for="email">Email</label><input type="email" id="email" autocomplete="username" required/><label for="password">Password</label><input type="password" id="password" autocomplete="current-password" required/><div><button id="loginBtn" type="submit" class="btn btn-primary" style="width: 100%;">Login</button><button id="signupBtn" type="button" class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem;">Sign Up</button></div></form></div></div></div>`;
      const getDashboardViewHTML = (userName) => `<div class="view" id="dashboardView"><div class="dashboard-header"><h2>Hello, ${userName}</h2><button id="createStudyBtn" class="btn btn-orange">Ôºã New study</button></div><div id="studiesList"></div></div>`;
      const getSetupViewHTML = () => `<div class="view" id="setupView"><div class="setup-header"><h2 id="setupStudyName">New Card Sorting Study</h2><div><button id="previewStudyBtn" class="btn btn-secondary">Preview</button><button id="launchStudyBtn" class="btn btn-orange">Launch</button></div></div><div class="view-card"><div class="tabs"><button class="tab-btn active" data-tab="general">General</button><button class="tab-btn" data-tab="cards">Cards</button></div><div id="tabGeneral" class="tab-pane active"><label for="studyName">Study name</label><input type="text" id="studyName" required/><label for="instructionsInput">Welcome Message / Instructions (optional)</label><textarea id="instructionsInput" rows="4"></textarea></div><div id="tabCards" class="tab-pane"><label><input type="checkbox" id="enableDescriptions"/> Add descriptions (tooltips) to cards</label><div id="simpleCardsWrap"><label for="cardsInput">Cards (one per line)</label><textarea id="cardsInput" rows="8"></textarea></div><div id="builderWrap" class="builder-wrap hidden"><div class="builder-head"><strong>Cards and descriptions</strong><button type="button" id="addCardRowBtn" class="btn btn-secondary">Add Card</button></div><div id="builderRows" class="builder-rows"></div></div></div></div></div>`;
      const getParticipantViewHTML = () => `<div class="view" id="participantView"><div class="simple-header"><h1 id="participantStudyName" style="font-size: 2rem;"></h1><p id="cardDescriptionInfo" class="muted hidden">Click the ‚ÑπÔ∏è icon on a card to see its description.</p></div><div class="workspace"><div class="toolbar"><button id="showInstructionsBtn" class="btn btn-secondary">Instructions</button><button id="fullscreenBtn" class="btn btn-secondary">Full Screen</button><button id="submitSortingBtn" class="btn btn-primary">Finish Sorting</button></div><aside id="availableCardsContainer"><h3>Unsorted Cards</h3><div id="availableCards" class="cards-list"></div></aside><div class="category-columns-wrap"><div class="category-column"></div> <div class="category-column"></div> <div class="category-column"></div></div></div></div>`;
      const getResultsViewHTML = () => `<div class="view" id="resultsView"><h2>Study Results: <span id="resultsStudyName"></span></h2><div class="tabs"><button class="tab-btn active" data-tab="participants">Participants</button><button class="tab-btn" data-tab="categories">Categories</button><button class="tab-btn" data-tab="matrix">Similarity Matrix</button></div><div id="tabParticipants" class="tab-pane active"><div id="participantsPieChartWrap"></div><div id="participantsDetails"></div></div><div id="tabCategories" class="tab-pane"><div id="categoriesSummary"></div><div><div class="chart" id="categoriesChart"></div><div class="xlabels" id="categoriesLabels"></div></div></div><div id="tabMatrix" class="tab-pane"><div id="matrixMeta"></div><div id="matrixTableWrap" class="matrix-table-wrap"></div></div></div>`;
      const getParticipantModalsHTML = () => `<div id="participantModal" class="modal-backdrop hidden"><div class="modal"><h3>Before you begin</h3><p>Please enter your details to proceed.</p><label for="pName">Full name</label><input id="pName" type="text" required/><label for="pId">ID number</label><input id="pId" type="text" required/><label for="pCourse">Course</label><input id="pCourse" type="text" required/><label for="pNationality">Nationality</label><input id="pNationality" type="text" required/><label for="pEthnicity">Ethnicity</label><input id="pEthnicity" type="text" required/><fieldset><legend>Is your family home outside of Suva/Nausori?</legend><div><label><input type="radio" name="pOutsideHome" value="Yes" required/> Yes</label><label><input type="radio" name="pOutsideHome" value="No" required/> No</label></div></fieldset><div class="actions"><button id="startSortingBtn" class="btn btn-primary">Continue</button></div></div></div><div id="instructionsModal" class="modal-backdrop hidden"><div class="modal"><h3>Instructions</h3><div><p><strong>Here's how it works:</strong></p><ol><li>Drag cards from the "Unsorted Cards" list.</li><li>Drop a card into an empty column to create a new category.</li><li>Name each category.</li><li>Continue sorting all cards.</li><li>When finished, click "Finish Sorting".</li></ol></div><div class="actions"><button id="beginSortingBtn" class="btn btn-primary">Begin</button></div></div></div>`;

      // --- VIEW MANAGEMENT ---
      function showView(viewName, ...args) {
          appMainContainer.innerHTML = '';
          let viewHTML = '';
          switch(viewName) {
              case 'auth': viewHTML = getAuthViewHTML(); break;
              case 'dashboard': viewHTML = getDashboardViewHTML(...args); break;
              case 'setup': viewHTML = getSetupViewHTML(); break;
              case 'participant': viewHTML = getParticipantViewHTML(); document.getElementById('participantModalsContainer').innerHTML = getParticipantModalsHTML(); break;
              case 'results': viewHTML = getResultsViewHTML(); break;
          }
          appMainContainer.innerHTML = viewHTML;
          const viewElement = appMainContainer.querySelector('.view');
          if (viewElement) viewElement.classList.add('active');
          return viewElement;
      }

      // --- AUTHENTICATION & APP SHELL ---
      auth.onAuthStateChanged(user => {
          const params = new URLSearchParams(location.search);
          const isParticipantLink = params.has('uid') && params.has('study');

          if (user) {
              appHeader.classList.remove('hidden'); appSidebar.classList.remove('hidden');
              document.getElementById('userName').textContent = user.displayName || user.email;
              document.getElementById('userAvatar').textContent = (user.displayName || user.email).charAt(0).toUpperCase();
              document.getElementById('logoutBtn').onclick = () => auth.signOut();
              showDashboard(user);
          } else if (isParticipantLink) {
              appHeader.classList.add('hidden'); appSidebar.classList.add('hidden');
              document.querySelector('.app-layout').style.display = 'block'; // Change layout for participant
              loadParticipantView(params.get('uid'), params.get('study'));
          } else {
              appHeader.classList.add('hidden'); appSidebar.classList.add('hidden');
              document.querySelector('.app-layout').style.display = 'block'; // Change layout for auth
              const view = showView('auth');
              view.querySelector('#loginBtn').onclick = async (e) => { e.preventDefault(); try { await auth.signInWithEmailAndPassword(view.querySelector('#email').value, view.querySelector('#password').value); } catch (err) { alert(err.message); } };
              view.querySelector('#signupBtn').onclick = async () => { try { const name = finalSanitize(view.querySelector('#displayName').value); if (!name) { alert('Please enter full name'); return; } const cred = await auth.createUserWithEmailAndPassword(view.querySelector('#email').value, view.querySelector('#password').value); await cred.user.updateProfile({ displayName: name }); } catch (err) { alert(err.message); } };
          }
      });

      // --- DASHBOARD ---
      function showDashboard(user) {
          const view = showView('dashboard', user.displayName);
          view.querySelector('#createStudyBtn').onclick = () => showSetupView(user.uid);
          db.ref(`users/${user.uid}/studies`).once('value', snap => {
              const studies = snap.val();
              const studiesList = view.querySelector('#studiesList');
              if (!studies) {
                  studiesList.innerHTML = `<div class="empty-dashboard"><h3>Organize content to perfection</h3><p>Create your first card sorting study to get started.</p></div>`;
                  return;
              }
              studiesList.innerHTML = Object.entries(studies).map(([studyId, study]) => `
                  <div class="study-card">
                      <div class="study-card-header">
                          <div class="study-card-title">
                              <span class="study-card-icon">üóÇÔ∏è</span><h3>${study.name || '(Untitled)'}</h3>
                          </div>
                          <div class="actions-menu">
                              <button class="btn btn-secondary">Setup ‚ñæ</button>
                              <div class="actions-menu-content" data-uid="${user.uid}" data-study-id="${studyId}" data-study-name="${study.name}">
                                  <button class="action-preview">Study preview</button>
                                  <button class="action-copy-link">Copy study address</button>
                                  <button class="action-clone">Clone study</button>
                                  <button class="action-delete" style="color: var(--accent);">Delete study</button>
                              </div>
                          </div>
                      </div>
                      <div class="study-card-body">
                          <button class="btn btn-primary action-results" data-uid="${user.uid}" data-study-id="${studyId}">View Results</button>
                      </div>
                  </div>`).join('');
          });
      }
      appMainContainer.addEventListener('click', e => {
          const target = e.target;
          const menu = target.closest('.actions-menu-content');
          const resultsBtn = target.closest('.action-results');

          if (menu) {
              const { uid, studyId, studyName } = menu.dataset;
              if (target.classList.contains('action-preview')) window.open(makeShareLink(uid, studyId), '_blank');
              if (target.classList.contains('action-copy-link')) { navigator.clipboard.writeText(makeShareLink(uid, studyId)); alert('Link copied!'); }
              if (target.classList.contains('action-clone')) cloneStudy(uid, studyId);
              if (target.classList.contains('action-delete')) deleteStudy(uid, studyId, studyName);
          }
          if (resultsBtn) {
              const { uid, studyId } = resultsBtn.dataset;
              viewResults(uid, studyId);
          }
      });

      async function cloneStudy(uid, studyId) { /* ... implementation unchanged ... */ }
      async function deleteStudy(uid, studyId, studyName) { /* ... implementation unchanged ... */ }

      // --- SETUP VIEW ---
      function showSetupView(uid, studyId = null) {
          currentEditingStudyId = studyId;
          const view = showView('setup');
          // Event binding logic...
          const studyNameInput = view.querySelector('#studyName');
          studyNameInput.oninput = () => { view.querySelector('#setupStudyName').textContent = studyNameInput.value || 'New Card Sorting Study'; };
          view.querySelector('#previewStudyBtn').onclick = () => currentEditingStudyId ? window.open(makeShareLink(uid, currentEditingStudyId), '_blank') : alert("Please launch first.");
          view.querySelector('#launchStudyBtn').onclick = () => saveStudy(uid);
          view.querySelectorAll('.tab-btn').forEach(tab => tab.onclick = () => { view.querySelectorAll('.tab-btn, .tab-pane').forEach(el => el.classList.remove('active')); tab.classList.add('active'); view.querySelector(`#tab${tab.dataset.tab.charAt(0).toUpperCase() + tab.dataset.tab.slice(1)}`).classList.add('active'); });
          const enableDescriptions = view.querySelector('#enableDescriptions'), builderWrap = view.querySelector('#builderWrap'), simpleCardsWrap = view.querySelector('#simpleCardsWrap'), builderRows = view.querySelector('#builderRows');
          const addCardRow = (n='', d='') => { const r = document.createElement('div'); r.className='builder-row'; r.innerHTML = `<input value="${n}"/><input value="${d}"/><button type="button" class="btn-secondary">√ó</button>`; r.querySelector('button').onclick=()=>r.remove(); builderRows.appendChild(r); };
          view.querySelector('#addCardRowBtn').onclick = () => addCardRow();
          enableDescriptions.onchange = () => { builderWrap.classList.toggle('hidden', !enableDescriptions.checked); simpleCardsWrap.classList.toggle('hidden', enableDescriptions.checked); };
      }
      async function saveStudy(uid) { /* ... implementation unchanged ... */ }

      // --- PARTICIPANT VIEW ---
      function loadParticipantView(uid, studyId) {
          const view = showView('participant');
          db.ref(`users/${uid}/studies/${studyId}`).once('value', snap => {
              const study = snap.val();
              if (!study || !study.isPublic) { appMainContainer.innerHTML = '<h2>Study not available</h2>'; return; }
              
              const pName = document.getElementById('pName'), pId = document.getElementById('pId'), pCourse = document.getElementById('pCourse'), pNationality = document.getElementById('pNationality'), pEthnicity = document.getElementById('pEthnicity');
              const participantModal = document.getElementById('participantModal'), instructionsModal = document.getElementById('instructionsModal');

              document.getElementById('participantStudyName').textContent = study.name;
              if (study.hasDescriptions) document.getElementById('cardDescriptionInfo').classList.remove('hidden');

              const availableCards = document.getElementById('availableCards');
              (study.cards || []).forEach(c => {
                  const text = typeof c === 'string' ? c : finalSanitize(c?.text || '');
                  const desc = typeof c === 'string' ? '' : finalSanitize(c?.desc || '');
                  if(text) {
                      const cardEl = document.createElement('div'); cardEl.className = 'card'; cardEl.dataset.cardText = text; cardEl.innerHTML = `<div class="card-text">${text}</div>`;
                      if(desc) cardEl.innerHTML += `<button class="info-icon">‚ÑπÔ∏è</button>`;
                      availableCards.appendChild(cardEl);
                  }
              });
              
              new Sortable(availableCards, { group: 'cards', animation: 150 });
              document.querySelectorAll('.category-column').forEach(col => new Sortable(col, { group: 'cards', animation: 150, onAdd: (e) => { if(e.item.classList.contains('card')) { const newCat=makeCategory(col); newCat.querySelector('.cat-body').appendChild(e.item); } }}));
              
              participantModal.classList.remove('hidden');

              document.getElementById('startSortingBtn').onclick = () => {
                  const meta = { name: finalSanitize(pName.value), idNumber: finalSanitize(pId.value), course: finalSanitize(pCourse.value), nationality: finalSanitize(pNationality.value), ethnicity: finalSanitize(pEthnicity.value), outsideHome: finalSanitize((document.querySelector('input[name="pOutsideHome"]:checked') || {}).value || '') };
                  if (Object.values(meta).some(v => !v)) { alert('Please complete all fields.'); return; }
                  participantMeta = meta; participantModal.classList.add('hidden'); instructionsModal.classList.remove('hidden');
              };
              document.getElementById('beginSortingBtn').onclick = async () => { /* ... */ };
              document.getElementById('submitSortingBtn').onclick = () => { /* ... */ };
          });
      }
      function makeCategory(targetColumn) { /* ... implementation unchanged ... */ return cat; }

      // --- RESULTS VIEW ---
      function viewResults(uid, studyId) {
          db.ref(`users/${uid}/studies/${studyId}`).once('value').then(snap => {
              const study = snap.val();
              if (!study) { alert("Study not found."); return; }
              const view = showView('results');
              view.querySelector('#resultsStudyName').textContent = study.name;
              db.ref(`users/${uid}/studies/${studyId}/results`).once('value').then(snap2 => {
                  buildResultsUI(study, snap2.val() || {});
              });
          });
      }
      function buildResultsUI(study, resultsObj) { /* ... implementation unchanged, now without clustering ... */ }

      // Matrix Tooltip Logic
      appMainContainer.addEventListener('mousemove', e => {
          const cell = e.target.closest('td[data-card-i]');
          const tooltip = document.getElementById('matrixTooltip');
          if (!tooltip) return;
          if (cell) {
              tooltip.style.display = 'block';
              tooltip.style.left = `${e.pageX + 15}px`;
              tooltip.style.top = `${e.pageY + 15}px`;
              tooltip.innerHTML = `<div>${cell.dataset.cardI} & ${cell.dataset.cardJ}</div><strong>${cell.dataset.pct}%</strong>`;
          } else {
              tooltip.style.display = 'none';
          }
      });
    });
  </script>
</body>
</html>
