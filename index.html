<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Open Card Sorting Tool - Researcher Accounts</title>
  <style>
    :root {
      --primary:#4a6fa5;
      --secondary:#6b8cae;
      --accent:#ff6b6b;
      --light:#f8f9fa;
      --dark:#343a40;
      --success:#28a745;
      --border:#dee2e6;
    }

    * { box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI', system-ui, -apple-system, Roboto, Arial, sans-serif }

    body { background:#f5f7fa; color:var(--dark); line-height:1.5 }

    .container { max-width:1200px; margin:0 auto; padding:20px }

    header { background:var(--primary); color:white; padding:1rem; text-align:center; margin-bottom:2rem; border-radius:5px }

    .view { display:none; background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1); margin-bottom:2rem }
    .active { display:block }

    .btn { padding:.5rem 1rem; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer; margin:.25rem; touch-action:manipulation }
    .btn:hover { background:var(--secondary) }
    .btn:disabled { opacity:.6; cursor:not-allowed }
    .btn-success { background:var(--success) }
    .btn-accent { background:var(--accent); color:#fff }
    .btn-accent:hover { filter:brightness(0.95) }

    .hidden { display:none !important }

    label { display:block; margin:.25rem 0 .25rem; font-weight:600 }
    input, textarea {
      width:100%; padding:.5rem; margin-bottom:1rem; border:1px solid var(--border); border-radius:4px;
    }

    .study-item {
      border:1px solid var(--border); padding:.75rem; margin-bottom:.5rem;
      display:flex; justify-content:space-between; align-items:center; gap:.5rem; flex-wrap:wrap;
    }
    .study-actions { display:flex; gap:.25rem; flex-wrap:wrap }

    .instructions { background:#e9ecef; padding:1rem; margin-bottom:1rem; border-radius:4px }

    .category-card { background:#eee; padding:.25rem .5rem; border-radius:4px; margin:.25rem; display:inline-block }

    .table-wrap { overflow:auto; margin-top:1rem; border:1px solid var(--border); border-radius:6px }
    table { border-collapse:collapse; min-width:600px; width:100% }
    th, td { border:1px solid var(--border); padding:.5rem; text-align:center; white-space:nowrap }

    .card { background:white; border:1px solid var(--border); padding:1rem; margin:.25rem; border-radius:6px; cursor:grab; user-select:none; box-shadow:0 1px 0 rgba(0,0,0,0.05) }
    .card:active { cursor:grabbing }

    .muted { color:#6c757d }
    .badge { display:inline-block; padding:.1rem .4rem; border-radius:.25rem; font-size:.8rem; background:#edf2ff; color:#2f4e8b; border:1px solid #dbe4ff }

    /* Participant workspace layout (cards left, canvas right) */
    .workspace { display:grid; grid-template-columns: 340px 1fr; gap:18px; align-items:start; }
    .left-panel {
      background:#d1d1cf; border:1px solid #c5c5c3; border-radius:10px; padding:12px;
      position:sticky; top:12px; max-height:calc(100vh - 180px); overflow:auto;
    }
    .left-panel h3 { margin:.25rem 0 .5rem; }
    .cards-list { display:flex; flex-direction:column; gap:.5rem; }

    .right-panel { min-height:60vh; position:relative; }
    .toolbar { margin-bottom:.5rem; display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; justify-content:flex-end }

    /* Steps shown until a category exists */
    .steps { display:flex; flex-direction:column; gap:18px; margin-bottom:18px; }
    .stepbox {
      border:2px dashed #ddd; border-radius:14px; padding:18px; background:#fff;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    .stepbox h3 { font-size:1.35rem; margin-bottom:.5rem }
    .stepbox ol { margin-left:1.25rem }
    .stepbox li { margin:.25rem 0 }

    /* Dropzone to create a new category */
    .new-cat-dropzone {
      border:2px dashed #cfcfcf; border-radius:10px; min-height:110px; padding:14px; background:#fafafa; margin-top:.5rem;
      display:flex; align-items:center; justify-content:center; color:#666; font-weight:600;
    }
    .new-cat-tile {
      border:2px dashed #cfcfcf; border-radius:10px; min-height:90px; display:flex; align-items:center; justify-content:center;
      background:#fafafa; color:#666; font-weight:600;
    }

    /* Categories canvas */
    .categories-wrap {
      display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap:16px;
    }

    /* Category card with dark header */
    .category {
      background:#fff; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,.06); border:1px solid var(--border); overflow:hidden;
    }
    .cat-header {
      background:#3d4038; color:#fff; padding:.5rem .75rem; font-weight:600; text-align:center; position:relative;
    }
    .cat-title { cursor:text }
    .cat-delete, .cat-toggle {
      position:absolute; top:6px; color:#fff; cursor:pointer; opacity:.9; user-select:none
    }
    .cat-delete { left:8px }
    .cat-toggle { right:8px }
    .cat-body {
      padding:.5rem; background:#fff; margin:.5rem; border:1px solid var(--border); border-radius:8px; min-height:80px;
    }
    .cat-footer { text-align:center; font-size:.75rem; color:#6b6b6b; padding:.25rem .5rem .6rem; text-transform:uppercase; letter-spacing:.02em }

    /* Modal (participant info + instructions) */
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:flex; align-items:center; justify-content:center;
      z-index:9999; padding:1rem;
    }
    .modal {
      background:#fff; border-radius:10px; width:min(640px, 100%); padding:1.25rem 1.25rem 1rem;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .modal h3 { margin-bottom:.5rem }
    .modal p { margin:.25rem 0 1rem }
    .modal .actions { display:flex; justify-content:flex-end; gap:.5rem; margin-top:.25rem }
    fieldset { border:1px solid var(--border); border-radius:6px; padding:.75rem; margin-bottom:1rem }
    legend { padding:0 .25rem; font-weight:600 }
    .radio-row { display:flex; gap:1rem; margin-top:.5rem }
    .radio-row label { font-weight:500; margin:0; display:flex; align-items:center; gap:.35rem }
    .modal ol { margin-left:1.25rem; }
    .modal ol li { margin: .25rem 0; }
    .modal strong { font-weight:700; }

    /* Tabs (results) */
    .tabs { display:flex; gap:.5rem; margin: .5rem 0 1rem; border-bottom:1px solid var(--border) }
    .tab-btn { background:transparent; color:var(--dark); border:none; padding:.5rem .75rem; cursor:pointer; border-bottom:3px solid transparent }
    .tab-btn.active { border-bottom-color:var(--primary); color:var(--primary); font-weight:600 }
    .tab-pane { display:none }
    .tab-pane.active { display:block }

    /* Simple bar chart */
    .chart-wrap { margin-top:.5rem }
    .chart { display:flex; align-items:flex-end; gap:8px; height:220px; padding:8px; border-left:1px solid var(--border); border-bottom:1px solid var(--border) }
    .bar { background:linear-gradient(180deg, var(--secondary), var(--primary)); flex:1; min-width:24px; border-radius:4px 4px 0 0; position:relative }
    .bar span { position:absolute; bottom:100%; transform:translateY(-4px); font-size:.8rem; color:var(--dark) }
    .xlabels { display:flex; gap:8px; margin-top:4px }
    .xlabel { flex:1; min-width:24px; text-align:center; font-size:.8rem; color:var(--dark) }
  </style>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <header><h1>Open Card Sorting Tool</h1></header>

    <!-- Login / Signup (no researcher button on participant view) -->
    <div id="authView" class="view active">
      <h2 id="authHeading">Researcher Login</h2>
      <form id="authForm" novalidate>
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="name@example.com" autocomplete="username" inputmode="email" required>

        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Password" autocomplete="current-password" required>

        <div>
          <button id="loginBtn" type="submit" class="btn">Login</button>
          <button id="signupBtn" type="button" class="btn btn-accent">Sign Up</button>
        </div>
      </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboardView" class="view">
      <h2>Dashboard</h2>
      <div>
        <button id="createStudyBtn" class="btn">Create New Study</button>
        <button id="migrateBtn" class="btn btn-accent">Migrate My Old Studies</button>
        <button id="logoutBtn" class="btn btn-accent">Logout</button>
      </div>
      <h3>Your Studies</h3>
      <div id="studiesList" aria-live="polite"></div>
    </div>

    <!-- Create Study -->
    <div id="setupView" class="view">
      <h2>Create a New Study</h2>
      <label for="studyName">Study name</label>
      <input type="text" id="studyName" placeholder="e.g., Information Architecture Test" required>

      <label for="cardsInput">Cards (one per line)</label>
      <textarea id="cardsInput" rows="8" placeholder="Card 1&#10;Card 2&#10;Card 3" required></textarea>

      <label for="instructionsInput">Instructions (optional)</label>
      <textarea id="instructionsInput" rows="4" placeholder="Describe what participants should do..."></textarea>

      <div>
        <button id="saveStudyBtn" class="btn btn-success">Save Study</button>
        <button id="cancelCreateBtn" class="btn">Cancel</button>
      </div>
    </div>

    <!-- Share Link -->
    <div id="studyCreatedView" class="view">
      <h2>Study Created!</h2>
      <label for="studyLink">Share this link with participants</label>
      <input type="text" id="studyLink" readonly>
      <div>
        <button id="copyLinkBtn" class="btn">Copy Link</button>
        <button id="backToDashboardBtn" class="btn">Back to Dashboard</button>
      </div>
    </div>

    <!-- Participant -->
    <div id="participantView" class="view">
      <h2 id="participantStudyName"></h2>
      <div id="participantInstructions" class="instructions hidden" aria-live="polite"></div>
      <div id="participantStatus" class="muted"></div>

      <div class="workspace">
        <aside class="left-panel">
          <h3>Cards</h3>
          <div class="muted" style="margin-bottom:.5rem;">Drag a card to the right to create or fill categories.</div>
          <div id="availableCards" class="cards-list"></div>
        </aside>

        <section class="right-panel">
          <div id="stepsWrap" class="steps">
            <div class="stepbox">
              <h3>Step 1</h3>
              <ol>
                <li>Take note of the list of cards on the left.</li>
                <li>Please, split these cards into categories that feel ‚Äúright‚Äù to you.</li>
                <li><strong>There‚Äôs no actual right or wrong way</strong> to do it. Simply sort them by intuition.</li>
              </ol>
            </div>
            <div class="stepbox">
              <h3>Step 2</h3>
              <p>Drag a card from the left and drop it here. This will create a new category.</p>
              <div id="newCategoryDropzone" class="new-cat-dropzone">Drop here to create a new category</div>
            </div>
          </div>

          <div class="toolbar">
            <button id="submitSortingBtn" class="btn btn-success">Finish</button>
          </div>

          <div id="sortingArea" class="categories-wrap"></div>
          <div id="newCategoryTile" class="new-cat-tile hidden">Drop here to create a new category</div>
        </section>
      </div>
    </div>

    <!-- Participant Info Modal -->
    <div id="participantModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="participantModalTitle">
      <div class="modal">
        <h3 id="participantModalTitle">Before you begin</h3>
        <p>Please enter your details to proceed.</p>

        <label for="pName">Full name</label>
        <input id="pName" type="text" placeholder="Your name" required>

        <label for="pId">ID number</label>
        <input id="pId" type="text" placeholder="Your ID number" required>

        <label for="pAddress">Address</label>
        <textarea id="pAddress" rows="3" placeholder="Your address" required></textarea>

        <label for="pCourse">Course</label>
        <input id="pCourse" type="text" placeholder="Your course" required>

        <label for="pNationality">Nationality</label>
        <input id="pNationality" type="text" placeholder="Your nationality" required>

        <label for="pEthnicity">Ethnicity</label>
        <input id="pEthnicity" type="text" placeholder="Your ethnicity" required>

        <fieldset>
          <legend>Is your family home outside of Suva/Nausori? (Yes/No)</legend>
          <div class="radio-row">
            <label><input type="radio" name="pOutsideHome" value="Yes" required> Yes</label>
            <label><input type="radio" name="pOutsideHome" value="No" required> No</label>
          </div>
        </fieldset>

        <div class="actions">
          <button id="startSortingBtn" class="btn btn-success">Continue</button>
        </div>
      </div>
    </div>

    <!-- Instructions Modal (after details) -->
    <div id="instructionsModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="instructionsModalTitle">
      <div class="modal">
        <h3 id="instructionsModalTitle">Instructions</h3>
        <p><strong>Here's how it works:</strong></p>
        <ol>
          <li>You will be presented with a list of cards.</li>
          <li>Drag and drop the cards into the categories that you think they fit the most.</li>
          <li>If you change your opinion, feel free to move the cards between the different categories until you're satisfied.</li>
          <li>Once done, click <strong>Finish</strong> to complete the card sort.</li>
        </ol>
        <div class="actions">
          <button id="beginSortingBtn" class="btn btn-success">Begin</button>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsView" class="view">
      <h2>Study Results: <span id="resultsStudyName"></span></h2>

      <div class="tabs">
        <button class="tab-btn active" data-tab="participants">Participants</button>
        <button class="tab-btn" data-tab="categories">Categories</button>
        <button class="tab-btn" data-tab="matrix">Similarity Matrix</button>
      </div>

      <!-- Share results controls (researcher only) -->
      <div id="shareSection" class="instructions hidden">
        <strong>Share results</strong>
        <div style="margin-top:.5rem">
          <label style="display:inline-flex; align-items:center; gap:.5rem">
            <input type="checkbox" id="toggleResultsPublic"> Enable public results link
          </label>
        </div>
        <div id="publicResultsLinkRow" class="hidden" style="display:flex; gap:.5rem; margin-top:.5rem; align-items:center;">
          <input type="text" id="publicResultsLink" readonly style="flex:1">
          <button id="copyPublicResultsBtn" class="btn">Copy Public Link</button>
        </div>
        <div class="muted" style="margin-top:.25rem">Anyone with the link can view the results without logging in.</div>
      </div>

      <!-- Participants Tab -->
      <div id="tabParticipants" class="tab-pane active">
        <div id="participantsSummary"></div>
        <div id="participantsDetails"></div>
      </div>

      <!-- Categories Tab -->
      <div id="tabCategories" class="tab-pane">
        <div id="categoriesSummary"></div>
        <div class="chart-wrap">
          <div class="chart" id="categoriesChart"></div>
          <div class="xlabels" id="categoriesLabels"></div>
        </div>
      </div>

      <!-- Matrix Tab -->
      <div id="tabMatrix" class="tab-pane">
        <div id="matrixMeta"></div>
        <div id="matrixTableWrap" class="table-wrap"></div>
      </div>

      <div style="margin-top: 1rem">
        <button id="downloadCsvBtn" class="btn">Download CSV</button>
        <button id="backToDashboardFromResultsBtn" class="btn">Back to Dashboard</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAu1hawycY2uQgzWolaHeTfCdWtSWux7XA",
    authDomain: "card-sorting-tool-762a3.firebaseapp.com",
    databaseURL: "https://card-sorting-tool-762a3-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "card-sorting-tool-762a3",
    storageBucket: "card-sorting-tool-762a3.firebasestorage.app",
    messagingSenderId: "361630774945",
    appId: "1:361630774945:web:402edb363d388a61baa2e0",
    measurementId: "G-BGV3P2HQZP"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // DOM refs
  const authView = document.getElementById('authView');
  const dashboardView = document.getElementById('dashboardView');
  const setupView = document.getElementById('setupView');
  const studyCreatedView = document.getElementById('studyCreatedView');
  const participantView = document.getElementById('participantView');
  const resultsView = document.getElementById('resultsView');

  const studyNameInput = document.getElementById('studyName');
  const cardsInput = document.getElementById('cardsInput');
  const instructionsInput = document.getElementById('instructionsInput');
  const studyLinkInput = document.getElementById('studyLink');

  const studiesList = document.getElementById('studiesList');
  const availableCardsContainer = document.getElementById('availableCards');
  const sortingArea = document.getElementById('sortingArea');
  const participantStudyName = document.getElementById('participantStudyName');
  const participantInstructions = document.getElementById('participantInstructions');
  const participantStatus = document.getElementById('participantStatus');
  const stepsWrap = document.getElementById('stepsWrap');
  const newCategoryDropzone = document.getElementById('newCategoryDropzone');
  const newCategoryTile = document.getElementById('newCategoryTile');

  const resultsStudyName = document.getElementById('resultsStudyName');

  // Results tab refs
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabParticipants = document.getElementById('tabParticipants');
  const tabCategories = document.getElementById('tabCategories');
  const tabMatrix = document.getElementById('tabMatrix');

  const participantsSummary = document.getElementById('participantsSummary');
  const participantsDetails = document.getElementById('participantsDetails');

  const categoriesSummary = document.getElementById('categoriesSummary');
  const categoriesChart = document.getElementById('categoriesChart');
  const categoriesLabels = document.getElementById('categoriesLabels');

  const matrixMeta = document.getElementById('matrixMeta');
  const matrixTableWrap = document.getElementById('matrixTableWrap');

  const authForm = document.getElementById('authForm');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');

  // Participant modals
  const participantModal = document.getElementById('participantModal');
  const instructionsModal = document.getElementById('instructionsModal');
  const pName = document.getElementById('pName');
  const pId = document.getElementById('pId');
  const pAddress = document.getElementById('pAddress');
  const pCourse = document.getElementById('pCourse');
  const pNationality = document.getElementById('pNationality');
  const pEthnicity = document.getElementById('pEthnicity');
  const startSortingBtn = document.getElementById('startSortingBtn');
  const beginSortingBtn = document.getElementById('beginSortingBtn');

  // Results export + sharing
  const downloadCsvBtn = document.getElementById('downloadCsvBtn');
  const shareSection = document.getElementById('shareSection');
  const toggleResultsPublic = document.getElementById('toggleResultsPublic');
  const publicResultsLinkRow = document.getElementById('publicResultsLinkRow');
  const publicResultsLink = document.getElementById('publicResultsLink');
  const copyPublicResultsBtn = document.getElementById('copyPublicResultsBtn');

  // Participant/public link handling
  const params = new URLSearchParams(location.search);
  const pUid = params.get('uid');
  const pStudyId = params.get('study');
  const viewMode = params.get('view');
  const hasParticipantLink = Boolean(pUid && pStudyId && !viewMode);
  const isPublicResultsLink = Boolean(pUid && pStudyId && viewMode === 'results');

  // In-memory caches
  let participantMeta = null;
  let lastResultsCache = null;

  // Helpers
  function show(view) {
    [authView, dashboardView, setupView, studyCreatedView, participantView, resultsView].forEach(v => v.classList.remove('active'));
    view.classList.add('active');
  }
  function activateTab(name) {
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.tab === name));
    tabParticipants.classList.toggle('active', name === 'participants');
    tabCategories.classList.toggle('active', name === 'categories');
    tabMatrix.classList.toggle('active', name === 'matrix');
  }
  function makeShareLink(uid, studyId) {
    const base = new URL(window.location.href);
    base.search = ''; base.hash = '';
    return `${base.toString()}?uid=${uid}&study=${studyId}`;
  }
  function makePublicResultsLink(uid, studyId) {
    const base = new URL(window.location.href);
    base.search = ''; base.hash = '';
    return `${base.toString()}?uid=${uid}&study=${studyId}&view=results`;
  }
  function formatDuration(ms) {
    if (typeof ms !== 'number' || !isFinite(ms) || ms < 0) return '';
    let s = Math.floor(ms / 1000);
    const h = Math.floor(s / 3600);
    s %= 3600;
    const m = Math.floor(s / 60);
    s %= 60;
    if (h) return `${h}h ${m}m ${s}s`;
    return `${m}m ${s}s`;
  }

  // CSV helpers
  function csvEscape(v) { const s = (v == null ? '' : String(v)); return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s; }
  function downloadCSV(filename, text) {
    const blob = new Blob(["\ufeff" + text], { type: "text/csv;charset=utf-8;" });
    if (navigator.msSaveBlob) { navigator.msSaveBlob(blob, filename); }
    else { const link = document.createElement('a'); const url = URL.createObjectURL(blob);
      link.href = url; link.download = filename; link.style.visibility = 'hidden';
      document.body.appendChild(link); link.click(); document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 0);
    }
  }

  // Auth actions
  async function doLogin(){ try{ await auth.signInWithEmailAndPassword(emailInput.value.trim(), passwordInput.value); }catch(e){ alert(e.message); } }
  async function doSignup(){ try{ await auth.createUserWithEmailAndPassword(emailInput.value.trim(), passwordInput.value); }catch(e){ alert(e.message); } }
  authForm.addEventListener('submit', e => { e.preventDefault(); doLogin(); });
  document.getElementById('loginBtn').onclick = doLogin;
  document.getElementById('signupBtn').onclick = doSignup;
  document.getElementById('logoutBtn').onclick = () => auth.signOut();

  // Create study flow
  document.getElementById('createStudyBtn').onclick = () => { show(setupView); setTimeout(()=>studyNameInput.focus(),0); };
  document.getElementById('cancelCreateBtn').onclick = () => { show(dashboardView); document.getElementById('createStudyBtn').focus(); };
  document.getElementById('saveStudyBtn').onclick = () => {
    const user = auth.currentUser; if(!user){ alert('You must be logged in to save a study.'); return; }
    const name = studyNameInput.value.trim();
    const cards = cardsInput.value.split('\n').map(l=>l.trim()).filter(Boolean);
    if(!name || cards.length===0){ alert('Enter name and at least one card'); return; }
    const studyId = 'study_'+Date.now();
    const study = { id:studyId, name, cards, instructions:instructionsInput.value.trim(), createdAt:new Date().toISOString(), ownerUid:user.uid, isPublic:true };
    db.ref(`users/${user.uid}/studies/${studyId}`).set(study).then(()=>{
      studyLinkInput.value = makeShareLink(user.uid,studyId);
      show(studyCreatedView);
      document.getElementById('copyLinkBtn').focus();
    }).catch(err=>alert(err.message));
  };
  document.getElementById('backToDashboardBtn').onclick = () => show(dashboardView);
  document.getElementById('copyLinkBtn').onclick = async () => {
    try{ await navigator.clipboard.writeText(studyLinkInput.value); alert('Link copied!'); }
    catch{ studyLinkInput.select(); document.execCommand('copy'); alert('Link copied!'); }
  };
  document.getElementById('backToDashboardFromResultsBtn').onclick = () => show(dashboardView);

  // Migration (optional helper)
  async function migrateOldStudiesToUser(uid){
    try{
      const snap = await db.ref('studies').orderByChild('ownerUid').equalTo(uid).once('value');
      const oldStudies = snap.val() || {}; const ids = Object.keys(oldStudies);
      if(!ids.length){ alert('No old studies found under /studies for this account.'); return; }
      const updates = {}; ids.forEach(studyId=>{ updates[`users/${uid}/studies/${studyId}`]=oldStudies[studyId]; });
      await db.ref().update(updates); alert('Migration completed! Reload the dashboard to see your studies.');
    }catch(err){ console.error('Migration error:',err); alert('Migration failed: '+err.message); }
  }
  document.getElementById('migrateBtn').onclick = () => { const user=auth.currentUser; if(!user){ alert('You must be logged in as a researcher to migrate.'); return; } migrateOldStudiesToUser(user.uid); };

  // Auth state change (do not override public/participant routes)
  auth.onAuthStateChanged(user=>{
    if(hasParticipantLink){ show(participantView); return; }
    if(isPublicResultsLink){ show(resultsView); loadPublicResults(pUid,pStudyId); return; }
    if(user){ show(dashboardView); showDashboard(user.uid); document.getElementById('createStudyBtn').focus(); }
    else{ show(authView); document.getElementById('email').focus(); }
  });

  // Dashboard listing
  function showDashboard(uid){
    studiesList.textContent=''; const seen=new Set();
    db.ref(`users/${uid}/studies`).once('value').then(snap=>{
      const data=snap.val()||{}; Object.entries(data).forEach(([studyId,study])=>{ if(seen.has(studyId))return; addStudyToDashboard(uid,studyId,study); seen.add(studyId); });
    });
    db.ref('studies').orderByChild('ownerUid').equalTo(uid).once('value').then(snap=>{
      const data=snap.val()||{}; Object.entries(data).forEach(([studyId,study])=>{ if(seen.has(studyId))return; addStudyToDashboard(uid,studyId,study); seen.add(studyId); });
    });
  }
  async function deleteStudy(uid, studyId, studyName, rowEl){
    const confirmed = confirm(`Delete the study "${studyName||studyId}" and all of its results? This cannot be undone.`); if(!confirmed) return;
    const buttons = rowEl ? rowEl.querySelectorAll('button') : []; buttons.forEach(b=>b.disabled=true);
    try{
      const updates = {}; updates[`users/${uid}/studies/${studyId}`]=null;
      const oldSnap = await db.ref(`studies/${studyId}`).once('value');
      if(oldSnap.exists()){ const oldData=oldSnap.val(); if(!oldData.ownerUid || oldData.ownerUid===uid) updates[`studies/${studyId}`]=null; }
      await db.ref().update(updates);
      if(rowEl && rowEl.parentNode) rowEl.parentNode.removeChild(rowEl);
      if(lastResultsCache && lastResultsCache.uid===uid && lastResultsCache.studyId===studyId){ lastResultsCache=null; show(dashboardView); }
      alert('Study deleted.');
    }catch(e){ console.error('Delete failed:',e); alert('Delete failed: '+e.message); buttons.forEach(b=>b.disabled=false); }
  }
  function addStudyToDashboard(uid, studyId, study){
    const div=document.createElement('div'); div.className='study-item';
    const left=document.createElement('div');
    const title=document.createElement('div'); title.textContent=study.name||'(Untitled study)';
    const pub=document.createElement('div'); pub.className='muted'; pub.innerHTML=`<span class="badge">${study.isPublic?'Published':'Unpublished'}</span>`;
    left.appendChild(title); left.appendChild(pub);
    const actions=document.createElement('div'); actions.className='study-actions';
    const shareBtn=document.createElement('button'); shareBtn.className='btn'; shareBtn.textContent='Share Link';
    shareBtn.onclick=async()=>{ const link=makeShareLink(uid,studyId); try{ await navigator.clipboard.writeText(link); alert('Link copied to clipboard.'); }catch{ prompt('Copy this link:',link); } };
    const publishBtn=document.createElement('button'); publishBtn.className='btn'; publishBtn.textContent=study.isPublic?'Unpublish':'Publish';
    publishBtn.onclick=async()=>{ const newVal=!Boolean(study.isPublic); await db.ref(`users/${uid}/studies/${studyId}/isPublic`).set(newVal); study.isPublic=newVal; publishBtn.textContent=newVal?'Unpublish':'Publish'; pub.innerHTML=`<span class="badge">${newVal?'Published':'Unpublished'}</span>`; };
    const resultsBtn=document.createElement('button'); resultsBtn.className='btn btn-success'; resultsBtn.textContent='Results'; resultsBtn.onclick=()=>viewResults(uid,studyId);
    const deleteBtn=document.createElement('button'); deleteBtn.className='btn btn-accent'; deleteBtn.textContent='Delete'; deleteBtn.onclick=()=>deleteStudy(uid,studyId,study.name,div);
    actions.appendChild(shareBtn); actions.appendChild(publishBtn); actions.appendChild(resultsBtn); actions.appendChild(deleteBtn);
    div.appendChild(left); div.appendChild(actions); studiesList.appendChild(div);
  }

  // Participant layout
  if(hasParticipantLink){
    show(participantView);
    participantStudyName.textContent='Loading study...';
    participantStatus.textContent='Please wait while we prepare your card sort.';
    loadParticipantView(pUid,pStudyId);
  }

  function updateStepsVisibility(){
    const hasAny = sortingArea.querySelectorAll('.category').length > 0;
    stepsWrap.classList.toggle('hidden', hasAny);
    newCategoryTile.classList.toggle('hidden', !hasAny);
  }
  function updateCategoryCount(cat){
    const count = cat.querySelectorAll('.cat-body .card').length;
    cat.querySelector('.cat-footer').textContent = (count===1 ? '1 CARD' : `${count} CARDS`);
    updateStepsVisibility();
  }
  function renameCategory(cat){
    const titleEl = cat.querySelector('.cat-title');
    const current = titleEl.textContent.trim();
    const next = prompt('Enter category name', current || 'New category');
    if(next!==null) titleEl.textContent = next.trim() || 'Unnamed';
  }
  function deleteCategory(cat){
    const cards = [...cat.querySelectorAll('.cat-body .card')];
    cards.forEach(c => availableCardsContainer.appendChild(c));
    cat.remove();
    updateStepsVisibility();
  }
  function toggleCollapse(cat){
    const body = cat.querySelector('.cat-body'); const icon = cat.querySelector('.cat-toggle');
    const isHidden = body.classList.toggle('hidden');
    icon.textContent = isHidden ? '‚ñæ' : '‚ñ¥';
  }

  function makeCategory(name='Click to rename'){
    const cat = document.createElement('div'); cat.className='category';
    cat.innerHTML = `
      <div class="cat-header">
        <span class="cat-delete" title="Delete">üóë</span>
        <span class="cat-title">${name}</span>
        <span class="cat-toggle" title="Collapse">‚ñ¥</span>
      </div>
      <div class="cat-body"></div>
      <div class="cat-footer">0 CARDS</div>
    `;
    sortingArea.appendChild(cat);

    cat.querySelector('.cat-delete').onclick = () => deleteCategory(cat);
    cat.querySelector('.cat-toggle').onclick = () => toggleCollapse(cat);
    cat.querySelector('.cat-header').onclick = (e) => {
      if (e.target.closest('.cat-delete') || e.target.closest('.cat-toggle')) return;
      renameCategory(cat);
    };

    new Sortable(cat.querySelector('.cat-body'), {
      group:'cards', animation:150,
      onAdd: () => updateCategoryCount(cat),
      onRemove: () => updateCategoryCount(cat)
    });

    updateStepsVisibility();
    return cat;
  }

  // Begin flow: details -> instructions -> mark started
  startSortingBtn.onclick = () => {
    const name = pName.value.trim();
    const idNumber = pId.value.trim();
    const address = pAddress.value.trim();
    const course = pCourse.value.trim();
    const nationality = pNationality.value.trim();
    const ethnicity = pEthnicity.value.trim();
    const outsideHome = (document.querySelector('input[name="pOutsideHome"]:checked') || {}).value || '';
    if(!name || !idNumber || !address || !course || !nationality || !ethnicity || !outsideHome){
      alert('Please complete all fields to begin.'); return;
    }
    participantMeta = { name, idNumber, address, course, nationality, ethnicity, outsideHome };
    participantModal.classList.add('hidden');
    instructionsModal.classList.remove('hidden');
    setTimeout(()=>document.getElementById('beginSortingBtn').focus(),0);
  };
  beginSortingBtn.onclick = async () => {
    const uid = participantView.dataset.uid, studyId = participantView.dataset.studyId;
    if(!uid||!studyId){ alert('Study not loaded yet.'); return; }
    const startedAt = new Date().toISOString();
    participantView.dataset.startedAt = startedAt;
    try{
      const ref = db.ref(`users/${uid}/studies/${studyId}/results`).push();
      await ref.set({ timestamp: startedAt, participant: participantMeta, status:'started' });
      participantView.dataset.resultKey = ref.key;
    }catch(e){ console.warn('Could not create started result entry:', e); }
    instructionsModal.classList.add('hidden');
  };

  // Load participant study and initialize Sortables
  async function loadParticipantView(uid, studyId){
    participantStatus.textContent='Loading study...';
    db.ref(`users/${uid}/studies/${studyId}`).once('value')
      .then(async snap=>{
        const study=snap.val();
        if(!study){ participantStudyName.textContent='Study unavailable'; participantStatus.textContent='This study could not be found. Please check the link with the researcher.'; return; }
        if(study.isPublic!==true){ participantStudyName.textContent='Study not published'; participantStatus.textContent='This study is currently not available to participants. Please contact the researcher.'; return; }

        try{
          participantStudyName.textContent=study.name||'';
          if(study.instructions){ participantInstructions.textContent=study.instructions; participantInstructions.classList.remove('hidden'); }
          else { participantInstructions.textContent=''; participantInstructions.classList.add('hidden'); }

          // Populate cards list
          availableCardsContainer.innerHTML='';
          (study.cards||[]).forEach(card=>{
            const d=document.createElement('div');
            d.className='card'; d.textContent=card; d.dataset.cardText=card;
            availableCardsContainer.appendChild(d);
          });

          // Initialize left panel sortable
          new Sortable(availableCardsContainer, { group:'cards', animation:150 });

          // Create-new-category zones
          new Sortable(newCategoryDropzone, {
            group:'cards', animation:150,
            onAdd: evt => {
              const item = evt.item;
              const cat = makeCategory();
              cat.querySelector('.cat-body').appendChild(item);
              updateCategoryCount(cat);
            }
          });
          new Sortable(newCategoryTile, {
            group:'cards', animation:150,
            onAdd: evt => {
              const item = evt.item;
              const cat = makeCategory();
              cat.querySelector('.cat-body').appendChild(item);
              updateCategoryCount(cat);
            }
          });

          sortingArea.innerHTML=''; // starts empty
          updateStepsVisibility();

          participantView.dataset.uid = uid;
          participantView.dataset.studyId = studyId;

          participantStatus.textContent='';
          participantMeta = null;
          participantModal.classList.remove('hidden');
          setTimeout(()=>pName.focus(),0);
        }catch(err){ console.error('Render error:',err); participantStatus.textContent='Something went wrong while rendering the study. Please refresh the page.'; }
      })
      .catch(err=>{ console.error('DB read failed:',err); participantStudyName.textContent='Unable to load study'; participantStatus.textContent='This study is not publicly accessible. Ask the researcher to publish it.'; });
  }

  // Submit sorting
  function submitSorting(){
    const uid = participantView.dataset.uid, studyId = participantView.dataset.studyId;
    if(!uid||!studyId){ alert('Study not loaded yet.'); return; }
    if(!participantMeta){ alert('Please enter your details before submitting.'); participantModal.classList.remove('hidden'); return; }

    const cats = [];
    sortingArea.querySelectorAll('.category').forEach(cat=>{
      const name = (cat.querySelector('.cat-title')?.textContent || '').trim() || 'Unnamed';
      const cards = [...cat.querySelectorAll('.cat-body .card')].map(c=>c.dataset.cardText);
      if(cards.length>0) cats.push({ name, cards });
    });
    if(cats.length===0){ alert('Please sort at least one card.'); return; }

    const startedAtIso = participantView.dataset.startedAt || null;
    const now = new Date();
    const resultData = { participant: participantMeta, categories: cats, status:'completed', completedAt: now.toISOString() };
    if(startedAtIso){ const durationMs = now.getTime()-new Date(startedAtIso).getTime(); resultData.durationMs = durationMs; }

    const resultsRef = db.ref(`users/${uid}/studies/${studyId}/results`);
    const existingKey = participantView.dataset.resultKey;
    const promise = existingKey ? resultsRef.child(existingKey).update(resultData) : resultsRef.push({ timestamp: now.toISOString(), ...resultData });

    promise.then(()=>{ participantView.innerHTML='<h2>Thank you!</h2><p>Your responses have been recorded.</p>'; }).catch(err=>alert(err.message));
  }
  document.getElementById('submitSortingBtn').onclick = submitSorting;

  // Tabs
  tabButtons.forEach(btn => btn.addEventListener('click', () => activateTab(btn.dataset.tab)));

  // View Results (researcher)
  function setupShareControls(uid, studyId, study){
    shareSection.classList.remove('hidden');
    toggleResultsPublic.checked = Boolean(study.resultsPublic);
    publicResultsLink.value = makePublicResultsLink(uid, studyId);
    publicResultsLinkRow.classList.toggle('hidden', !toggleResultsPublic.checked);

    toggleResultsPublic.onchange = async () => {
      const val = toggleResultsPublic.checked;
      publicResultsLinkRow.classList.toggle('hidden', !val);
      try { await db.ref(`users/${uid}/studies/${studyId}/resultsPublic`).set(val); }
      catch(e){ alert('Failed to update sharing setting: ' + e.message); }
    };
    copyPublicResultsBtn.onclick = async () => {
      try{ await navigator.clipboard.writeText(publicResultsLink.value); alert('Public results link copied!'); }
      catch{ publicResultsLink.select(); document.execCommand('copy'); alert('Link copied!'); }
    };
  }

  function viewResults(uid, studyId){
    db.ref(`users/${uid}/studies/${studyId}`).once('value').then(snap=>{
      const study=snap.val();
      resultsStudyName.textContent = study?.name || '';

      // Enable share controls for researcher
      setupShareControls(uid, studyId, study || {});

      db.ref(`users/${uid}/studies/${studyId}/results`).once('value').then(snap2=>{
        const results=snap2.val()||{}; buildResultsUI(study||{}, results, uid, studyId, {publicViewer:false});
      });
    });
  }

  // Public results (no auth)
  function loadPublicResults(uid, studyId){
    // Hide researcher-only controls
    shareSection.classList.add('hidden');
    downloadCsvBtn.style.display = 'none';
    document.getElementById('backToDashboardFromResultsBtn').style.display = 'none';

    db.ref(`users/${uid}/studies/${studyId}`).once('value')
      .then(snap=>{
        const study=snap.val();
        if(!study){ resultsStudyName.textContent = 'Study unavailable'; tabParticipants.innerHTML=''; return; }
        resultsStudyName.textContent = study.name || '';
        if(study.resultsPublic!==true){
          // Show friendly message if not shared
          document.getElementById('participantsSummary').textContent = 'These results are not publicly available.';
          document.getElementById('participantsDetails').textContent = '';
          document.getElementById('categoriesSummary').textContent = '';
          document.getElementById('categoriesChart').innerHTML = '';
          document.getElementById('categoriesLabels').innerHTML = '';
          document.getElementById('matrixMeta').textContent = '';
          document.getElementById('matrixTableWrap').innerHTML = '';
          show(resultsView); activateTab('participants'); return;
        }
        db.ref(`users/${uid}/studies/${studyId}/results`).once('value').then(snap2=>{
          const results=snap2.val()||{}; buildResultsUI(study, results, uid, studyId, {publicViewer:true});
        }).catch(err=>{
          document.getElementById('participantsSummary').textContent = 'Unable to load results publicly.';
          console.error(err);
          show(resultsView); activateTab('participants');
        });
      }).catch(err=>{
        console.error(err);
        resultsStudyName.textContent = 'Unable to load study';
        show(resultsView); activateTab('participants');
      });
  }

  // Shared results renderer
  function buildResultsUI(study, resultsObj, uid, studyId, opts){
    const arr0 = Object.values(resultsObj || {});
    const participantsSummary = document.getElementById('participantsSummary');
    const participantsDetails = document.getElementById('participantsDetails');
    const categoriesSummary = document.getElementById('categoriesSummary');
    const categoriesChart = document.getElementById('categoriesChart');
    const categoriesLabels = document.getElementById('categoriesLabels');
    const matrixMeta = document.getElementById('matrixMeta');
    const matrixTableWrap = document.getElementById('matrixTableWrap');

    let arr = arr0;
    lastResultsCache = null; downloadCsvBtn.disabled = true;

    if(arr.length===0){
      participantsSummary.textContent='No results yet.';
      participantsDetails.innerHTML=''; categoriesSummary.textContent='';
      categoriesChart.innerHTML=''; categoriesLabels.innerHTML='';
      matrixMeta.textContent=''; matrixTableWrap.innerHTML='';
      show(resultsView); activateTab('participants'); return;
    }
    arr = arr.sort((a,b)=>new Date(a.timestamp||0)-new Date(b.timestamp||0));
    const completed = arr.filter(r=>r.status==='completed' || Array.isArray(r.categories));
    const startedCount = arr.length, completedCount = completed.length;
    const durations = completed.map(r=>r.durationMs).filter(v=>typeof v==='number'&&isFinite(v)&&v>=0);
    const avgDurationMs = durations.length ? Math.round(durations.reduce((a,b)=>a+b,0)/durations.length) : null;

    participantsSummary.textContent = `Started: ${startedCount} | Completed: ${completedCount} | Avg sorting time: ${avgDurationMs!=null?formatDuration(avgDurationMs)+` (n=${durations.length})`:'N/A'}`;
    participantsDetails.innerHTML='';
    completed.forEach((res,i)=>{
      const w=document.createElement('div');
      const h4=document.createElement('h4'); const pinfo=res.participant||{}; const dn=pinfo.name?` ‚Äî ${pinfo.name}`:'';
      h4.textContent=`Participant ${i+1}${dn}`; w.appendChild(h4);
      const meta=document.createElement('div'); meta.className='muted';
      meta.textContent=[
        pinfo.idNumber?`ID: ${pinfo.idNumber}`:'', pinfo.course?`Course: ${pinfo.course}`:'',
        pinfo.nationality?`Nationality: ${pinfo.nationality}`:'', pinfo.ethnicity?`Ethnicity: ${pinfo.ethnicity}`:'',
        pinfo.outsideHome?`Home outside Suva/Nausori: ${pinfo.outsideHome}`:'',
        res.completedAt?`Completed: ${new Date(res.completedAt).toLocaleString()}`:(res.timestamp?`Time: ${new Date(res.timestamp).toLocaleString()}`:''),
        typeof res.durationMs==='number'?`Duration: ${formatDuration(res.durationMs)}`:''
      ].filter(Boolean).join(' | ');
      if(meta.textContent) w.appendChild(meta);
      (res.categories||[]).forEach(cat=>{
        const p=document.createElement('p'); const strong=document.createElement('strong');
        strong.textContent=cat.name||'Unnamed'; p.appendChild(strong); p.append(' ');
        (cat.cards||[]).forEach(c=>{ const chip=document.createElement('span'); chip.className='category-card'; chip.textContent=c; p.appendChild(chip); p.append(' '); });
        w.appendChild(p);
      });
      participantsDetails.appendChild(w);
    });

    // Categories tab
    const catsPer = completed.map(r=>(r.categories||[]).length);
    const avgCats = catsPer.length ? (catsPer.reduce((a,b)=>a+b,0)/catsPer.length) : 0;
    categoriesSummary.textContent=`Average number of categories: ${avgCats.toFixed(2)} (n=${completedCount})`;
    const dist = new Map(); catsPer.forEach(n=>dist.set(n,(dist.get(n)||0)+1));
    const maxBuckets = dist.size ? Math.max(...dist.keys()) : 0;
    categoriesChart.innerHTML=''; categoriesLabels.innerHTML='';
    if(maxBuckets>0){
      const counts=[]; for(let i=1;i<=maxBuckets;i++) counts.push(dist.get(i)||0);
      const peak=Math.max(...counts,1);
      counts.forEach((count,idx)=>{
        const bar=document.createElement('div'); bar.className='bar'; bar.style.height=Math.round((count/peak)*100)+'%';
        const val=document.createElement('span'); val.textContent=count; bar.appendChild(val); categoriesChart.appendChild(bar);
        const xl=document.createElement('div'); xl.className='xlabel'; xl.textContent=String(idx+1); categoriesLabels.appendChild(xl);
      });
    }else{ const p=document.createElement('p'); p.textContent='No completed participants yet.'; categoriesChart.appendChild(p); }

    // Matrix tab
    matrixMeta.innerHTML=''; matrixTableWrap.innerHTML='';
    const cards = study?.cards || []; const matrix={}; cards.forEach(a=>{ matrix[a]={}; cards.forEach(b=>matrix[a][b]=0); });
    let totalCats=0; completed.forEach(r=>{ const catsR=r.categories||[]; totalCats+=catsR.length; catsR.forEach(cat=>{ const cs=cat.cards||[]; cs.forEach(a=>cs.forEach(b=>{ if(a!==b) matrix[a][b]+=1; })); }); });
    const mm=document.createElement('p'); mm.textContent=`Started: ${startedCount} | Completed: ${completedCount} | Avg categories: ${completedCount?(totalCats/completedCount).toFixed(2):'0.00'}`; matrixMeta.appendChild(mm);
    const table=document.createElement('table'); const thead=document.createElement('thead'); const hr=document.createElement('tr'); hr.appendChild(document.createElement('th'));
    cards.forEach(c=>{ const th=document.createElement('th'); th.textContent=c; hr.appendChild(th); }); thead.appendChild(hr); table.appendChild(thead);
    const tbody=document.createElement('tbody'); cards.forEach(a=>{ const tr=document.createElement('tr'); const rh=document.createElement('th'); rh.textContent=a; tr.appendChild(rh);
      cards.forEach(b=>{ const td=document.createElement('td'); td.textContent=(a===b)?'-':matrix[a][b]; tr.appendChild(td); }); tbody.appendChild(tr);
    }); table.appendChild(tbody); matrixTableWrap.appendChild(table);

    // Cache for CSV (only show to researchers)
    lastResultsCache = { arr, study, uid, studyId };
    if (!opts.publicViewer) downloadCsvBtn.disabled=false;

    show(resultsView); activateTab('participants');
  }

  // View results from dashboard button
  window.viewResults = viewResults;

  // CSV export
  document.getElementById('downloadCsvBtn').onclick = () => {
    if(!lastResultsCache){ alert('No results to export.'); return; }
    const { arr, study } = lastResultsCache;
    const studyName = (study?.name||'study').replace(/[^\w\-]+/g,'_');
    const headers = ['Participant #','Timestamp','Name','ID Number','Address','Course','Nationality','Ethnicity','HomeOutsideSuvaNausori','Category','Card'];
    const lines=[headers.join(',')];
    let idx=0;
    arr.forEach(res=>{
      if(!(res.status==='completed'||Array.isArray(res.categories))) return;
      idx+=1; const p=res.participant||{}; const ts=res.timestamp||res.completedAt||'';
      (res.categories||[]).forEach(cat=>{
        const catName=cat.name||'Unnamed';
        (cat.cards||[]).forEach(card=>{
          lines.push([csvEscape(idx),csvEscape(ts),csvEscape(p.name||''),csvEscape(p.idNumber||''),csvEscape(p.address||''),csvEscape(p.course||''),csvEscape(p.nationality||''),csvEscape(p.ethnicity||''),csvEscape(p.outsideHome||''),csvEscape(catName),csvEscape(card)].join(','));
        });
      });
    });
    downloadCSV(`${studyName}_results.csv`, lines.join('\n'));
  };

  // Participant/public routing on first load
  if (isPublicResultsLink) {
    show(resultsView);
    loadPublicResults(pUid, pStudyId);
  } else if (hasParticipantLink) {
    show(participantView);
    loadParticipantView(pUid, pStudyId);
  }
});
</script>
</body>
</html>
