<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Open Card Sorting Tool - Researcher Accounts</title>
  <style>
    :root {
      --primary: #4a6fa5;
      --secondary: #6b8cae;
      --accent: #ff6b6b;
      --light: #f8f9fa;
      --dark: #343a40;
      --success: #28a745;
      --border: #dee2e6;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, Arial, sans-serif;
    }

    body { background: #f5f7fa; color: var(--dark); line-height: 1.5; }

    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    header {
      background: var(--primary);
      color: white;
      padding: 1rem;
      text-align: center;
      margin-bottom: 2rem;
      border-radius: 5px;
    }

    .view {
      display: none;
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,.1);
      margin-bottom: 2rem;
    }
    .view.active { display: block; }

    .btn {
      padding: .5rem 1rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: .25rem;
      touch-action: manipulation;
    }
    .btn:hover { background: var(--secondary); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn-success { background: var(--success); }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-accent:hover { filter: brightness(0.95); }

    .hidden { display: none !important; }

    label { display: block; margin: .25rem 0 .25rem; font-weight: 600; }
    input, textarea {
      width: 100%;
      padding: .5rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: 4px;
    }

    .study-item {
      border: 1px solid var(--border);
      padding: .75rem;
      margin-bottom: .5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: .5rem;
      flex-wrap: wrap;
    }
    .study-actions { display: flex; gap: .25rem; flex-wrap: wrap; }

    .instructions { background: #e9ecef; padding: 1rem; margin-bottom: 1rem; border-radius: 4px; }

    .category-card {
      background: #eee;
      padding: .25rem .5rem;
      border-radius: 4px;
      margin: .25rem;
      display: inline-block;
    }

    .table-wrap { overflow: auto; margin-top: 1rem; border: 1px solid var(--border); border-radius: 6px; }
    table { border-collapse: collapse; min-width: 600px; width: 100%; }
    th, td { border: 1px solid var(--border); padding: .5rem; text-align: center; white-space: nowrap; }

    .card {
      background: white;
      border: 1px solid var(--border);
      padding: 1rem;
      margin: .25rem;
      border-radius: 6px;
      cursor: grab;
      user-select: none;
      box-shadow: 0 1px 0 rgba(0,0,0,0.05);
    }
    .card:active { cursor: grabbing; }
    .card:focus { outline: 3px solid #9ec5fe; outline-offset: 2px; }
    .card[aria-selected="true"] { box-shadow: 0 0 0 3px #ffae42 inset; }

    .muted { color: #6c757d; }
    .badge {
      display: inline-block;
      padding: .1rem .4rem;
      border-radius: .25rem;
      font-size: .8rem;
      background: #edf2ff;
      color: #2f4e8b;
      border: 1px solid #dbe4ff;
    }

    /* Participant workspace layout (cards left, canvas right) */
    .workspace {
      display: grid;
      grid-template-columns: 340px 1fr;
      gap: 18px;
      align-items: start;
    }
    .left-panel {
      background: #d1d1cf;
      border: 1px solid #c5c5c3;
      border-radius: 10px;
      padding: 12px;
      position: sticky;
      top: 12px;
      max-height: calc(100vh - 180px);
      overflow: auto;
    }
    .left-panel h3 { margin: .25rem 0 .5rem; }
    .cards-list { display: flex; flex-direction: column; gap: .5rem; }

    .right-panel { min-height: 60vh; position: relative; }
    .toolbar {
      margin-bottom: .5rem;
      display: flex;
      gap: .5rem;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    /* Mobile responsiveness */
    @media (max-width: 900px) {
      .workspace { grid-template-columns: 1fr; }
      .left-panel { position: static; max-height: none; }
      .right-panel { order: 2; }
      .left-panel { order: 1; }
      .categories-wrap { grid-template-columns: 1fr; }
    }
    @media (max-width: 520px) {
      .card { padding: .8rem; }
      .cat-header { font-size: .95rem; }
    }

    /* Steps shown until a category exists */
    .steps { display: flex; flex-direction: column; gap: 18px; margin-bottom: 18px; }
    .stepbox {
      border: 2px dashed #ddd;
      border-radius: 14px;
      padding: 18px;
      background: #fff;
      box-shadow: 0 1px 0 rgba(0,0,0,0.02);
    }
    .stepbox h3 { font-size: 1.35rem; margin-bottom: .5rem; }
    .stepbox ol { margin-left: 1.25rem; }
    .stepbox li { margin: .25rem 0; }

    /* Dropzone (visible until at least one category exists) */
    .new-cat-dropzone {
      border: 2px dashed #cfcfcf;
      border-radius: 10px;
      min-height: 110px;
      padding: 14px;
      background: #fafafa;
      margin-top: .5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-weight: 600;
    }

    /* Categories canvas */
    .categories-wrap {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
      min-height: 200px;
    }

    /* Category card */
    .category {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,.06);
      border: 1px solid var(--border);
      overflow: hidden;
    }
    .cat-header {
      background: #3d4038;
      color: #fff;
      padding: .5rem .75rem;
      font-weight: 600;
      text-align: center;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
    }
    .cat-title-input {
      background: transparent;
      border: none;
      color: #fff;
      font-weight: 600;
      text-align: center;
      width: 70%;
      outline: none;
      padding: .15rem .25rem;
      border-bottom: 1px dashed rgba(255,255,255,.35);
    }
    .cat-title-input::placeholder { color: #e7e7e7; opacity: .85; }
    .cat-icon-btn {
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 0 .25rem;
      font-size: 1rem;
    }
    .cat-icon-btn:focus { outline: 2px solid #9ec5fe; border-radius: 4px; }

    .cat-body {
      padding: .5rem;
      background: #fff;
      margin: .5rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      min-height: 80px;
    }
    .cat-footer {
      text-align: center;
      font-size: .75rem;
      color: #6b6b6b;
      padding: .25rem .5rem .6rem;
      text-transform: uppercase;
      letter-spacing: .02em;
    }

    .new-cat-tile {
      border: 2px dashed #cfcfcf;
      border-radius: 10px;
      min-height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #fafafa;
      color: #666;
      font-weight: 600;
      margin-top: 12px;
    }

    /* Modal (participant info + instructions) */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 1rem;
    }
    .modal {
      background: #fff;
      border-radius: 10px;
      width: min(640px, 100%);
      padding: 1.25rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
      max-height: 90vh;
      overflow: auto;
      overscroll-behavior: contain;
    }
    .modal .actions { display: flex; justify-content: flex-end; gap: .5rem; margin-top: .25rem; }

    /* Tabs (results) */
    .tabs { display: flex; gap: .5rem; margin: .5rem 0 1rem; border-bottom: 1px solid var(--border); }
    .tab-btn {
      background: transparent;
      color: var(--dark);
      border: none;
      padding: .5rem .75rem;
      cursor: pointer;
      border-bottom: 3px solid transparent;
    }
    .tab-btn.active { border-bottom-color: var(--primary); color: var(--primary); font-weight: 600; }
    .tab-pane { display: none; }
    .tab-pane.active { display: block; }

    /* Simple bar chart */
    .chart-wrap { margin-top: .5rem; }
    .chart {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      height: 220px;
      padding: 8px;
      border-left: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }
    .bar {
      background: linear-gradient(180deg, var(--secondary), var(--primary));
      flex: 1;
      min-width: 24px;
      border-radius: 4px 4px 0 0;
      position: relative;
    }
    .bar span { position: absolute; bottom: 100%; transform: translateY(-4px); font-size: .8rem; color: var(--dark); }
    .xlabels { display: flex; gap: 8px; margin-top: 4px; }
    .xlabel { flex: 1; min-width: 24px; text-align: center; font-size: .8rem; color: var(--dark); }

    /* Share results row */
    .share-row input { width: 100%; }
    .share-row { display: flex; gap: .5rem; margin-top: .5rem; align-items: center; }
  </style>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Open Card Sorting Tool</h1>
      <div id="welcomeBanner" class="muted" aria-live="polite"></div>
    </header>

    <!-- Login / Signup -->
    <div id="authView" class="view active">
      <h2 id="authHeading">Researcher Login</h2>
      <form id="authForm" novalidate>
        <label for="displayName">Full name (for new sign-ups)</label>
        <input type="text" id="displayName" placeholder="e.g., John Doe" autocomplete="name"/>

        <label for="email">Email</label>
        <input type="email" id="email" placeholder="name@example.com" autocomplete="username" inputmode="email" required/>

        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Password" autocomplete="current-password" required/>

        <div>
          <button id="loginBtn" type="submit" class="btn">Login</button>
          <button id="signupBtn" type="button" class="btn btn-accent">Sign Up</button>
          <button id="forgotPwdBtn" type="button" class="btn">Forgot Password</button>
        </div>
      </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboardView" class="view">
      <h2>Dashboard</h2>
      <div>
        <button id="createStudyBtn" class="btn">Create New Study</button>
        <button id="logoutBtn" class="btn btn-accent">Logout</button>
      </div>
      <h3>Your Studies</h3>
      <div id="studiesList" aria-live="polite"></div>
    </div>

    <!-- Create Study -->
    <div id="setupView" class="view">
      <h2>Create a New Study</h2>

      <label for="studyName">Study name</label>
      <input type="text" id="studyName" placeholder="e.g., Information Architecture Test" required/>

      <label for="cardsInput">Cards (one per line)</label>
      <textarea id="cardsInput" rows="8" placeholder="Card 1&#10;Card 2&#10;Card 3" required></textarea>

      <label for="instructionsInput">Instructions (optional)</label>
      <textarea id="instructionsInput" rows="4" placeholder="Describe what participants should do..."></textarea>

      <div>
        <button id="saveStudyBtn" class="btn btn-success">Save Study</button>
        <button id="cancelCreateBtn" class="btn">Cancel</button>
      </div>
    </div>

    <!-- Share Link -->
    <div id="studyCreatedView" class="view">
      <h2>Study Created!</h2>
      <label for="studyLink">Share this link with participants</label>
      <input type="text" id="studyLink" readonly/>
      <div>
        <button id="copyLinkBtn" class="btn">Copy Link</button>
        <button id="backToDashboardBtn" class="btn">Back to Dashboard</button>
      </div>
    </div>

    <!-- Participant -->
    <div id="participantView" class="view" aria-live="polite">
      <h2 id="participantStudyName"></h2>
      <div id="participantInstructions" class="instructions hidden"></div>
      <div id="participantStatus" class="muted" aria-live="polite"></div>

      <div class="workspace" role="region" aria-label="Card sorting workspace">
        <aside class="left-panel" role="region" aria-label="Card list">
          <h3>Cards</h3>
          <div class="muted" style="margin-bottom:.5rem;">
            Drag a card to the right to create or fill categories.
          </div>
          <div id="availableCards" class="cards-list"></div>
        </aside>

        <section class="right-panel" role="region" aria-label="Categories canvas">
          <div id="stepsWrap" class="steps">
            <div class="stepbox">
              <h3>Step 1</h3>
              <ol>
                <li>Take note of the list of cards on the left.</li>
                <li>Please, split these cards into categories that feel ‚Äúright‚Äù to you.</li>
                <li><strong>There‚Äôs no actual right or wrong way</strong> to do it. Simply sort them by intuition.</li>
              </ol>
            </div>
            <div class="stepbox">
              <h3>Step 2</h3>
              <p>Drag a card from the left and drop it here or anywhere on the right to create a new category.</p>
              <div id="newCategoryDropzone" class="new-cat-dropzone" aria-label="Drop here to create a new category">
                Drop here to create a new category
              </div>
            </div>
          </div>

          <div class="toolbar">
            <button id="submitSortingBtn" class="btn btn-success">Finish</button>
          </div>

          <div id="sortingArea" class="categories-wrap"></div>
          <div id="newCategoryTile" class="new-cat-tile hidden" aria-label="Drop here to create a new category">
            Drop here to create a new category
          </div>
        </section>
      </div>
    </div>

    <!-- Participant Info Modal -->
    <div id="participantModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="participantModalTitle">
      <div class="modal">
        <h3 id="participantModalTitle">Before you begin</h3>
        <p>Please enter your details to proceed.</p>

        <label for="pName">Full name</label>
        <input id="pName" type="text" placeholder="Your name" required/>

        <label for="pId">ID number</label>
        <input id="pId" type="text" placeholder="Your ID number" required/>

        <label for="pAddress">Address</label>
        <textarea id="pAddress" rows="3" placeholder="Your address" required></textarea>

        <label for="pCourse">Course</label>
        <input id="pCourse" type="text" placeholder="Your course" required/>

        <label for="pNationality">Nationality</label>
        <input id="pNationality" type="text" placeholder="Your nationality" required/>

        <label for="pEthnicity">Ethnicity</label>
        <input id="pEthnicity" type="text" placeholder="Your ethnicity" required/>

        <fieldset>
          <legend>Is your family home outside of Suva/Nausori? (Yes/No)</legend>
          <div class="radio-row">
            <label><input type="radio" name="pOutsideHome" value="Yes" required/> Yes</label>
            <label><input type="radio" name="pOutsideHome" value="No" required/> No</label>
          </div>
        </fieldset>

        <div class="actions">
          <button id="startSortingBtn" class="btn btn-success">Continue</button>
        </div>
      </div>
    </div>

    <!-- Instructions Modal -->
    <div id="instructionsModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="instructionsModalTitle">
      <div class="modal">
        <h3 id="instructionsModalTitle">Instructions</h3>
        <p><strong>Here's how it works:</strong></p>
        <ol>
          <li>You will be presented with a list of cards.</li>
          <li>Drag and drop the cards into the categories that you think they fit the most.</li>
          <li>If you change your opinion, feel free to move the cards between the different categories until you're satisfied.</li>
          <li>Once done, click <strong>Finish</strong> to complete the card sort.</li>
        </ol>
        <div class="actions">
          <button id="beginSortingBtn" class="btn btn-success">Begin</button>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsView" class="view">
      <h2>Study Results: <span id="resultsStudyName"></span></h2>

      <div class="tabs">
        <button class="tab-btn active" data-tab="participants">Participants</button>
        <button class="tab-btn" data-tab="categories">Categories</button>
        <button class="tab-btn" data-tab="matrix">Similarity Matrix</button>
      </div>

      <!-- Share results controls -->
      <div id="shareSection" class="instructions hidden">
        <strong>Share results</strong>
        <div style="margin-top:.5rem">
          <label style="display:inline-flex; align-items:center; gap:.5rem">
            <input type="checkbox" id="toggleResultsPublic"/> Enable public results link
          </label>
        </div>
        <div id="publicResultsLinkRow" class="share-row hidden">
          <input type="text" id="publicResultsLink" readonly/>
          <button id="copyPublicResultsBtn" class="btn">Copy Public Link</button>
        </div>
        <div class="muted" style="margin-top:.25rem">Anyone with the link can view the results without logging in.</div>
      </div>

      <!-- Participants Tab -->
      <div id="tabParticipants" class="tab-pane active">
        <div id="participantsSummary"></div>
        <div id="participantsDetails"></div>
      </div>

      <!-- Categories Tab -->
      <div id="tabCategories" class="tab-pane">
        <div id="categoriesSummary"></div>
        <div class="chart-wrap">
          <div class="chart" id="categoriesChart"></div>
          <div class="xlabels" id="categoriesLabels"></div>
        </div>
        <div id="categoryFreq" style="margin-top:.75rem">
          <h3 style="margin:.75rem 0 .25rem">Most common category names</h3>
          <ul id="categoryFreqList" class="list"></ul>
        </div>
      </div>

      <!-- Matrix Tab -->
      <div id="tabMatrix" class="tab-pane">
        <div id="matrixMeta"></div>
        <div id="matrixTableWrap" class="table-wrap"></div>
      </div>

      <div style="margin-top: 1rem">
        <button id="downloadCsvBtn" class="btn">Download CSV</button>
        <button id="downloadMatrixBtn" class="btn">Download Matrix CSV</button>
        <button id="backToDashboardFromResultsBtn" class="btn">Back to Dashboard</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyAu1hawycY2uQgzWolaHeTfCdWtSWux7XA",
        authDomain: "card-sorting-tool-762a3.firebaseapp.com",
        databaseURL: "https://card-sorting-tool-762a3-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "card-sorting-tool-762a3",
        storageBucket: "card-sorting-tool-762a3.firebasestorage.app",
        messagingSenderId: "361630774945",
        appId: "1:361630774945:web:402edb363d388a61baa2e0",
        measurementId: "G-BGV3P2HQZP"
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.database();

      // Views
      const authView = document.getElementById('authView');
      const dashboardView = document.getElementById('dashboardView');
      const setupView = document.getElementById('setupView');
      const studyCreatedView = document.getElementById('studyCreatedView');
      const participantView = document.getElementById('participantView');
      const resultsView = document.getElementById('resultsView');
      const welcomeBanner = document.getElementById('welcomeBanner');

      // Inputs
      const displayNameInput = document.getElementById('displayName');
      const emailInput = document.getElementById('email');
      const passwordInput = document.getElementById('password');
      const studyNameInput = document.getElementById('studyName');
      const cardsInput = document.getElementById('cardsInput');
      const instructionsInput = document.getElementById('instructionsInput');
      const studyLinkInput = document.getElementById('studyLink');

      // Participant DOM
      const availableCardsContainer = document.getElementById('availableCards');
      const sortingArea = document.getElementById('sortingArea');
      const participantStudyName = document.getElementById('participantStudyName');
      const participantInstructions = document.getElementById('participantInstructions');
      const participantStatus = document.getElementById('participantStatus');
      const stepsWrap = document.getElementById('stepsWrap');
      const newCategoryDropzone = document.getElementById('newCategoryDropzone');
      const newCategoryTile = document.getElementById('newCategoryTile');

      // Results DOM
      const resultsStudyName = document.getElementById('resultsStudyName');
      const participantsSummary = document.getElementById('participantsSummary');
      const participantsDetails = document.getElementById('participantsDetails');
      const categoriesSummary = document.getElementById('categoriesSummary');
      const categoriesChart = document.getElementById('categoriesChart');
      const categoriesLabels = document.getElementById('categoriesLabels');
      const categoryFreqList = document.getElementById('categoryFreqList');
      const matrixMeta = document.getElementById('matrixMeta');
      const matrixTableWrap = document.getElementById('matrixTableWrap');
      const downloadCsvBtn = document.getElementById('downloadCsvBtn');
      const downloadMatrixBtn = document.getElementById('downloadMatrixBtn');
      const shareSection = document.getElementById('shareSection');
      const toggleResultsPublic = document.getElementById('toggleResultsPublic');
      const publicResultsLinkRow = document.getElementById('publicResultsLinkRow');
      const publicResultsLink = document.getElementById('publicResultsLink');
      const copyPublicResultsBtn = document.getElementById('copyPublicResultsBtn');

      // Tabs DOM refs
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabParticipants = document.getElementById('tabParticipants');
      const tabCategories = document.getElementById('tabCategories');
      const tabMatrix = document.getElementById('tabMatrix');

      // Tab controls (robust: uses event delegation on the results view)
function activateTab(name) {
  // Toggle active state on buttons
  tabButtons.forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === name);
  });

  // Toggle the panes
  tabParticipants.classList.toggle('active', name === 'participants');
  tabCategories.classList.toggle('active', name === 'categories');
  tabMatrix.classList.toggle('active', name === 'matrix');
}

// Use event delegation so it still works if tabs rerender or listeners run early
resultsView.addEventListener('click', (e) => {
  const btn = e.target.closest('.tab-btn');
  if (!btn) return;
  e.preventDefault();
  activateTab(btn.dataset.tab);
});

      // Participant modals
      const participantModal = document.getElementById('participantModal');
      const instructionsModal = document.getElementById('instructionsModal');
      const pName = document.getElementById('pName');
      const pId = document.getElementById('pId');
      const pAddress = document.getElementById('pAddress');
      const pCourse = document.getElementById('pCourse');
      const pNationality = document.getElementById('pNationality');
      const pEthnicity = document.getElementById('pEthnicity');
      const startSortingBtn = document.getElementById('startSortingBtn');
      const beginSortingBtn = document.getElementById('beginSortingBtn');

      // Params
      const params = new URLSearchParams(location.search);
      const pUid = params.get('uid');
      const pStudyId = params.get('study');
      const viewParam = params.get('view');
      const hasParticipantLink = Boolean(pUid && pStudyId && !viewParam);
      const isPublicResultsLink = Boolean(pUid && pStudyId && viewParam === 'results');

      // Cache
      let participantMeta = null;
      let lastResultsCache = null;

      // Utils
      function show(view) {
        [authView, dashboardView, setupView, studyCreatedView, participantView, resultsView].forEach(v => v.classList.remove('active'));
        view.classList.add('active');
      }
      function sanitizeText(v) {
        return String(v ?? '')
          .replace(/<[^>]*>/g, '')
          .replace(/[\u0000-\u001F\u007F]/g, '')
          .replace(/\s+/g, ' ')
          .trim()
          .slice(0, 200);
      }
      function formatDuration(ms) {
        if (typeof ms !== 'number' || !isFinite(ms) || ms < 0) return '';
        let s = Math.floor(ms / 1000);
        const h = Math.floor(s / 3600);
        s %= 3600;
        const m = Math.floor(s / 60);
        s %= 60;
        return h ? `${h}h ${m}m ${s}s` : `${m}m ${s}s`;
      }
      function csvEscape(v) {
        const s = (v == null ? '' : String(v));
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g, '""') + '"' : s;
      }
      function downloadCSV(filename, text) {
        const blob = new Blob(["\ufeff" + text], { type: "text/csv;charset=utf-8;" });
        if (navigator.msSaveBlob) {
          navigator.msSaveBlob(blob, filename);
        } else {
          const a = document.createElement('a');
          const url = URL.createObjectURL(blob);
          a.href = url;
          a.download = filename;
          a.style.visibility = 'hidden';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          setTimeout(() => URL.revokeObjectURL(url), 0);
        }
      }
      function makeShareLink(uid, studyId) {
        const base = new URL(window.location.href);
        base.search = ''; base.hash = '';
        return `${base.toString()}?uid=${uid}&study=${studyId}`;
      }
      function makePublicResultsLink(uid, studyId) {
        const base = new URL(window.location.href);
        base.search = ''; base.hash = '';
        return `${base.toString()}?uid=${uid}&study=${studyId}&view=results`;
      }

      // Auth
      document.getElementById('loginBtn').onclick = async () => {
        try { await auth.signInWithEmailAndPassword(emailInput.value.trim(), passwordInput.value); }
        catch (e) { alert(e.message); }
      };
      document.getElementById('signupBtn').onclick = async () => {
        try {
          const name = sanitizeText(displayNameInput.value);
          if (!name) { alert('Please enter your full name for sign-up.'); displayNameInput.focus(); return; }
          const cred = await auth.createUserWithEmailAndPassword(emailInput.value.trim(), passwordInput.value);
          await cred.user.updateProfile({ displayName: name });
          await db.ref(`users/${cred.user.uid}/profile`).set({ name, email: cred.user.email, createdAt: new Date().toISOString() });
          alert('Account created! You are now logged in.');
        } catch (e) { alert(e.message); }
      };
      document.getElementById('forgotPwdBtn').onclick = async () => {
        try {
          const email = prompt('Enter your registered email address:');
          if (!email) return;
          await auth.sendPasswordResetEmail(email.trim());
          alert('Password reset email sent. Please check your inbox.');
        } catch (e) { alert(e.message); }
      };
      document.getElementById('logoutBtn').onclick = () => auth.signOut();

      auth.onAuthStateChanged(user => {
        if (user && (user.displayName || user.email)) welcomeBanner.textContent = `Welcome, ${user.displayName || user.email} üëã`;
        else welcomeBanner.textContent = '';

        if (isPublicResultsLink) { show(resultsView); loadPublicResults(pUid, pStudyId); return; }
        if (hasParticipantLink) { show(participantView); loadParticipantView(pUid, pStudyId); return; }

        if (user) { show(dashboardView); showDashboard(user.uid); }
        else { show(authView); emailInput.focus(); }
      });

      // Dashboard
      function showDashboard(uid) {
        const studiesList = document.getElementById('studiesList');
        studiesList.textContent = '';
        const seen = new Set();
        db.ref(`users/${uid}/studies`).once('value').then(snap => {
          const data = snap.val() || {};
          Object.entries(data).forEach(([id, study]) => {
            if (seen.has(id)) return;
            addStudyToDashboard(uid, id, study);
            seen.add(id);
          });
        });
      }
      function addStudyToDashboard(uid, studyId, study) {
        const list = document.getElementById('studiesList');
        const div = document.createElement('div');
        div.className = 'study-item';

        const info = document.createElement('div');
        const title = document.createElement('div'); title.textContent = study.name || '(Untitled study)';
        const pub = document.createElement('div'); pub.className = 'muted'; pub.innerHTML = `<span class="badge">${study.isPublic ? 'Published' : 'Unpublished'}</span>`;
        info.appendChild(title); info.appendChild(pub);

        const actions = document.createElement('div'); actions.className = 'study-actions';
        const shareBtn = document.createElement('button'); shareBtn.className = 'btn'; shareBtn.textContent = 'Share Link';
        shareBtn.onclick = async () => { const link = makeShareLink(uid, studyId); try { await navigator.clipboard.writeText(link); alert('Link copied.'); } catch { prompt('Copy this link:', link); } };
        const publishBtn = document.createElement('button'); publishBtn.className = 'btn'; publishBtn.textContent = study.isPublic ? 'Unpublish' : 'Publish';
        publishBtn.onclick = async () => {
          const val = !Boolean(study.isPublic);
          await db.ref(`users/${uid}/studies/${studyId}/isPublic`).set(val);
          study.isPublic = val;
          publishBtn.textContent = val ? 'Unpublish' : 'Publish';
          pub.innerHTML = `<span class="badge">${val ? 'Published' : 'Unpublished'}</span>`;
        };
        const resultsBtn = document.createElement('button'); resultsBtn.className = 'btn btn-success'; resultsBtn.textContent = 'Results'; resultsBtn.onclick = () => viewResults(uid, studyId);
        const deleteBtn = document.createElement('button'); deleteBtn.className = 'btn btn-accent'; deleteBtn.textContent = 'Delete'; deleteBtn.onclick = () => deleteStudy(uid, studyId, study.name, div);

        actions.appendChild(shareBtn);
        actions.appendChild(publishBtn);
        actions.appendChild(resultsBtn);
        actions.appendChild(deleteBtn);

        div.appendChild(info);
        div.appendChild(actions);
        list.appendChild(div);
      }
      async function deleteStudy(uid, studyId, studyName, rowEl) {
        if (!confirm(`Delete the study "${studyName || studyId}" and all of its results? This cannot be undone.`)) return;
        const buttons = rowEl ? rowEl.querySelectorAll('button') : [];
        buttons.forEach(b => b.disabled = true);
        try {
          await db.ref().update({ [`users/${uid}/studies/${studyId}`]: null });
          if (rowEl && rowEl.parentNode) rowEl.parentNode.removeChild(rowEl);
          alert('Study deleted.');
        } catch (e) {
          alert('Delete failed: ' + e.message);
          buttons.forEach(b => b.disabled = false);
        }
      }

      // Create study
      document.getElementById('createStudyBtn').onclick = () => { show(setupView); setTimeout(() => studyNameInput.focus(), 0); };
      document.getElementById('cancelCreateBtn').onclick = () => show(dashboardView);
      document.getElementById('saveStudyBtn').onclick = () => {
        const user = auth.currentUser;
        if (!user) { alert('You must be logged in to save a study.'); return; }
        const name = sanitizeText(studyNameInput.value);
        const cards = cardsInput.value.split('\n').map(s => sanitizeText(s)).filter(Boolean);
        if (!name || cards.length === 0) { alert('Enter name and at least one card'); return; }
        const studyId = 'study_' + Date.now();
        const study = {
          id: studyId,
          name,
          cards,
          instructions: sanitizeText(instructionsInput.value),
          createdAt: new Date().toISOString(),
          ownerUid: user.uid,
          isPublic: true
        };
        db.ref(`users/${user.uid}/studies/${studyId}`).set(study).then(() => {
          studyLinkInput.value = makeShareLink(user.uid, studyId);
          show(studyCreatedView);
        });
      };
      document.getElementById('copyLinkBtn').onclick = async () => {
        try { await navigator.clipboard.writeText(studyLinkInput.value); alert('Link copied!'); }
        catch { studyLinkInput.select(); document.execCommand('copy'); alert('Link copied!'); }
      };
      document.getElementById('backToDashboardBtn').onclick = () => show(dashboardView);
      document.getElementById('backToDashboardFromResultsBtn').onclick = () => show(dashboardView);

      // Participant helpers
      function updateStepsVisibility() {
        const hasAny = sortingArea.querySelectorAll('.category').length > 0;
        stepsWrap.classList.toggle('hidden', hasAny);
        newCategoryTile.classList.toggle('hidden', !hasAny);
      }
      function updateCategoryCount(cat) {
        const count = cat.querySelectorAll('.cat-body .card').length;
        cat.querySelector('.cat-footer').textContent = (count === 1 ? '1 CARD' : `${count} CARDS`);
        updateStepsVisibility();
      }
      function toggleCollapse(cat) {
        const body = cat.querySelector('.cat-body');
        const icon = cat.querySelector('.cat-toggle');
        const hidden = body.classList.toggle('hidden');
        icon.textContent = hidden ? '‚ñæ' : '‚ñ¥';
        cat.querySelector('.cat-header').setAttribute('aria-expanded', String(!hidden));
      }
      function deleteCategory(cat) {
        [...cat.querySelectorAll('.cat-body .card')].forEach(c => availableCardsContainer.appendChild(c));
        cat.remove();
        updateStepsVisibility();
      }
      function makeCategory(name = '') {
        const cat = document.createElement('div');
        cat.className = 'category';
        cat.innerHTML = `
          <div class="cat-header" tabindex="0" role="button" aria-expanded="true">
            <button class="cat-icon-btn cat-delete" title="Delete" aria-label="Delete category">üóë</button>
            <input class="cat-title-input" type="text" placeholder="Click to rename" value="${sanitizeText(name)}" maxlength="80" aria-label="Category name" />
            <button class="cat-icon-btn cat-toggle" title="Collapse" aria-label="Collapse">‚ñ¥</button>
          </div>
          <div class="cat-body"></div>
          <div class="cat-footer">0 CARDS</div>
        `;
        sortingArea.appendChild(cat);

        const header = cat.querySelector('.cat-header');
        const input = cat.querySelector('.cat-title-input');
        const delBtn = cat.querySelector('.cat-delete');
        const togBtn = cat.querySelector('.cat-toggle');

        // Prevent Backspace from deleting the whole category while typing
        input.addEventListener('keydown', (e) => { e.stopPropagation(); });
        input.addEventListener('input', () => { input.value = sanitizeText(input.value).slice(0, 80); });

        header.addEventListener('keydown', (e) => {
          if (e.target === input) return;
          if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); input.focus(); }
          else if (e.key.toLowerCase() === 'c') { e.preventDefault(); toggleCollapse(cat); }
          else if (e.key === 'Delete') { e.preventDefault(); deleteCategory(cat); } // Backspace no longer deletes
        });

        delBtn.onclick = () => deleteCategory(cat);
        togBtn.onclick = () => toggleCollapse(cat);

        new Sortable(cat.querySelector('.cat-body'), {
          group: 'cards',
          animation: 150,
          onAdd: () => updateCategoryCount(cat),
          onRemove: () => updateCategoryCount(cat)
        });

        updateStepsVisibility();
        return cat;
      }
      function attachCardKeyboard(el) {
        el.setAttribute('tabindex', '0');
        el.setAttribute('role', 'button');
        el.setAttribute('aria-label', 'Card: ' + el.textContent);
        el.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            const firstCat = sortingArea.querySelector('.category');
            if (firstCat) {
              firstCat.querySelector('.cat-body').appendChild(el);
              updateCategoryCount(firstCat);
              el.setAttribute('aria-selected', 'true');
              setTimeout(() => el.setAttribute('aria-selected', 'false'), 300);
            }
          }
        });
      }

      // Participant flow
      startSortingBtn.onclick = () => {
        const meta = {
          name: sanitizeText(pName.value),
          idNumber: sanitizeText(pId.value),
          address: sanitizeText(pAddress.value),
          course: sanitizeText(pCourse.value),
          nationality: sanitizeText(pNationality.value),
          ethnicity: sanitizeText(pEthnicity.value),
          outsideHome: sanitizeText((document.querySelector('input[name="pOutsideHome"]:checked') || {}).value || '')
        };
        if (!meta.name || !meta.idNumber || !meta.address || !meta.course || !meta.nationality || !meta.ethnicity || !meta.outsideHome) {
          alert('Please complete all fields to begin.');
          return;
        }
        participantMeta = meta;
        participantModal.classList.add('hidden');
        instructionsModal.classList.remove('hidden');
        setTimeout(() => beginSortingBtn.focus(), 0);
      };

      beginSortingBtn.onclick = async () => {
        const uid = participantView.dataset.uid;
        const studyId = participantView.dataset.studyId;
        if (!uid || !studyId) { alert('Study not loaded yet.'); return; }

        const startedAt = new Date().toISOString();
        participantView.dataset.startedAt = startedAt;
        try {
          const ref = db.ref(`users/${uid}/studies/${studyId}/results`).push();
          await ref.set({ timestamp: startedAt, participant: participantMeta, status: 'started' });
          participantView.dataset.resultKey = ref.key;
        } catch (e) {
          console.warn('Could not create started result entry:', e);
        }
        instructionsModal.classList.add('hidden');
      };

      async function loadParticipantView(uid, studyId) {
        participantStatus.textContent = 'Loading study...';
        db.ref(`users/${uid}/studies/${studyId}`).once('value').then(snap => {
          const study = snap.val();
          if (!study) { participantStudyName.textContent = 'Study unavailable'; participantStatus.textContent = 'Link invalid.'; return; }
          if (study.isPublic !== true) { participantStudyName.textContent = 'Study not published'; participantStatus.textContent = 'Ask the researcher to publish it.'; return; }

          participantStudyName.textContent = study.name || '';
          if (study.instructions) { participantInstructions.textContent = study.instructions; participantInstructions.classList.remove('hidden'); }
          else { participantInstructions.textContent = ''; participantInstructions.classList.add('hidden'); }

          availableCardsContainer.innerHTML = '';
          (study.cards || []).forEach(card => {
            const d = document.createElement('div');
            d.className = 'card';
            d.textContent = card;
            d.dataset.cardText = card;
            attachCardKeyboard(d);
            availableCardsContainer.appendChild(d);
          });

          // Left list Sortable
          new Sortable(availableCardsContainer, { group: 'cards', animation: 150 });

          // Drop anywhere in the grid to create a category
          new Sortable(sortingArea, {
            group: 'cards',
            animation: 150,
            sort: false,
            onAdd: (evt) => {
              const cardEl = evt.item;
              const idx = evt.newIndex;
              const cat = makeCategory();
              const ref = sortingArea.children[idx] || null;
              sortingArea.insertBefore(cat, ref);
              cat.querySelector('.cat-body').appendChild(cardEl);
              updateCategoryCount(cat);
              cat.querySelector('.cat-title-input').focus();
            }
          });

          // Optional helper dropzones
          new Sortable(newCategoryDropzone, {
            group: 'cards',
            animation: 150,
            onAdd: (evt) => {
              const item = evt.item;
              const cat = makeCategory();
              cat.querySelector('.cat-body').appendChild(item);
              updateCategoryCount(cat);
            }
          });
          new Sortable(newCategoryTile, {
            group: 'cards',
            animation: 150,
            onAdd: (evt) => {
              const item = evt.item;
              const cat = makeCategory();
              cat.querySelector('.cat-body').appendChild(item);
              updateCategoryCount(cat);
            }
          });

          sortingArea.innerHTML = ''; // ensure empty canvas initially
          updateStepsVisibility();

          participantView.dataset.uid = uid;
          participantView.dataset.studyId = studyId;

          participantStatus.textContent = '';
          participantModal.classList.remove('hidden');
          setTimeout(() => pName.focus(), 0);
        });
      }

      // Submit sorting
      document.getElementById('submitSortingBtn').onclick = () => {
        const uid = participantView.dataset.uid;
        const studyId = participantView.dataset.studyId;
        if (!uid || !studyId) { alert('Study not loaded yet.'); return; }
        if (!participantMeta) { alert('Please enter your details before submitting.'); participantModal.classList.remove('hidden'); return; }

        const unsorted = availableCardsContainer.querySelectorAll('.card').length;
        if (unsorted > 0) {
          alert(`Please sort all cards. ${unsorted} remaining on the left.`);
          availableCardsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }

        const cats = [];
        let firstInvalid = null;
        sortingArea.querySelectorAll('.category').forEach(cat => {
          const name = sanitizeText(cat.querySelector('.cat-title-input')?.value || '');
          const cards = [...cat.querySelectorAll('.cat-body .card')].map(c => c.dataset.cardText);
          if (cards.length > 0) {
            if (!name && !firstInvalid) firstInvalid = cat.querySelector('.cat-title-input');
            cats.push({ name: name || 'Unnamed', cards });
          }
        });

        if (firstInvalid) {
          alert('Please name all categories.');
          firstInvalid.focus();
          firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }
        if (cats.length === 0) { alert('Please sort at least one card.'); return; }

        const startedAt = participantView.dataset.startedAt || null;
        const now = new Date();
        const data = {
          participant: participantMeta,
          categories: cats,
          status: 'completed',
          completedAt: now.toISOString()
        };
        if (startedAt) data.durationMs = now.getTime() - new Date(startedAt).getTime();

        const resultsRef = db.ref(`users/${uid}/studies/${studyId}/results`);
        const key = participantView.dataset.resultKey;
        const p = key ? resultsRef.child(key).update(data) : resultsRef.push({ timestamp: now.toISOString(), ...data });

        p.then(() => { participantView.innerHTML = '<h2>Thank you!</h2><p>Your responses have been recorded.</p>'; })
         .catch(e => alert(e.message));
      };

      // Results + sharing
      function setupShareControls(uid, studyId, study) {
        shareSection.classList.remove('hidden');
        toggleResultsPublic.checked = Boolean(study.resultsPublic);
        publicResultsLink.value = makePublicResultsLink(uid, studyId);
        publicResultsLinkRow.classList.toggle('hidden', !toggleResultsPublic.checked);

        toggleResultsPublic.onchange = async () => {
          const val = toggleResultsPublic.checked;
          publicResultsLinkRow.classList.toggle('hidden', !val);
          try { await db.ref(`users/${uid}/studies/${studyId}/resultsPublic`).set(val); }
          catch (e) { alert('Failed to update sharing setting: ' + e.message); }
        };
        copyPublicResultsBtn.onclick = async () => {
          try { await navigator.clipboard.writeText(publicResultsLink.value); alert('Public results link copied!'); }
          catch { publicResultsLink.select(); document.execCommand('copy'); alert('Link copied!'); }
        };
      }

      function viewResults(uid, studyId) {
        db.ref(`users/${uid}/studies/${studyId}`).once('value').then(snap => {
          const study = snap.val();
          resultsStudyName.textContent = study?.name || '';
          setupShareControls(uid, studyId, study || {});
          db.ref(`users/${uid}/studies/${studyId}/results`).once('value').then(snap2 => {
            buildResultsUI(study || {}, snap2.val() || {}, uid, studyId, { publicViewer: false });
          });
        });
      }

      function loadPublicResults(uid, studyId) {
        shareSection.classList.add('hidden');
        db.ref(`users/${uid}/studies/${studyId}`).once('value').then(snap => {
          const study = snap.val();
          resultsStudyName.textContent = study?.name || '';
          if (!study || study.resultsPublic !== true) {
            participantsSummary.textContent = 'These results are not publicly available.';
            participantsDetails.innerHTML = '';
            categoriesSummary.textContent = '';
            categoriesChart.innerHTML = '';
            categoriesLabels.innerHTML = '';
            matrixMeta.textContent = '';
            matrixTableWrap.innerHTML = '';
            // Ensure default tab is selected
            activateTab('participants');
            return;
          }
          db.ref(`users/${uid}/studies/${studyId}/results`).once('value').then(snap2 => {
            buildResultsUI(study, snap2.val() || {}, uid, studyId, { publicViewer: true });
          });
        });
      }

      function buildResultsUI(study, resultsObj, uid, studyId, opts) {
        const arr0 = Object.values(resultsObj || {});
        let arr = arr0;
        lastResultsCache = null;
        downloadCsvBtn.disabled = true;
        downloadMatrixBtn.disabled = true;

        if (arr.length === 0) {
          participantsSummary.textContent = 'No results yet.';
          participantsDetails.innerHTML = '';
          categoriesSummary.textContent = '';
          categoriesChart.innerHTML = '';
          categoriesLabels.innerHTML = '';
          matrixMeta.textContent = '';
          matrixTableWrap.innerHTML = '';
          show(resultsView);
          activateTab('participants'); // default tab
          return;
        }

        arr = arr.sort((a, b) => new Date(a.timestamp || 0) - new Date(b.timestamp || 0));

        const completed = arr.filter(r => r.status === 'completed' || Array.isArray(r.categories));
        const startedCount = arr.length;
        const completedCount = completed.length;

        const durations = completed.map(r => r.durationMs).filter(v => typeof v === 'number' && isFinite(v) && v >= 0);
        const avgDurationMs = durations.length ? Math.round(durations.reduce((a, b) => a + b, 0) / durations.length) : null;

        participantsSummary.textContent = `Started: ${startedCount} | Completed: ${completedCount} | Avg sorting time: ${avgDurationMs != null ? formatDuration(avgDurationMs) + ` (n=${durations.length})` : 'N/A'}`;

        participantsDetails.innerHTML = '';
        completed.forEach((res, i) => {
          const w = document.createElement('div');
          const h4 = document.createElement('h4');
          const pinfo = res.participant || {};
          const dn = pinfo.name ? ` ‚Äî ${pinfo.name}` : '';
          h4.textContent = `Participant ${i + 1}${dn}`;
          w.appendChild(h4);

          const meta = document.createElement('div');
          meta.className = 'muted';
          meta.textContent = [
            pinfo.idNumber ? `ID: ${pinfo.idNumber}` : '',
            pinfo.course ? `Course: ${pinfo.course}` : '',
            pinfo.nationality ? `Nationality: ${pinfo.nationality}` : '',
            pinfo.ethnicity ? `Ethnicity: ${pinfo.ethnicity}` : '',
            pinfo.outsideHome ? `Home outside Suva/Nausori: ${pinfo.outsideHome}` : '',
            res.completedAt ? `Completed: ${new Date(res.completedAt).toLocaleString()}` :
              (res.timestamp ? `Time: ${new Date(res.timestamp).toLocaleString()}` : ''),
            typeof res.durationMs === 'number' ? `Duration: ${formatDuration(res.durationMs)}` : ''
          ].filter(Boolean).join(' | ');
          if (meta.textContent) w.appendChild(meta);

          (res.categories || []).forEach(cat => {
            const p = document.createElement('p');
            const strong = document.createElement('strong');
            strong.textContent = cat.name || 'Unnamed';
            p.appendChild(strong);
            p.append(' ');
            (cat.cards || []).forEach(c => {
              const chip = document.createElement('span');
              chip.className = 'category-card';
              chip.textContent = c;
              p.appendChild(chip);
              p.append(' ');
            });
            w.appendChild(p);
          });

          participantsDetails.appendChild(w);
        });

        // Categories tab
        const catsPer = completed.map(r => (r.categories || []).length);
        const avgCats = catsPer.length ? (catsPer.reduce((a, b) => a + b, 0) / catsPer.length) : 0;
        categoriesSummary.textContent = `Average number of categories: ${avgCats.toFixed(2)} (n=${completedCount})`;
        const dist = new Map();
        catsPer.forEach(n => dist.set(n, (dist.get(n) || 0) + 1));
        const maxBuckets = dist.size ? Math.max(...dist.keys()) : 0;
        categoriesChart.innerHTML = '';
        categoriesLabels.innerHTML = '';
        if (maxBuckets > 0) {
          const counts = [];
          for (let i = 1; i <= maxBuckets; i++) counts.push(dist.get(i) || 0);
          const peak = Math.max(...counts, 1);
          counts.forEach((count, idx) => {
            const bar = document.createElement('div');
            bar.className = 'bar';
            bar.style.height = Math.round((count / peak) * 100) + '%';
            const val = document.createElement('span');
            val.textContent = count;
            bar.appendChild(val);
            categoriesChart.appendChild(bar);

            const xl = document.createElement('div');
            xl.className = 'xlabel';
            xl.textContent = String(idx + 1);
            categoriesLabels.appendChild(xl);
          });
        } else {
          const p = document.createElement('p');
          p.textContent = 'No completed participants yet.';
          categoriesChart.appendChild(p);
        }

        // Similarity matrix (percentages)
        matrixMeta.innerHTML = '';
        matrixTableWrap.innerHTML = '';
        const cards = study?.cards || [];
        const matrixCounts = {};
        cards.forEach(a => { matrixCounts[a] = {}; cards.forEach(b => matrixCounts[a][b] = 0); });
        completed.forEach(r => {
          (r.categories || []).forEach(cat => {
            const cs = cat.cards || [];
            cs.forEach(a => cs.forEach(b => { if (a !== b) matrixCounts[a][b] += 1; }));
          });
        });

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        const hr = document.createElement('tr');
        hr.appendChild(document.createElement('th'));
        cards.forEach(c => { const th = document.createElement('th'); th.textContent = c; hr.appendChild(th); });
        thead.appendChild(hr);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        cards.forEach(a => {
          const tr = document.createElement('tr');
          const rh = document.createElement('th'); rh.textContent = a;
          tr.appendChild(rh);
          cards.forEach(b => {
            const td = document.createElement('td');
            if (a === b) td.textContent = '‚Äî';
            else {
              const pct = completedCount ? (matrixCounts[a][b] / completedCount * 100) : 0;
              td.textContent = `${pct.toFixed(0)}%`;
              td.title = `${matrixCounts[a][b]} of ${completedCount} participants`;
            }
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        matrixTableWrap.appendChild(table);

        const mm = document.createElement('p');
        mm.textContent = `Percentages are of completed participants (n=${completedCount}).`;
        matrixMeta.appendChild(mm);

        lastResultsCache = { arr, completed, completedCount, study, uid, studyId, cards, matrixCounts };
        if (!opts.publicViewer) { downloadCsvBtn.disabled = false; downloadMatrixBtn.disabled = false; }

        show(resultsView);
        activateTab('participants'); // default tab on open
      }

      // CSV exports
      downloadCsvBtn.onclick = () => {
        if (!lastResultsCache) { alert('No results to export.'); return; }
        const { arr, study } = lastResultsCache;
        const studyName = (study?.name || 'study').replace(/[^\w\-]+/g, '_');
        const headers = ['Participant #','Timestamp','Name','ID Number','Address','Course','Nationality','Ethnicity','HomeOutsideSuvaNausori','Category','Card'];
        const lines = [headers.join(',')];
        let idx = 0;
        arr.forEach(res => {
          if (!(res.status === 'completed' || Array.isArray(res.categories))) return;
          idx += 1;
          const p = res.participant || {};
          const ts = res.timestamp || res.completedAt || '';
          (res.categories || []).forEach(cat => {
            const catName = sanitizeText(cat.name || 'Unnamed') || 'Unnamed';
            (cat.cards || []).forEach(card => {
              lines.push([csvEscape(idx),csvEscape(ts),csvEscape(p.name || ''),csvEscape(p.idNumber || ''),csvEscape(p.address || ''),csvEscape(p.course || ''),csvEscape(p.nationality || ''),csvEscape(p.ethnicity || ''),csvEscape(p.outsideHome || ''),csvEscape(catName),csvEscape(card)].join(','));
            });
          });
        });
        downloadCSV(`${studyName}_results.csv`, lines.join('\n'));
      };

      downloadMatrixBtn.onclick = () => {
        if (!lastResultsCache) { alert('No matrix to export.'); return; }
        const { study, cards, matrixCounts, completedCount } = lastResultsCache;
        const studyName = (study?.name || 'study').replace(/[^\w\-]+/g, '_');
        const head = [''].concat(cards).map(csvEscape).join(',');
        const lines = [head];
        cards.forEach(a => {
          const row = [csvEscape(a)];
          cards.forEach(b => {
            if (a === b) row.push('');
            else {
              const pct = completedCount ? (matrixCounts[a][b] / completedCount * 100) : 0;
              row.push(csvEscape(pct.toFixed(0) + '%'));
            }
          });
          lines.push(row.join(','));
        });
        downloadCSV(`${studyName}_similarity_matrix.csv`, lines.join('\n'));
      };

      // Initial route fallback
      if (isPublicResultsLink) { show(resultsView); loadPublicResults(pUid, pStudyId); }
      else if (hasParticipantLink) { show(participantView); loadParticipantView(pUid, pStudyId); }
    });
  </script>
</body>
</html>

