<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Open Card Sorting Tool - Researcher Accounts</title>
  <style>
    :root {
      --primary:#4a6fa5;
      --secondary:#6b8cae;
      --accent:#ff6b6b;
      --light:#f8f9fa;
      --dark:#343a40;
      --success:#28a745;
      --border:#dee2e6;
    }

    * { box-sizing:border-box; margin:0; padding:0; font-family:'Segoe UI', system-ui, -apple-system, Roboto, Arial, sans-serif }

    body { background:#f5f7fa; color:var(--dark); line-height:1.5 }

    .container { max-width:1200px; margin:0 auto; padding:20px }

    header { background:var(--primary); color:white; padding:1rem; text-align:center; margin-bottom:2rem; border-radius:5px }

    .view { display:none; background:white; padding:2rem; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.1); margin-bottom:2rem }
    .active { display:block }

    .btn { padding:.5rem 1rem; background:var(--primary); color:white; border:none; border-radius:4px; cursor:pointer; margin:.25rem; touch-action:manipulation }
    .btn:hover { background:var(--secondary) }
    .btn:disabled { opacity:.6; cursor:not-allowed }
    .btn-success { background:var(--success) }
    .btn-accent { background:var(--accent); color:#fff }
    .btn-accent:hover { filter:brightness(0.95) }

    .hidden { display:none !important }

    label { display:block; margin:.25rem 0 .25rem; font-weight:600 }
    input, textarea {
      width:100%; padding:.5rem; margin-bottom:1rem; border:1px solid var(--border); border-radius:4px;
    }

    .study-item {
      border:1px solid var(--border); padding:.75rem; margin-bottom:.5rem;
      display:flex; justify-content:space-between; align-items:center; gap:.5rem; flex-wrap:wrap;
    }
    .study-actions { display:flex; gap:.25rem; flex-wrap:wrap }

    .instructions { background:#e9ecef; padding:1rem; margin-bottom:1rem; border-radius:4px }

    .card-pool h3 { margin: .5rem 0 }

    .category-card { background:#eee; padding:.25rem .5rem; border-radius:4px; margin:.25rem; display:inline-block }

    .table-wrap { overflow:auto; margin-top:1rem; border:1px solid var(--border); border-radius:6px }
    table { border-collapse:collapse; min-width:600px; width:100% }
    th, td { border:1px solid var(--border); padding:.5rem; text-align:center; white-space:nowrap }

    .card { background:white; border:1px solid var(--border); padding:1rem; margin:.25rem; border-radius:4px; cursor:grab; user-select:none }
    .card:active { cursor:grabbing }

    .category {
      background:var(--light); border:2px dashed var(--secondary);
      border-radius:8px; padding:1rem; margin:1rem 0
    }

    .dropzone {
      background:#fff; border:1px dashed var(--border);
      border-radius:6px; min-height:48px; padding:.5rem; margin-top:.5rem
    }

    .muted { color:#6c757d }
    .badge { display:inline-block; padding:.1rem .4rem; border-radius:.25rem; font-size:.8rem; background:#edf2ff; color:#2f4e8b; border:1px solid #dbe4ff }

    /* Modal (participant info) */
    .modal-backdrop {
      position:fixed; inset:0; background:rgba(0,0,0,.5);
      display:flex; align-items:center; justify-content:center;
      z-index:9999; padding:1rem;
    }
    .modal {
      background:#fff; border-radius:10px; width:min(640px, 100%); padding:1.25rem 1.25rem 1rem;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .modal h3 { margin-bottom:.5rem }
    .modal p { margin:.25rem 0 1rem }
    .modal .actions { display:flex; justify-content:flex-end; gap:.5rem; margin-top:.25rem }
    fieldset { border:1px solid var(--border); border-radius:6px; padding:.75rem; margin-bottom:1rem }
    legend { padding:0 .25rem; font-weight:600 }
    .radio-row { display:flex; gap:1rem; margin-top:.5rem }
    .radio-row label { font-weight:500; margin:0; display:flex; align-items:center; gap:.35rem }
  </style>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <!-- SortableJS (load + fallback) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <header><h1>Open Card Sorting Tool</h1></header>

    <!-- Login / Signup -->
    <div id="authView" class="view active">
      <h2 id="authHeading">Researcher Login</h2>
      <form id="authForm" novalidate>
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="name@example.com" autocomplete="username" inputmode="email" required>

        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Password" autocomplete="current-password" required>

        <div>
          <button id="loginBtn" type="submit" class="btn">Login</button>
          <button id="signupBtn" type="button" class="btn btn-accent">Sign Up</button>
        </div>
      </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboardView" class="view">
      <h2>Dashboard</h2>
      <div>
        <button id="createStudyBtn" class="btn">Create New Study</button>
        <button id="migrateBtn" class="btn btn-accent">Migrate My Old Studies</button>
        <button id="logoutBtn" class="btn btn-accent">Logout</button>
      </div>
      <h3>Your Studies</h3>
      <div id="studiesList" aria-live="polite"></div>
    </div>

    <!-- Create Study -->
    <div id="setupView" class="view">
      <h2>Create a New Study</h2>
      <label for="studyName">Study name</label>
      <input type="text" id="studyName" placeholder="e.g., Information Architecture Test" required>

      <label for="cardsInput">Cards (one per line)</label>
      <textarea id="cardsInput" rows="8" placeholder="Card 1&#10;Card 2&#10;Card 3" required></textarea>

      <label for="instructionsInput">Instructions (optional)</label>
      <textarea id="instructionsInput" rows="4" placeholder="Describe what participants should do..."></textarea>

      <div>
        <button id="saveStudyBtn" class="btn btn-success">Save Study</button>
        <button id="cancelCreateBtn" class="btn">Cancel</button>
      </div>
    </div>

    <!-- Share Link -->
    <div id="studyCreatedView" class="view">
      <h2>Study Created!</h2>
      <label for="studyLink">Share this link with participants</label>
      <input type="text" id="studyLink" readonly>
      <div>
        <button id="copyLinkBtn" class="btn">Copy Link</button>
        <button id="backToDashboardBtn" class="btn">Back to Dashboard</button>
      </div>
    </div>

    <!-- Participant -->
    <div id="participantView" class="view">
      <h2 id="participantStudyName"></h2>
      <div id="participantInstructions" class="instructions hidden" aria-live="polite"></div>

      <div id="participantStatus" class="muted"></div>

      <div class="card-pool">
        <h3>Cards</h3>
        <div id="availableCards"></div>
      </div>

      <div id="sortingArea"></div>

      <div>
        <button id="addCategoryBtn" class="btn">Add Category</button>
        <button id="submitSortingBtn" class="btn btn-success">Submit</button>
      </div>
    </div>

    <!-- Participant Info Modal -->
    <div id="participantModal" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="participantModalTitle">
      <div class="modal">
        <h3 id="participantModalTitle">Before you begin</h3>
        <p>Please enter your details to proceed.</p>

        <label for="pName">Full name</label>
        <input id="pName" type="text" placeholder="Your name" required>

        <label for="pId">ID number</label>
        <input id="pId" type="text" placeholder="Your ID number" required>

        <label for="pAddress">Address</label>
        <textarea id="pAddress" rows="3" placeholder="Your address" required></textarea>

        <label for="pCourse">Course</label>
        <input id="pCourse" type="text" placeholder="Your course" required>

        <label for="pNationality">Nationality</label>
        <input id="pNationality" type="text" placeholder="Your nationality" required>

        <label for="pEthnicity">Ethnicity</label>
        <input id="pEthnicity" type="text" placeholder="Your ethnicity" required>

        <fieldset>
          <legend>Is your family home outside of Suva/Nausori? (Yes/No)</legend>
          <div class="radio-row">
            <label><input type="radio" name="pOutsideHome" value="Yes" required> Yes</label>
            <label><input type="radio" name="pOutsideHome" value="No" required> No</label>
          </div>
        </fieldset>

        <div class="actions">
          <button id="startSortingBtn" class="btn btn-success">Start Sorting</button>
        </div>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsView" class="view">
      <h2>Study Results: <span id="resultsStudyName"></span></h2>
      <div id="resultsContainer"></div>
      <div id="aggregateResults"></div>
      <div>
        <button id="downloadCsvBtn" class="btn">Download CSV</button>
        <button id="backToDashboardFromResultsBtn" class="btn">Back to Dashboard</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAu1hawycY2uQgzWolaHeTfCdWtSWux7XA",
    authDomain: "card-sorting-tool-762a3.firebaseapp.com",
    databaseURL: "https://card-sorting-tool-762a3-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "card-sorting-tool-762a3",
    storageBucket: "card-sorting-tool-762a3.firebasestorage.app",
    messagingSenderId: "361630774945",
    appId: "1:361630774945:web:402edb363d388a61baa2e0",
    measurementId: "G-BGV3P2HQZP"
  };

  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // DOM refs
  const authView = document.getElementById('authView');
  const dashboardView = document.getElementById('dashboardView');
  const setupView = document.getElementById('setupView');
  const studyCreatedView = document.getElementById('studyCreatedView');
  const participantView = document.getElementById('participantView');
  const resultsView = document.getElementById('resultsView');

  const studyNameInput = document.getElementById('studyName');
  const cardsInput = document.getElementById('cardsInput');
  const instructionsInput = document.getElementById('instructionsInput');
  const studyLinkInput = document.getElementById('studyLink');

  const studiesList = document.getElementById('studiesList');
  const availableCardsContainer = document.getElementById('availableCards');
  const sortingArea = document.getElementById('sortingArea');
  const participantStudyName = document.getElementById('participantStudyName');
  const participantInstructions = document.getElementById('participantInstructions');
  const participantStatus = document.getElementById('participantStatus');
  const resultsStudyName = document.getElementById('resultsStudyName');
  const resultsContainer = document.getElementById('resultsContainer');
  const aggregateResults = document.getElementById('aggregateResults');

  const authForm = document.getElementById('authForm');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');

  // Participant modal refs
  const participantModal = document.getElementById('participantModal');
  const pName = document.getElementById('pName');
  const pId = document.getElementById('pId');
  const pAddress = document.getElementById('pAddress');
  const pCourse = document.getElementById('pCourse');
  const pNationality = document.getElementById('pNationality');
  const pEthnicity = document.getElementById('pEthnicity');
  const startSortingBtn = document.getElementById('startSortingBtn');

  // Results export
  const downloadCsvBtn = document.getElementById('downloadCsvBtn');

  // Participant link handling
  const params = new URLSearchParams(location.search);
  const pUid = params.get('uid');
  const pStudyId = params.get('study');
  const hasParticipantLink = Boolean(pUid && pStudyId);

  // In-memory caches
  let participantMeta = null; // {name, idNumber, address, course, nationality, ethnicity, outsideHome}
  let lastResultsCache = null; // {arr, study, uid, studyId}

  // Helpers
  function show(view) {
    [authView, dashboardView, setupView, studyCreatedView, participantView, resultsView].forEach(v => v.classList.remove('active'));
    view.classList.add('active');
  }

  function makeShareLink(uid, studyId) {
    const base = new URL(window.location.href);
    base.search = '';
    base.hash = '';
    return `${base.toString()}?uid=${uid}&study=${studyId}`;
  }

  function loadScriptOnce(src) {
    return new Promise((resolve, reject) => {
      const existing = [...document.scripts].some(s => s.src === src);
      if (existing) { resolve(); return; }
      const s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.onload = resolve;
      s.onerror = reject;
      document.head.appendChild(s);
    });
  }

  async function ensureSortableLoaded() {
    if (window.Sortable) return;
    try {
      await loadScriptOnce('https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js');
    } catch (e) {
      console.warn('Failed to load SortableJS dynamically:', e);
    }
  }

  function initPendingDropzones() {
    const zones = sortingArea.querySelectorAll('.dropzone[data-needs-sortable="1"]');
    zones.forEach(zone => {
      if (window.Sortable) {
        new Sortable(zone, { group: 'shared', animation: 150 });
        zone.removeAttribute('data-needs-sortable');
      }
    });
  }

  function openParticipantModal() {
    participantModal.classList.remove('hidden');
    setTimeout(() => pName.focus(), 0);
  }
  function closeParticipantModal() {
    participantModal.classList.add('hidden');
  }

  // CSV helpers
  function csvEscape(v) {
    const s = (v == null ? '' : String(v));
    if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
    return s;
  }
  function downloadCSV(filename, text) {
    const blob = new Blob(["\ufeff" + text], { type: "text/csv;charset=utf-8;" });
    if (navigator.msSaveBlob) {
      navigator.msSaveBlob(blob, filename);
    } else {
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.href = url;
      link.download = filename;
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 0);
    }
  }

  // Auth actions
  async function doLogin() {
    try {
      await auth.signInWithEmailAndPassword(emailInput.value.trim(), passwordInput.value);
    } catch (e) {
      alert(e.message);
    }
  }
  async function doSignup() {
    try {
      await auth.createUserWithEmailAndPassword(emailInput.value.trim(), passwordInput.value);
    } catch (e) {
      alert(e.message);
    }
  }

  authForm.addEventListener('submit', (e) => {
    e.preventDefault();
    doLogin();
  });
  document.getElementById('loginBtn').onclick = doLogin;
  document.getElementById('signupBtn').onclick = doSignup;
  document.getElementById('logoutBtn').onclick = () => auth.signOut();

  // Create study flow (publish by default so participant links work immediately)
  document.getElementById('createStudyBtn').onclick = () => {
    show(setupView);
    setTimeout(() => studyNameInput.focus(), 0);
  };
  document.getElementById('cancelCreateBtn').onclick = () => {
    show(dashboardView);
    document.getElementById('createStudyBtn').focus();
  };
  document.getElementById('saveStudyBtn').onclick = () => {
    const user = auth.currentUser;
    if (!user) { alert('You must be logged in to save a study.'); return; }

    const name = studyNameInput.value.trim();
    const cards = cardsInput.value
      .split('\n')
      .map(l => l.trim())
      .filter(Boolean);

    if (!name || cards.length === 0) { alert('Enter name and at least one card'); return; }

    const studyId = 'study_' + Date.now();
    const study = {
      id: studyId,
      name,
      cards,
      instructions: instructionsInput.value.trim(),
      createdAt: new Date().toISOString(),
      ownerUid: user.uid,
      isPublic: true // publish by default
    };

    db.ref(`users/${user.uid}/studies/${studyId}`).set(study).then(() => {
      const link = makeShareLink(user.uid, studyId);
      studyLinkInput.value = link;
      show(studyCreatedView);
      document.getElementById('copyLinkBtn').focus();
    }).catch(err => alert(err.message));
  };

  document.getElementById('backToDashboardBtn').onclick = () => {
    show(dashboardView);
  };
  document.getElementById('copyLinkBtn').onclick = async () => {
    try {
      await navigator.clipboard.writeText(studyLinkInput.value);
      alert('Link copied!');
    } catch {
      studyLinkInput.select();
      document.execCommand('copy');
      alert('Link copied!');
    }
  };

  document.getElementById('backToDashboardFromResultsBtn').onclick = () => {
    show(dashboardView);
  };

  // Participant controls
  document.getElementById('addCategoryBtn').onclick = () => addCategory();
  document.getElementById('submitSortingBtn').onclick = () => submitSorting();

  // Handle modal submit
  document.getElementById('startSortingBtn').onclick = () => {
    const name = pName.value.trim();
    const idNumber = pId.value.trim();
    const address = pAddress.value.trim();
    const course = pCourse.value.trim();
    const nationality = pNationality.value.trim();
    const ethnicity = pEthnicity.value.trim();
    const outsideHome = (document.querySelector('input[name="pOutsideHome"]:checked') || {}).value || '';

    if (!name || !idNumber || !address || !course || !nationality || !ethnicity || !outsideHome) {
      alert('Please complete all fields to begin.');
      return;
    }
    participantMeta = { name, idNumber, address, course, nationality, ethnicity, outsideHome };
    closeParticipantModal();
  };

  // Migration (client-side)
  async function migrateOldStudiesToUser(uid) {
    try {
      const snap = await db.ref('studies').orderByChild('ownerUid').equalTo(uid).once('value');
      const oldStudies = snap.val() || {};
      const ids = Object.keys(oldStudies);
      if (!ids.length) { alert('No old studies found under /studies for this account.'); return; }

      const updates = {};
      ids.forEach(studyId => {
        updates[`users/${uid}/studies/${studyId}`] = oldStudies[studyId];
        // Optional: remove old copies after successful migration:
        // updates[`studies/${studyId}`] = null;
      });

      await db.ref().update(updates);
      alert('Migration completed! Reload the dashboard to see your studies.');
    } catch (err) {
      console.error('Migration error:', err);
      alert('Migration failed: ' + err.message);
    }
  }

  document.getElementById('migrateBtn').onclick = () => {
    const user = auth.currentUser;
    if (!user) { alert('You must be logged in as a researcher to migrate.'); return; }
    migrateOldStudiesToUser(user.uid);
  };

  // Auth state change
  auth.onAuthStateChanged(user => {
    if (hasParticipantLink) {
      // Keep participant view visible for participants regardless of auth state
      show(participantView);
      return;
    }
    if (user) {
      show(dashboardView);
      showDashboard(user.uid);
      document.getElementById('createStudyBtn').focus();
    } else {
      show(authView);
      document.getElementById('email').focus();
    }
  });

  // Dashboard
  function showDashboard(uid) {
    studiesList.textContent = '';
    const seen = new Set();

    // New-format studies
    db.ref(`users/${uid}/studies`).once('value').then(snap => {
      const data = snap.val() || {};
      Object.entries(data).forEach(([studyId, study]) => {
        if (seen.has(studyId)) return;
        addStudyToDashboard(uid, studyId, study);
        seen.add(studyId);
      });
    });

    // Old-format studies (ownerUid filter)
    db.ref('studies').orderByChild('ownerUid').equalTo(uid).once('value').then(snap => {
      const data = snap.val() || {};
      Object.entries(data).forEach(([studyId, study]) => {
        if (seen.has(studyId)) return;
        addStudyToDashboard(uid, studyId, study);
        seen.add(studyId);
      });
    });
  }

  function addStudyToDashboard(uid, studyId, study) {
    const div = document.createElement('div');
    div.className = 'study-item';

    const left = document.createElement('div');
    const title = document.createElement('div');
    title.textContent = study.name || '(Untitled study)';
    const pub = document.createElement('div');
    pub.className = 'muted';
    pub.innerHTML = `<span class="badge">${study.isPublic ? 'Published' : 'Unpublished'}</span>`;

    left.appendChild(title);
    left.appendChild(pub);

    const actions = document.createElement('div');
    actions.className = 'study-actions';

    const shareBtn = document.createElement('button');
    shareBtn.className = 'btn';
    shareBtn.textContent = 'Share Link';
    shareBtn.onclick = async () => {
      const link = makeShareLink(uid, studyId);
      try {
        await navigator.clipboard.writeText(link);
        alert('Link copied to clipboard.');
      } catch {
        prompt('Copy this link:', link);
      }
    };

    const publishBtn = document.createElement('button');
    publishBtn.className = 'btn';
    publishBtn.textContent = study.isPublic ? 'Unpublish' : 'Publish';
    publishBtn.onclick = async () => {
      const newVal = !Boolean(study.isPublic);
      await db.ref(`users/${uid}/studies/${studyId}/isPublic`).set(newVal);
      study.isPublic = newVal;
      publishBtn.textContent = newVal ? 'Unpublish' : 'Publish';
      pub.innerHTML = `<span class="badge">${newVal ? 'Published' : 'Unpublished'}</span>`;
    };

    const resultsBtn = document.createElement('button');
    resultsBtn.className = 'btn btn-success';
    resultsBtn.textContent = 'Results';
    resultsBtn.onclick = () => viewResults(uid, studyId);

    actions.appendChild(shareBtn);
    actions.appendChild(publishBtn);
    actions.appendChild(resultsBtn);

    div.appendChild(left);
    div.appendChild(actions);
    studiesList.appendChild(div);
  }

  // Participant loading
  if (hasParticipantLink) {
    show(participantView);
    participantStudyName.textContent = 'Loading study...';
    participantStatus.textContent = 'Please wait while we prepare your card sort.';
    loadParticipantView(pUid, pStudyId);
  }

  function addCategory() {
    const wrapper = document.createElement('div');
    wrapper.className = 'category';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'category-name';
    input.placeholder = 'Category name';
    input.setAttribute('aria-label', 'Category name');

    const zone = document.createElement('div');
    zone.className = 'dropzone';

    wrapper.appendChild(input);
    wrapper.appendChild(zone);
    sortingArea.appendChild(wrapper);

    // Initialize Sortable if available; otherwise mark for later init
    if (window.Sortable) {
      new Sortable(zone, { group:'shared', animation:150 });
    } else {
      zone.setAttribute('data-needs-sortable', '1');
    }
  }

  async function loadParticipantView(uid, studyId) {
    participantStatus.textContent = 'Loading study...';

    db.ref(`users/${uid}/studies/${studyId}`).once('value')
      .then(async snap => {
        const study = snap.val();
        if (!study) {
          participantStudyName.textContent = 'Study unavailable';
          participantStatus.textContent = 'This study could not be found. Please check the link with the researcher.';
          return;
        }
        if (study.isPublic !== true) {
          participantStudyName.textContent = 'Study not published';
          participantStatus.textContent = 'This study is currently not available to participants. Please contact the researcher.';
          return;
        }

        try {
          // Title and instructions
          participantStudyName.textContent = study.name || '';
          if (study.instructions) {
            participantInstructions.textContent = study.instructions;
            participantInstructions.classList.remove('hidden');
          } else {
            participantInstructions.textContent = '';
            participantInstructions.classList.add('hidden');
          }

          // Cards
          availableCardsContainer.innerHTML = '';
          (study.cards || []).forEach(card => {
            const d = document.createElement('div');
            d.className = 'card';
            d.textContent = card;
            d.dataset.cardText = card;
            availableCardsContainer.appendChild(d);
          });

          // Category area
          sortingArea.innerHTML = '';
          addCategory();

          // Ensure Sortable is loaded, then init all containers
          await ensureSortableLoaded();
          if (window.Sortable) {
            try {
              new Sortable(availableCardsContainer, { group:'shared', animation:150 });
            } catch (e) {
              console.warn('Failed to init Sortable for available cards:', e);
            }
            initPendingDropzones(); // in case first category was created before Sortable loaded
          } else {
            console.warn('SortableJS not available; drag-and-drop disabled.');
          }

          participantView.dataset.uid = uid;
          participantView.dataset.studyId = studyId;

          participantStatus.textContent = ''; // clear status on success

          // Force participant info collection before sorting
          participantMeta = null;
          openParticipantModal();

        } catch (renderErr) {
          console.error('Render error:', renderErr);
          participantStatus.textContent = 'Something went wrong while rendering the study. Please refresh the page.';
        }
      })
      .catch(err => {
        console.error('DB read failed:', err);
        participantStudyName.textContent = 'Unable to load study';
        participantStatus.textContent = 'This study is not publicly accessible. Ask the researcher to publish it.';
      });
  }

  function submitSorting() {
    const uid = participantView.dataset.uid;
    const studyId = participantView.dataset.studyId;

    if (!uid || !studyId) { alert('Study not loaded yet.'); return; }
    if (!participantMeta) { alert('Please enter your details before submitting.'); openParticipantModal(); return; }

    const cats = [];
    sortingArea.querySelectorAll('.category').forEach(c => {
      const name = (c.querySelector('.category-name')?.value || '').trim() || 'Unnamed';
      const cards = [...c.querySelectorAll('.card')].map(card => card.dataset.cardText);
      if (cards.length > 0) cats.push({ name, cards });
    });

    if (cats.length === 0) { alert('Please sort at least one card.'); return; }

    const result = {
      timestamp: new Date().toISOString(),
      participant: participantMeta,
      categories: cats
    };
    db.ref(`users/${uid}/studies/${studyId}/results`).push(result).then(() => {
      participantView.innerHTML = '<h2>Thank you!</h2><p>Your responses have been recorded.</p>';
    }).catch(err => alert(err.message));
  }

  // Results
  function viewResults(uid, studyId) {
    db.ref(`users/${uid}/studies/${studyId}`).once('value').then(snap => {
      const study = snap.val();
      resultsStudyName.textContent = study?.name || '';

      db.ref(`users/${uid}/studies/${studyId}/results`).once('value').then(snap2 => {
        const results = snap2.val() || {};
        resultsContainer.innerHTML = '';
        aggregateResults.innerHTML = '';
        lastResultsCache = null;
        downloadCsvBtn.disabled = true;

        let arr = Object.values(results);
        if (arr.length === 0) {
          const p = document.createElement('p');
          p.textContent = 'No results yet.';
          resultsContainer.appendChild(p);
          show(resultsView);
          return;
        }

        // Sort by timestamp ascending if available
        arr = arr.sort((a, b) => new Date(a.timestamp || 0) - new Date(b.timestamp || 0));

        // Cache for CSV export
        lastResultsCache = { arr, study, uid, studyId };
        downloadCsvBtn.disabled = false;

        // Render each participant safely
        arr.forEach((res, i) => {
          const wrapper = document.createElement('div');
          const h4 = document.createElement('h4');
          const pinfo = res.participant || {};
          const displayName = pinfo.name ? ` — ${pinfo.name}` : '';
          h4.textContent = `Participant ${i + 1}${displayName}`;
          wrapper.appendChild(h4);

          // Participant details (muted)
          const meta = document.createElement('div');
          meta.className = 'muted';
          meta.textContent = [
            pinfo.idNumber ? `ID: ${pinfo.idNumber}` : '',
            pinfo.course ? `Course: ${pinfo.course}` : '',
            pinfo.nationality ? `Nationality: ${pinfo.nationality}` : '',
            pinfo.ethnicity ? `Ethnicity: ${pinfo.ethnicity}` : '',
            pinfo.outsideHome ? `Home outside Suva/Nausori: ${pinfo.outsideHome}` : '',
            res.timestamp ? `Time: ${new Date(res.timestamp).toLocaleString()}` : ''
          ].filter(Boolean).join(' | ');
          if (meta.textContent) wrapper.appendChild(meta);

          (res.categories || []).forEach(cat => {
            const p = document.createElement('p');
            const strong = document.createElement('strong');
            strong.textContent = cat.name || 'Unnamed';
            p.appendChild(strong);
            p.append(' ');
            (cat.cards || []).forEach(c => {
              const chip = document.createElement('span');
              chip.className = 'category-card';
              chip.textContent = c;
              p.appendChild(chip);
              p.append(' ');
            });
            wrapper.appendChild(p);
          });

          resultsContainer.appendChild(wrapper);
        });

        // Aggregate co-occurrence matrix (exclude diagonal for readability)
        const cards = study?.cards || [];
        const matrix = {};
        cards.forEach(a => { matrix[a] = {}; cards.forEach(b => { matrix[a][b] = 0; }); });

        let totalCats = 0;
        arr.forEach(r => {
          const catsR = r.categories || [];
          totalCats += catsR.length;
          catsR.forEach(cat => {
            const cs = cat.cards || [];
            cs.forEach(a => cs.forEach(b => { if (a !== b) matrix[a][b] += 1; }));
          });
        });

        const meta = document.createElement('p');
        meta.textContent = `Participants: ${arr.length} | Avg categories: ${(totalCats / arr.length).toFixed(2)}`;
        aggregateResults.appendChild(meta);

        const tableWrap = document.createElement('div');
        tableWrap.className = 'table-wrap';
        const table = document.createElement('table');

        const thead = document.createElement('thead');
        const headRow = document.createElement('tr');
        headRow.appendChild(document.createElement('th'));
        cards.forEach(c => {
          const th = document.createElement('th');
          th.textContent = c;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        cards.forEach(a => {
          const tr = document.createElement('tr');
          const rowHeader = document.createElement('th');
          rowHeader.textContent = a;
          tr.appendChild(rowHeader);

          cards.forEach(b => {
            const td = document.createElement('td');
            td.textContent = (a === b) ? '-' : matrix[a][b];
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        tableWrap.appendChild(table);
        aggregateResults.appendChild(tableWrap);

        show(resultsView);
      });
    });
  }

  // CSV export click
  downloadCsvBtn.onclick = () => {
    if (!lastResultsCache) {
      alert('No results to export.');
      return;
    }
    const { arr, study } = lastResultsCache;
    const studyName = (study?.name || 'study').replace(/[^\w\-]+/g, '_');
    const headers = [
      'Participant #',
      'Timestamp',
      'Name',
      'ID Number',
      'Address',
      'Course',
      'Nationality',
      'Ethnicity',
      'HomeOutsideSuvaNausori',
      'Category',
      'Card'
    ];
    const lines = [headers.join(',')];

    arr.forEach((res, idx) => {
      const p = res.participant || {};
      const ts = res.timestamp || '';
      (res.categories || []).forEach(cat => {
        const catName = cat.name || 'Unnamed';
        (cat.cards || []).forEach(card => {
          const row = [
            csvEscape(idx + 1),
            csvEscape(ts),
            csvEscape(p.name || ''),
            csvEscape(p.idNumber || ''),
            csvEscape(p.address || ''),
            csvEscape(p.course || ''),
            csvEscape(p.nationality || ''),
            csvEscape(p.ethnicity || ''),
            csvEscape(p.outsideHome || ''),
            csvEscape(catName),
            csvEscape(card)
          ].join(',');
          lines.push(row);
        });
      });
    });

    downloadCSV(`${studyName}_results.csv`, lines.join('\n'));
  };
});
</script>
</body>
</html>
