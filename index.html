<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pasifika Open Card Sorting Tool - Researcher Accounts</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  
  <style>
    /* --- NEW MODERN UI STYLES --- */
    :root {
      --brand-primary: #ff9f1c;
      --brand-primary-dark: #f0900c;
      --bg-main: #f4f5f7;
      --bg-panel: #ffffff;
      --text-dark: #2d3748;
      --text-light: #718096;
      --border-color: #e2e8f0;
      --success: #48bb78;
      --danger: #e53e3e;
      --primary: var(--brand-primary); /* Pasifika theme override */
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { font-size: 16px; }
    body { 
      font-family: 'Poppins', 'Segoe UI', system-ui, -apple-system, Roboto, Arial, sans-serif;
      background: var(--bg-main);
      color: var(--text-dark);
      line-height: 1.6;
    }
    
    /* Hide all views by default */
    .view { display: none; }
    .view.active { display: block; }

    /* Researcher Layout */
    .researcher-layout {
      display: grid;
      grid-template-columns: 80px 1fr;
      min-height: 100vh;
    }
    .sidebar {
      background: var(--bg-panel);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1.5rem 0;
      position: sticky;
      top: 0;
      height: 100vh;
    }
    .sidebar .logo {
      width: 40px;
      height: 40px;
      background: var(--brand-primary);
      border-radius: 8px;
      margin-bottom: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
    }
    .sidebar-nav {
      list-style: none;
      width: 100%;
    }
    .sidebar-nav li a {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.75rem 0;
      color: var(--text-light);
      text-decoration: none;
      gap: 4px;
      font-size: 0.7rem;
      position: relative;
    }
    .sidebar-nav li a:hover { background: #f7fafc; }
    .sidebar-nav li a.active { color: var(--brand-primary); }
    .sidebar-nav li a.active::before {
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 4px;
      height: 24px;
      background: var(--brand-primary);
      border-radius: 0 4px 4px 0;
    }
    .sidebar-nav svg { width: 24px; height: 24px; }
    
    .main-content { padding: 2rem 3rem; }
    
    .top-nav {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      margin-bottom: 1.5rem;
      gap: 1.5rem;
    }
    .top-nav .user-profile { display: flex; align-items: center; gap: 0.5rem; }
    .top-nav .user-avatar {
      width: 32px;
      height: 32px;
      background: #cbd5e0;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--text-dark);
    }
    
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }
    .page-header h2 { font-size: 1.8rem; font-weight: 600; }
    
    .btn { 
      padding: .6rem 1.25rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all .2s ease;
    }
    .btn-brand { background: var(--brand-primary); color: white; }
    .btn-brand:hover { background: var(--brand-primary-dark); }
    .btn-secondary { background: var(--bg-panel); color: var(--text-dark); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background: #f7fafc; border-color: #cbd5e0; }
    .btn-danger { background: var(--danger); color: white; }

    /* Dashboard Study Cards */
    .studies-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 2rem;
    }
    .study-card {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.03);
    }
    .study-card-header h3 { font-size: 1.1rem; margin-bottom: 0.5rem; }
    .study-card-header .badge {
      display: inline-block;
      padding: .15rem .5rem;
      border-radius: 99px;
      font-size: .75rem;
      font-weight: 500;
      background: #e2e8f0;
      color: var(--text-light);
    }
    .study-card-header .badge.published { background: #c6f6d5; color: #2f855a; }
    .study-card-actions {
      margin-top: 1.5rem;
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .study-card-actions .btn { padding: .4rem .8rem; font-size: 0.85rem; }

    /* Study Setup View */
    .setup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .setup-header h2 { font-size: 1.5rem; }
    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 2rem;
      margin-top: 1.5rem;
    }
    .tabs { display: flex; gap: .5rem; border-bottom: 1px solid var(--border-color); }
    .tab-btn {
      background: transparent;
      border: none;
      padding: .75rem 1rem;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-light);
      border-bottom: 2px solid transparent;
      margin-bottom: -1px;
    }
    .tab-btn.active { color: var(--brand-primary); border-bottom-color: var(--brand-primary); }
    .tab-pane { display: none; padding-top: 2rem; }
    .tab-pane.active { display: block; }
    
    /* Modern Form Styling */
    .form-group {
      position: relative;
      margin-bottom: 1.5rem;
    }
    .form-group label {
      position: absolute;
      top: 1rem;
      left: 1rem;
      color: var(--text-light);
      pointer-events: none;
      transition: all 0.2s ease-out;
      background: var(--bg-panel);
      padding: 0 0.25rem;
    }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 1rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      font-family: inherit;
      background: transparent;
    }
    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 2px rgba(255, 159, 28, 0.2);
    }
    .form-group input:not(:placeholder-shown) + label,
    .form-group input:focus + label,
    .form-group textarea:not(:placeholder-shown) + label,
    .form-group textarea:focus + label {
      top: -0.6rem;
      left: 0.75rem;
      font-size: 0.8rem;
      color: var(--brand-primary);
    }
    
    /* Cards Builder (Setup) */
    .builder-wrap { border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; background: #fafafa; }
    .builder-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .builder-rows { display: flex; flex-direction: column; gap: 0.75rem; }
    .builder-row { display: grid; grid-template-columns: 1fr 1.5fr auto; gap: 0.75rem; align-items: center; }
    .builder-row input { margin: 0; padding: .6rem; }
    .row-del { background: transparent; border: none; color: var(--danger); font-size: 1.5rem; cursor: pointer; }
    .bulk-import-wrap { margin-bottom: 2rem; }
    
    /* --- PARTICIPANT VIEW STYLES (Largely unchanged, but put in a container) --- */
    .participant-container, .legacy-container { max-width: 1600px; margin: 0 auto; padding: 20px; }
    .legacy-header { background: #1177bb; color: white; padding: 1rem; text-align: center; margin-bottom: 2rem; border-radius: 5px; }
    
    .hidden { display: none !important; }
    .muted { color: #6c757d; }
    
    .card { background: white; border: 1px solid #dee2e6; padding: 1rem; margin: .25rem; border-radius: 6px; cursor: grab; user-select: none; box-shadow: 0 1px 0 rgba(0,0,0,0.05); position: relative; font-size: 1rem; }
    .info-icon { position: absolute; top: 6px; right: 6px; background: transparent; border: none; color: #6b7280; font-size: 18px; cursor: pointer; }
    .card-desc { display: none; position: absolute; z-index: 10; right: 8px; top: 28px; background: #2c2c2c; color: #fff; padding: 8px 10px; border-radius: 6px; width: 260px; max-width: 70vw; box-shadow: 0 4px 16px rgba(0,0,0,.2); font-size: .9rem; }
    .card-desc.show { display: block; }
    .workspace { display: grid; grid-template-columns: 300px 1fr 1fr 1fr; gap: 16px; align-items: start; }
    #availableCardsContainer { background: #f4f5f7; border: 1px solid #e2e8f0; border-radius: 10px; padding: 12px; position: sticky; top: 12px; max-height: calc(100vh - 180px); overflow-y: auto; }
    .cards-list { display: flex; flex-direction: column; gap: .5rem; min-height: 50px; }
    .category-columns-wrap { grid-column: 2 / 5; display: contents; }
    .category-column { min-height: 60vh; display: flex; flex-direction: column; gap: 16px; }
    .drop-zone-placeholder { border: 2px dashed #cfcfcf; border-radius: 10px; min-height: 110px; padding: 14px; background: #fafafa; display: flex; align-items: center; justify-content: center; color: #666; font-weight: 600; text-align: center; }
    .toolbar { margin-bottom: .5rem; display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; justify-content: flex-end; grid-column: 1 / -1; }
    .category { background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.06); border: 1px solid #dee2e6; overflow: hidden; }
    .cat-header { background: #2d3748; color: #fff; padding: .5rem .75rem; display: flex; align-items: center; justify-content: center; gap: .5rem; }
    .cat-title-input { background: transparent; border: none; color: #fff; font-weight: 600; text-align: center; width: 70%; outline: none; padding: .15rem .25rem; border-bottom: 1px dashed rgba(255,255,255,.35); font-size: 1.05rem; }
    .cat-body { padding: .5rem; background: #fff; margin: .5rem; border: 1px solid #dee2e6; border-radius: 8px; min-height: 80px; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 1rem; }
    .modal { background: #fff; border-radius: 10px; width: min(640px, 100%); padding: 1.25rem; box-shadow: 0 10px 30px rgba(0,0,0,.25); max-height: 90vh; overflow: auto; overscroll-behavior: contain; }
    .modal .actions { display: flex; justify-content: flex-end; gap: .5rem; margin-top: .25rem; }
    
    .results-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.95rem; }
    .results-table th, .results-table td { border: 1px solid #e2e8f0; padding: 0.75rem; text-align: left; }
    .results-table th { background-color: #f7fafc; }
  </style>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  <!-- SheetJS for Excel import -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  
  <!-- NEW: Researcher Layout Wrapper -->
  <div id="researcherLayout" class="researcher-layout hidden">
    <aside class="sidebar">
      <div class="logo" title="Pasifika Card Sort">CS</div>
      <ul class="sidebar-nav">
        <li><a href="#" class="active" id="navDashboard">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>
          Studies
        </a></li>
        <!-- Placeholder icons -->
        <li><a href="#"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 18v-5.25m0 5.25a7.5 7.5 0 001.5-6.975-1.5 1.5 0 011.085-1.462A7.5 7.5 0 0012 2.25zM12 18a7.5 7.5 0 01-1.5-6.975-1.5 1.5 0 00-1.085-1.462A7.5 7.5 0 0112 2.25zM12 21a9 9 0 100-18 9 9 0 000 18z" /></svg> Ideas</a></li>
        <li><a href="#"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg> Participants</a></li>
      </ul>
    </aside>
    <main class="main-content">
      <nav class="top-nav">
        <div class="user-profile">
          <span id="welcomeBanner"></span>
          <div id="userAvatar" class="user-avatar"></div>
        </div>
        <button id="logoutBtn" class="btn btn-secondary">Logout</button>
      </nav>

      <!-- Dashboard -->
      <div id="dashboardView" class="view">
        <div class="page-header">
          <div>
            <p class="muted">Dashboard</p>
            <h2 id="dashboardGreeting">Hello!</h2>
          </div>
          <button id="createStudyBtn" class="btn btn-brand">New Study</button>
        </div>
        <div id="studiesList" class="studies-list-grid">
          <!-- Study cards will be injected here -->
        </div>
      </div>
      
      <!-- Create Study -->
      <div id="setupView" class="view">
        <div class="setup-header">
          <h2 id="setupViewTitle">Create a New Study</h2>
          <div>
            <button id="cancelCreateBtn" class="btn btn-secondary">Cancel</button>
            <button id="saveStudyBtn" class="btn btn-brand">Save Study</button>
          </div>
        </div>
        
        <div class="panel">
          <div class="tabs">
            <button class="tab-btn active" data-tab="general">General</button>
            <button class="tab-btn" data-tab="cards">Cards</button>
          </div>
          
          <div id="tabGeneral" class="tab-pane active">
            <div class="form-group">
              <input type="text" id="studyName" placeholder=" " required/>
              <label for="studyName">Study name</label>
            </div>
            <div class="form-group">
              <textarea id="instructionsInput" rows="4" placeholder=" "></textarea>
              <label for="instructionsInput">Instructions (optional)</label>
            </div>
          </div>
          
          <div id="tabCards" class="tab-pane">
            <div class="bulk-import-wrap">
              <label for="excelUpload">Bulk import cards from Excel (.xlsx)</label>
              <input type="file" id="excelUpload" accept=".xlsx, .xls, .csv"/>
            </div>
            
            <label>
              <input type="checkbox" id="enableDescriptions"/>
              Add descriptions (tooltips) to cards
            </label>
            
            <div id="simpleCardsWrap" style="margin-top: 1rem;">
              <div class="form-group">
                <textarea id="cardsInput" rows="8" placeholder=" "></textarea>
                <label for="cardsInput">Cards (one per line)</label>
              </div>
            </div>
            
            <div id="builderWrap" class="builder-wrap hidden" style="margin-top: 1rem;">
              <div class="builder-head">
                <strong>Cards and Descriptions</strong>
                <button type="button" id="addCardRowBtn" class="btn btn-secondary">Add Card</button>
              </div>
              <div id="builderRows" class="builder-rows"></div>
            </div>
          </div>
        </div>
      </div>
      
    </main>
  </div>
  
  <!-- Fallback/Legacy container for Auth/Participant/Results -->
  <div id="legacyContainer" class="legacy-container">
    
    <!-- Auth View (uses legacy styles) -->
    <div id="authView" class="view">
      <header class="legacy-header"><h1>Pasifika Open Card Sorting Tool</h1></header>
      <h2>Researcher Login</h2>
      <form id="authForm" novalidate>
        <label for="displayName">Full name (for new sign-ups)</label>
        <input type="text" id="displayName" placeholder="e.g., John Doe" autocomplete="name"/>
        <label for="email">Email</label>
        <input type="email" id="email" placeholder="name@example.com" autocomplete="username" inputmode="email" required/>
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Password" autocomplete="current-password" required/>
        <div>
          <button id="loginBtn" type="submit" class="btn btn-brand">Login</button>
          <button id="signupBtn" type="button" class="btn btn-danger">Sign Up</button>
          <button id="forgotPwdBtn" type="button" class="btn btn-secondary">Forgot Password</button>
        </div>
      </form>
    </div>
    
    <!-- Share Link, Results (use legacy styles for now) -->
    <div id="studyCreatedView" class="view panel">
      <h2>Study Created!</h2>
      <label for="studyLink">Share this link with participants</label>
      <input type="text" id="studyLink" readonly/>
      <div>
        <button id="copyLinkBtn" class="btn btn-brand">Copy Link</button>
        <button id="backToDashboardBtn" class="btn btn-secondary">Back to Dashboard</button>
      </div>
    </div>
    <div id="resultsView" class="view panel">
       <!-- This view's content is generated by JS and is complex to restyle quickly -->
       <!-- It will retain the older functional style within the new layout for now -->
       <h2 style="margin-bottom: 1.5rem;">Study Results: <span id="resultsStudyName"></span></h2>
       <button id="backToDashboardFromResultsBtn" class="btn btn-secondary" style="margin-bottom: 1rem;">Back to Dashboard</button>
       <!-- ... existing results content will go here ... -->
    </div>

  </div>

  <!-- Participant View (completely separate from researcher layout) -->
  <div id="participantContainer" class="participant-container hidden">
      <header class="legacy-header">
        <h1 id="participantStudyName"></h1>
      </header>
      <div id="participantView" class="view">
        <p id="cardDescriptionInfo" class="muted hidden" style="text-align: center; margin-bottom: 1rem;">
          Click the <span style="font-size: 1.2em; vertical-align: middle;">ℹ️</span> icon on a card to see its description.
        </p>
        <div class="workspace" role="region" aria-label="Card sorting workspace">
          <div class="toolbar">
              <button id="submitSortingBtn" class="btn btn-brand">Finish Sorting</button>
          </div>
          <aside id="availableCardsContainer" role="region" aria-label="Unsorted cards">
            <h3>Unsorted Cards</h3>
            <div id="availableCards" class="cards-list"></div>
          </aside>
          <div class="category-columns-wrap">
            <div class="category-column"></div>
            <div class="category-column"></div>
            <div class="category-column"></div>
          </div>
        </div>
      </div>
  </div>

  <!-- Modals (unchanged) -->
  <div id="participantModal" class="modal-backdrop hidden">
    <div class="modal">
        <h3>Before you begin</h3>
        <p>Please enter your details to proceed.</p>
        <label>Full name</label><input id="pName" type="text" placeholder="Your name" required/>
        <label>ID number</label><input id="pId" type="text" placeholder="Your ID number" required/>
        <label>Course</label><input id="pCourse" type="text" placeholder="Your course" required/>
        <label>Nationality</label><input id="pNationality" type="text" placeholder="Your nationality" required/>
        <label>Ethnicity</label><input id="pEthnicity" type="text" placeholder="Your ethnicity" required/>
        <fieldset> <legend>Is your family home outside of Suva/Nausori? (Yes/No)</legend>
          <label><input type="radio" name="pOutsideHome" value="Yes" required/> Yes</label>
          <label><input type="radio" name="pOutsideHome" value="No" required/> No</label>
        </fieldset>
        <div class="actions"><button id="startSortingBtn" class="btn btn-brand">Continue</button></div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const firebaseConfig = {
        apiKey: "AIzaSyAu1hawycY2uQgzWolaHeTfCdWtSWux7XA",
        authDomain: "card-sorting-tool-762a3.firebaseapp.com",
        databaseURL: "https://card-sorting-tool-762a3-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "card-sorting-tool-762a3",
        storageBucket: "card-sorting-tool-762a3.appspot.com",
        messagingSenderId: "361630774945",
        appId: "1:361630774945:web:402edb363d388a61baa2e0",
        measurementId: "G-BGV3P2HQZP"
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.database();

      // --- DOM Elements ---
      const researcherLayout = document.getElementById('researcherLayout');
      const legacyContainer = document.getElementById('legacyContainer');
      const participantContainer = document.getElementById('participantContainer');
      
      const allViews = document.querySelectorAll('.view');
      const authView = document.getElementById('authView');
      const dashboardView = document.getElementById('dashboardView');
      const setupView = document.getElementById('setupView');
      const studyCreatedView = document.getElementById('studyCreatedView');
      const participantView = document.getElementById('participantView');
      const resultsView = document.getElementById('resultsView'); // Will be appended to main content
      
      const welcomeBanner = document.getElementById('welcomeBanner');
      const userAvatar = document.getElementById('userAvatar');
      const dashboardGreeting = document.getElementById('dashboardGreeting');
      
      // ... other element selectors from previous version
      const emailInput = document.getElementById('email'), passwordInput = document.getElementById('password');
      const studyNameInput = document.getElementById('studyName'), cardsInput = document.getElementById('cardsInput'), instructionsInput = document.getElementById('instructionsInput');
      const enableDescriptions = document.getElementById('enableDescriptions'), excelUploadInput = document.getElementById('excelUpload');
      const builderWrap = document.getElementById('builderWrap'), builderRows = document.getElementById('builderRows'), addCardRowBtn = document.getElementById('addCardRowBtn'), simpleCardsWrap = document.getElementById('simpleCardsWrap');
      const studyLinkInput = document.getElementById('studyLink');
      const availableCards = document.getElementById('availableCards'), categoryColumns = participantView.querySelectorAll('.category-column');
      const participantStudyName = document.getElementById('participantStudyName');
      const pName = document.getElementById('pName'), pId = document.getElementById('pId'), pCourse = document.getElementById('pCourse'), pNationality = document.getElementById('pNationality'), pEthnicity = document.getElementById('pEthnicity');


      const params = new URLSearchParams(location.search);
      const pUid = params.get('uid'), pStudyId = params.get('study');
      const hasParticipantLink = Boolean(pUid && pStudyId);

      // --- New UI Logic ---
      function showView(viewToShow) {
        // Hide all containers and views first
        researcherLayout.classList.add('hidden');
        legacyContainer.classList.add('hidden');
        participantContainer.classList.add('hidden');
        allViews.forEach(v => v.classList.remove('active'));

        if (viewToShow === participantView) {
            participantContainer.classList.remove('hidden');
            participantView.classList.add('active');
        } else if (viewToShow === authView) {
            legacyContainer.classList.remove('hidden');
            authView.classList.add('active');
        } else {
            // All other views are for researchers
            researcherLayout.classList.remove('hidden');
            // If it's a legacy view like 'studyCreated' or 'results', move it into the main content
            if (viewToShow === studyCreatedView || viewToShow === resultsView) {
              document.querySelector('.main-content').appendChild(viewToShow);
            }
            viewToShow.classList.add('active');
        }
      }

      // Setup view tabs
      const setupTabs = setupView.querySelectorAll('.tab-btn');
      const setupPanes = setupView.querySelectorAll('.tab-pane');
      setupTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          setupTabs.forEach(t => t.classList.remove('active'));
          setupPanes.forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(`tab${tab.dataset.tab.charAt(0).toUpperCase() + tab.dataset.tab.slice(1)}`).classList.add('active');
        });
      });


      // --- Core App Logic (Adapted for new structure) ---
      
      auth.onAuthStateChanged(user => {
        if (hasParticipantLink) {
          showView(participantView);
          loadParticipantView(pUid, pStudyId);
          return;
        }

        if (user) {
          const displayName = user.displayName || user.email;
          welcomeBanner.textContent = displayName;
          dashboardGreeting.textContent = `Hello, ${user.displayName || 'Researcher'}`;
          userAvatar.textContent = (user.displayName || 'U').charAt(0).toUpperCase();
          showView(dashboardView);
          showDashboard(user.uid);
        } else {
          showView(authView);
        }
      });

      function showDashboard(uid) {
        const list = document.getElementById('studiesList');
        list.innerHTML = ''; // Clear previous
        db.ref(`users/${uid}/studies`).once('value').then(snap => {
          const data = snap.val() || {};
          const studyIds = Object.keys(data);
          if (studyIds.length === 0) {
              list.innerHTML = '<p>No active studies found. Create one to get started!</p>';
              return;
          }
          studyIds.forEach(studyId => addStudyToDashboard(uid, studyId, data[studyId]));
        });
      }

      function addStudyToDashboard(uid, studyId, study) {
        const list = document.getElementById('studiesList');
        const div = document.createElement('div');
        div.className = 'study-card';
        
        const publishedStatus = study.isPublic 
            ? '<span class="badge published">Published</span>' 
            : '<span class="badge">Draft</span>';

        div.innerHTML = `
          <div class="study-card-header">
            <h3>${study.name || '(Untitled study)'}</h3>
            ${publishedStatus}
          </div>
          <div class="study-card-actions">
            <button class="btn btn-secondary share-btn">Share</button>
            <button class="btn btn-secondary publish-btn">${study.isPublic ? 'Unpublish' : 'Publish'}</button>
            <button class="btn btn-secondary results-btn">Results</button>
            <button class="btn btn-danger delete-btn">Delete</button>
          </div>
        `;

        // Add event listeners
        div.querySelector('.share-btn').onclick = () => { /* ... share logic ... */ };
        div.querySelector('.publish-btn').onclick = async () => { /* ... publish logic ... */ };
        div.querySelector('.results-btn').onclick = () => { alert("Results view not yet restyled. It will load with the old UI."); showView(resultsView); /*... load results logic ... */ };
        div.querySelector('.delete-btn').onclick = async () => { /* ... delete logic ... */ };

        list.appendChild(div);
      }
      
      document.getElementById('logoutBtn').onclick = () => auth.signOut();
      document.getElementById('navDashboard').onclick = (e) => { e.preventDefault(); showView(dashboardView); };
      document.getElementById('createStudyBtn').onclick = () => {
        document.getElementById('setupViewTitle').textContent = "Create a New Study";
        // Reset form fields
        showView(setupView);
      };
      document.getElementById('cancelCreateBtn').onclick = () => showView(dashboardView);
      document.getElementById('saveStudyBtn').onclick = () => { /* ... save logic ... */ };
      document.getElementById('backToDashboardBtn').onclick = () => showView(dashboardView);
      
      // Placeholder for simplified logic that needs to be filled in from your previous version
      document.getElementById('loginBtn').onclick = async (e) => { e.preventDefault(); try { await auth.signInWithEmailAndPassword(emailInput.value.trim(), passwordInput.value); } catch(err) { alert(err.message); }};
      
      function loadParticipantView(uid, studyId) {
        db.ref(`users/${uid}/studies/${studyId}`).once('value').then(snap => {
          const study = snap.val();
          if (!study || !study.isPublic) { /* handle error */ return; }
          participantStudyName.textContent = study.name || '';
          
          availableCards.innerHTML = '';
          (study.cards || []).forEach(c => {
            const text = typeof c === 'string' ? c : (c?.text || '');
            if(text) {
                const cardEl = document.createElement('div');
                cardEl.className = 'card';
                cardEl.textContent = text;
                availableCards.appendChild(cardEl);
            }
          });

          new Sortable(availableCards, { group: 'cards', animation: 150 });
          categoryColumns.forEach(column => {
              new Sortable(column, { group: 'cards', animation: 150, onAdd: (evt) => {
                  if (evt.item.classList.contains('card') && column.children.length === 1) {
                      makeCategory(column).querySelector('.cat-body').appendChild(evt.item);
                  }
              }});
          });

          document.getElementById('participantModal').classList.remove('hidden');
        });
      }

      function makeCategory(targetColumn) { /* ... same as before ... */ return document.createElement('div'); }
      document.getElementById('startSortingBtn').onclick = () => document.getElementById('participantModal').classList.add('hidden');

      // Initial check
      if (hasParticipantLink) {
        showView(participantView);
        loadParticipantView(pUid, pStudyId);
      } else {
        // Auth state will handle showing login or dashboard
      }
    });
  </script>
</body>
</html>
