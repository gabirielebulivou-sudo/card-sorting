<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Open Card Sorting Tool - Improved</title>
  <style>
    :root {
      --primary:#4a6fa5;--secondary:#6b8cae;--accent:#ff6b6b;--light:#f8f9fa;--dark:#343a40;--success:#28a745;--border:#dee2e6;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
    body{background-color:#f5f7fa;color:var(--dark);line-height:1.6}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{background-color:var(--primary);color:white;padding:1rem;text-align:center;margin-bottom:2rem;border-radius:5px}
    h1,h2,h3{margin-bottom:1rem}
    .view{display:none;background:white;padding:2rem;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);margin-bottom:2rem}
    .active{display:block}
    .btn{display:inline-block;padding:.5rem 1rem;background:var(--primary);color:white;border:none;border-radius:4px;cursor:pointer;font-size:1rem;transition:background .3s;margin-right:.5rem;margin-bottom:.5rem}
    .btn:hover{background:var(--secondary)}
    .btn-success{background:var(--success)}
    .btn-success:hover{background:#218838}
    .btn-accent{background:var(--accent)}
    .btn-accent:hover{background:#e55c5c}
    .form-group{margin-bottom:1.5rem}
    label{display:block;margin-bottom:.5rem;font-weight:600}
    input[type=text],textarea{width:100%;padding:.75rem;border:1px solid var(--border);border-radius:4px;font-size:1rem}
    textarea{min-height:150px;resize:vertical}
    .card{background:white;border:1px solid var(--border);border-radius:4px;padding:1rem;margin:.25rem 0;box-shadow:0 1px 3px rgba(0,0,0,.1);cursor:grab}
    .category{background:var(--light);border:2px dashed var(--secondary);border-radius:8px;padding:1rem;margin-bottom:2rem;min-height:150px}
    .category-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem}
    .category-title{font-weight:600;color:var(--primary)}
    .sorting-area{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem;margin-top:2rem}
    .card-pool{background:var(--light);border:2px dashed var(--border);border-radius:8px;padding:1rem;min-height:150px}
    .instructions{background:#e9ecef;padding:1rem;border-radius:4px;margin-bottom:1.5rem}
    .results-container{margin-top:2rem}
    .result-item{background:white;border:1px solid var(--border);border-radius:4px;padding:1rem;margin-bottom:1rem}
    .category-cards{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.5rem}
    .category-card{background:var(--light);padding:.25rem .5rem;border-radius:4px;font-size:.9rem}
    .unnamed{font-style:italic;color:#888}
    table{border-collapse:collapse;margin-top:1rem}
    th,td{border:1px solid var(--border);padding:.5rem;text-align:center}
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- SortableJS for better drag & touch support -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <header><h1>Open Card Sorting Tool</h1></header>

    <!-- Setup view -->
    <div id="setupView" class="view active">
      <h2>Create a New Card Sorting Study</h2>
      <div class="form-group"><label>Study Name</label>
        <input type="text" id="studyName" placeholder="Enter name"></div>
      <div class="form-group"><label>Cards (one per line)</label>
        <textarea id="cardsInput"></textarea></div>
      <div class="form-group"><label>Instructions</label>
        <textarea id="instructions"></textarea></div>
      <button id="createStudyBtn" class="btn">Create Study</button>
    </div>

    <!-- Study created -->
    <div id="studyCreatedView" class="view">
      <h2>Study Created!</h2>
      <p>Share this link:</p>
      <div class="form-group"><input type="text" id="studyLink" readonly></div>
      <button id="copyLinkBtn" class="btn">Copy Link</button>
      <button id="viewResultsBtn" class="btn btn-success">View Results</button>
      <button id="newStudyBtn" class="btn">Create New Study</button>
      <p style="margin-top:1rem;font-size:0.9rem;color:#666"><strong>Note:</strong> Ensure Firebase database rules restrict writes so only this app can append results (append-only rules recommended).</p>
    </div>

    <!-- Participant -->
    <div id="participantView" class="view">
      <h2 id="participantStudyName"></h2>
      <div id="participantInstructions" class="instructions"></div>
      <p>Drag cards into categories. You can add or rename categories.</p>
      <div class="card-pool" id="cardPool"><h3>Cards</h3><div id="availableCards"></div></div>
      <div class="sorting-area" id="sortingArea"></div>
      <button id="addCategoryBtn" class="btn">Add Category</button>
      <button id="submitSortingBtn" class="btn btn-success">Submit Sorting</button>
    </div>

    <!-- Results -->
    <div id="resultsView" class="view">
      <h2>Study Results: <span id="resultsStudyName"></span></h2>
      <div id="noResultsMessage" class="hidden"><p>No participants yet.</p></div>
      <div id="resultsContainer" class="results-container"></div>
      <div id="aggregateResults" class="results-container"></div>
      <button id="backToStudyBtn" class="btn">Back</button>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded',function(){
  const setupView=document.getElementById('setupView'),studyCreatedView=document.getElementById('studyCreatedView'),
    participantView=document.getElementById('participantView'),resultsView=document.getElementById('resultsView');
  const studyNameInput=document.getElementById('studyName'),cardsInput=document.getElementById('cardsInput'),
    instructionsInput=document.getElementById('instructions'),studyLinkInput=document.getElementById('studyLink');
  const createStudyBtn=document.getElementById('createStudyBtn'),copyLinkBtn=document.getElementById('copyLinkBtn'),
    viewResultsBtn=document.getElementById('viewResultsBtn'),newStudyBtn=document.getElementById('newStudyBtn'),
    addCategoryBtn=document.getElementById('addCategoryBtn'),submitSortingBtn=document.getElementById('submitSortingBtn'),
    backToStudyBtn=document.getElementById('backToStudyBtn');
  const availableCardsContainer=document.getElementById('availableCards'),sortingArea=document.getElementById('sortingArea'),
    participantStudyName=document.getElementById('participantStudyName'),participantInstructions=document.getElementById('participantInstructions'),
    resultsStudyName=document.getElementById('resultsStudyName'),resultsContainer=document.getElementById('resultsContainer'),
    aggregateResults=document.getElementById('aggregateResults'),noResultsMessage=document.getElementById('noResultsMessage');
  let currentStudy=null;
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAu1hawycY2uQgzWolaHeTfCdWtSWux7XA",
  authDomain: "card-sorting-tool-762a3.firebaseapp.com",
  databaseURL: "https://card-sorting-tool-762a3-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "card-sorting-tool-762a3",
  storageBucket: "card-sorting-tool-762a3.firebasestorage.app",
  messagingSenderId: "361630774945",
  appId: "1:361630774945:web:402edb363d388a61baa2e0",
  measurementId: "G-BGV3P2HQZP"
};
  if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
  const database=firebase.database();

  const urlParams=new URLSearchParams(window.location.search);
  const studyId=urlParams.get('study');
  if(studyId)loadStudyFromFirebase(studyId);

  createStudyBtn.addEventListener('click',createStudy);
  copyLinkBtn.addEventListener('click',copyLink);
  viewResultsBtn.addEventListener('click',viewResults);
  newStudyBtn.addEventListener('click',newStudy);
  addCategoryBtn.addEventListener('click',addCategory);
  submitSortingBtn.addEventListener('click',submitSorting);
  backToStudyBtn.addEventListener('click',backToStudy);

  function createStudy(){
    const name=studyNameInput.value.trim(),cardsText=cardsInput.value.trim(),instructions=instructionsInput.value.trim();
    if(!name||!cardsText){alert('Please provide name and cards');return}
    const cardsArray=cardsText.split('\n').map(l=>l.trim()).filter(l=>l.length>0);
    const study={id:'study_'+Date.now(),name,cards:cardsArray,instructions,createdAt:new Date().toISOString()};
    database.ref('studies/'+study.id).set(study).then(()=>{
      currentStudy=study;
      studyLinkInput.value=`${window.location.origin}${window.location.pathname}?study=${study.id}`;
      setupView.classList.remove('active');studyCreatedView.classList.add('active');
    });
  }
  function copyLink(){
    navigator.clipboard.writeText(studyLinkInput.value).then(()=>alert('Link copied'));
  }
  function loadStudyFromFirebase(id){
    database.ref('studies/'+id).once('value').then(snap=>{
      const data=snap.val();if(!data){alert('Study not found');return}
      setupParticipantView({id,...data});
    });
  }
  function viewResults(){
    if(!currentStudy)return;
    resultsStudyName.textContent=currentStudy.name;
    resultsContainer.innerHTML='Loading...';aggregateResults.innerHTML='';
    database.ref('studies/'+currentStudy.id+'/results').once('value').then(snap=>{
      const results=snap.val();
      if(!results){noResultsMessage.classList.remove('hidden');resultsContainer.innerHTML='';return}
      noResultsMessage.classList.add('hidden');resultsContainer.innerHTML='';
      const arr=Object.values(results);
      arr.forEach((res,i)=>{
        const div=document.createElement('div');div.className='result-item';
        div.innerHTML=`<h3>Participant ${i+1} (${new Date(res.timestamp).toLocaleString()})</h3>`;
        (res.categories||[]).forEach(cat=>{
          const c=document.createElement('div');
          c.innerHTML=`<p><strong>${cat.name||'<em class="unnamed">Unnamed</em>'}</strong></p>
            <div class='category-cards'>${(cat.cards||[]).map(card=>`<span class='category-card'>${card}</span>`).join('')}</div>`;
          div.appendChild(c);
        });resultsContainer.appendChild(div);
      });
      // Aggregate analysis
      const cards=currentStudy.cards;
      const matrix={};cards.forEach(a=>{matrix[a]={};cards.forEach(b=>matrix[a][b]=0)});
      let totalCats=0;
      arr.forEach(r=>{
        totalCats+=r.categories? r.categories.length:0;
        (r.categories||[]).forEach(cat=>{
          const cs=cat.cards||[];
          cs.forEach((a,i)=>cs.forEach(b=>{if(i<cs.length)matrix[a][b]++}))
        });
      });
      let html='<h3>Aggregate Analysis</h3>';
      html+=`<p>Participants: ${arr.length}</p><p>Avg categories per participant: ${(totalCats/arr.length).toFixed(2)}</p>`;
      // Co-occurrence table
      html+='<h4>Card Co-occurrence</h4><table><tr><th></th>'+cards.map(c=>`<th>${c}</th>`).join('')+'</tr>';
      cards.forEach(a=>{
        html+=`<tr><th>${a}</th>`+cards.map(b=>`<td>${matrix[a][b]}</td>`).join('')+'</tr>';
      });
      html+='</table>';aggregateResults.innerHTML=html;
    });
    studyCreatedView.classList.remove('active');resultsView.classList.add('active');
  }
  function newStudy(){studyNameInput.value='';cardsInput.value='';instructionsInput.value='';studyCreatedView.classList.remove('active');setupView.classList.add('active')}
  function backToStudy(){resultsView.classList.remove('active');studyCreatedView.classList.add('active')}
  function addCategory(){
    const wrapper=document.createElement('div');wrapper.className='category';
    wrapper.innerHTML=`<div class='category-header'>
      <input type='text' class='category-name' placeholder='Category name'>
      <button class='btn btn-accent remove-category'>Remove</button></div><div class='dropzone'></div>`;
    sortingArea.appendChild(wrapper);
    new Sortable(wrapper.querySelector('.dropzone'),{group:'shared',animation:150});
    wrapper.querySelector('.remove-category').addEventListener('click',()=>{
      wrapper.querySelectorAll('.card').forEach(c=>availableCardsContainer.appendChild(c));
      wrapper.remove();
    });
  }
  function submitSorting(){
    if(!currentStudy)return;
    const cats=[];let placed=0;
    sortingArea.querySelectorAll('.category').forEach(cat=>{
      const name=cat.querySelector('.category-name').value.trim()||'Unnamed';
      const cards=[...cat.querySelectorAll('.card')].map(c=>c.dataset.cardText);
      if(cards.length>0){placed+=cards.length;cats.push({name,cards})}
    });
    if(placed==0){alert('Please sort cards');return}
    database.ref('studies/'+currentStudy.id+'/results').push({timestamp:new Date().toISOString(),categories:cats})
      .then(()=>participantView.innerHTML='<h2>Thanks!</h2>');
  }
  function setupParticipantView(study){
    currentStudy=study;
    participantStudyName.textContent=study.name;
    if(study.instructions){participantInstructions.textContent=study.instructions;participantInstructions.classList.remove('hidden')}
    else participantInstructions.classList.add('hidden');
    availableCardsContainer.innerHTML='';
    study.cards.forEach((txt,i)=>{
      const d=document.createElement('div');d.className='card';d.textContent=txt;d.dataset.cardText=txt;
      availableCardsContainer.appendChild(d);
    });
    new Sortable(availableCardsContainer,{group:'shared',animation:150});
    sortingArea.innerHTML='';addCategory();
    setupView.classList.remove('active');participantView.classList.add('active');
  }
});
</script>
</body>
</html>

