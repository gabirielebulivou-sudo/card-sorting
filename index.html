<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Open Card Sorting Tool - Researcher Accounts</title>
  <style>
    :root {--primary:#4a6fa5;--secondary:#6b8cae;--accent:#ff6b6b;--light:#f8f9fa;--dark:#343a40;--success:#28a745;--border:#dee2e6;}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif}
    body{background:#f5f7fa;color:var(--dark);line-height:1.5}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{background:var(--primary);color:white;padding:1rem;text-align:center;margin-bottom:2rem;border-radius:5px}
    .view{display:none;background:white;padding:2rem;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);margin-bottom:2rem}
    .active{display:block}
    .btn{padding:.5rem 1rem;background:var(--primary);color:white;border:none;border-radius:4px;cursor:pointer;margin:.25rem}
    .btn:hover{background:var(--secondary)}
    .btn-success{background:var(--success)}
    input,textarea{width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid var(--border);border-radius:4px}
    .study-item{border:1px solid var(--border);padding:.75rem;margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center}
    .instructions{background:#e9ecef;padding:1rem;margin-bottom:1rem;border-radius:4px}
    .category-card{background:#eee;padding:.25rem .5rem;border-radius:4px;margin:.25rem}
    table{border-collapse:collapse;margin-top:1rem}
    th,td{border:1px solid var(--border);padding:.5rem;text-align:center}
    .card{background:white;border:1px solid var(--border);padding:1rem;margin:.25rem;border-radius:4px;cursor:grab}
    .category{background:var(--light);border:2px dashed var(--secondary);border-radius:8px;padding:1rem;margin:1rem 0}
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- SortableJS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <header><h1>Open Card Sorting Tool</h1></header>

    <!-- Login / Signup -->
    <div id="authView" class="view active">
      <h2>Researcher Login</h2>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button id="loginBtn" class="btn">Login</button>
      <button id="signupBtn" class="btn">Sign Up</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboardView" class="view">
      <h2>Dashboard</h2>
      <button id="createStudyBtn" class="btn">Create New Study</button>
      <button id="logoutBtn" class="btn btn-accent">Logout</button>
      <h3>Your Studies</h3>
      <div id="studiesList"></div>
    </div>

    <!-- Create Study -->
    <div id="setupView" class="view">
      <h2>Create a New Study</h2>
      <input type="text" id="studyName" placeholder="Study name">
      <textarea id="cardsInput" placeholder="Cards, one per line"></textarea>
      <textarea id="instructionsInput" placeholder="Instructions (optional)"></textarea>
      <button id="saveStudyBtn" class="btn btn-success">Save Study</button>
      <button id="cancelCreateBtn" class="btn">Cancel</button>
    </div>

    <!-- Share Link -->
    <div id="studyCreatedView" class="view">
      <h2>Study Created!</h2>
      <input type="text" id="studyLink" readonly>
      <button id="copyLinkBtn" class="btn">Copy Link</button>
      <button id="backToDashboardBtn" class="btn">Back to Dashboard</button>
    </div>

    <!-- Participant -->
    <div id="participantView" class="view">
      <h2 id="participantStudyName"></h2>
      <div id="participantInstructions" class="instructions"></div>
      <div class="card-pool">
        <h3>Cards</h3>
        <div id="availableCards"></div>
      </div>
      <div id="sortingArea"></div>
      <button id="addCategoryBtn" class="btn">Add Category</button>
      <button id="submitSortingBtn" class="btn btn-success">Submit</button>
    </div>

    <!-- Results -->
    <div id="resultsView" class="view">
      <h2>Study Results: <span id="resultsStudyName"></span></h2>
      <div id="resultsContainer"></div>
      <div id="aggregateResults"></div>
      <button id="backToDashboardFromResultsBtn" class="btn">Back to Dashboard</button>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded',function(){
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAu1hawycY2uQgzWolaHeTfCdWtSWux7XA",
  authDomain: "card-sorting-tool-762a3.firebaseapp.com",
  databaseURL: "https://card-sorting-tool-762a3-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "card-sorting-tool-762a3",
  storageBucket: "card-sorting-tool-762a3.firebasestorage.app",
  messagingSenderId: "361630774945",
  appId: "1:361630774945:web:402edb363d388a61baa2e0",
  measurementId: "G-BGV3P2HQZP"
};
  if(!firebase.apps.length)firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth();const db=firebase.database();

  // DOM refs
  const authView=document.getElementById('authView'),dashboardView=document.getElementById('dashboardView'),
    setupView=document.getElementById('setupView'),studyCreatedView=document.getElementById('studyCreatedView'),
    participantView=document.getElementById('participantView'),resultsView=document.getElementById('resultsView');
  const studyNameInput=document.getElementById('studyName'),cardsInput=document.getElementById('cardsInput'),
    instructionsInput=document.getElementById('instructionsInput'),studyLinkInput=document.getElementById('studyLink');
  const studiesList=document.getElementById('studiesList'),availableCardsContainer=document.getElementById('availableCards'),
    sortingArea=document.getElementById('sortingArea'),participantStudyName=document.getElementById('participantStudyName'),
    participantInstructions=document.getElementById('participantInstructions'),resultsStudyName=document.getElementById('resultsStudyName'),
    resultsContainer=document.getElementById('resultsContainer'),aggregateResults=document.getElementById('aggregateResults');

  // Auth buttons
  document.getElementById('loginBtn').onclick=()=>auth.signInWithEmailAndPassword(
    document.getElementById('email').value,document.getElementById('password').value).catch(e=>alert(e.message));
  document.getElementById('signupBtn').onclick=()=>auth.createUserWithEmailAndPassword(
    document.getElementById('email').value,document.getElementById('password').value).catch(e=>alert(e.message));
  document.getElementById('logoutBtn').onclick=()=>auth.signOut();

  // Study creation
  document.getElementById('createStudyBtn').onclick=()=>{dashboardView.classList.remove('active');setupView.classList.add('active');};
  document.getElementById('cancelCreateBtn').onclick=()=>{setupView.classList.remove('active');dashboardView.classList.add('active');};
  document.getElementById('saveStudyBtn').onclick=()=>{
    const name=studyNameInput.value.trim(),cards=cardsInput.value.trim().split('\n').map(l=>l.trim()).filter(Boolean);
    if(!name||cards.length===0){alert('Enter name and at least one card');return;}
    const study={id:'study_'+Date.now(),name,cards,instructions:instructionsInput.value.trim(),createdAt:new Date().toISOString()};
    const uid=auth.currentUser.uid;
    db.ref(`users/${uid}/studies/${study.id}`).set(study).then(()=>{
      studyLinkInput.value=`${window.location.origin}${window.location.pathname}?uid=${uid}&study=${study.id}`;
      setupView.classList.remove('active');studyCreatedView.classList.add('active');
    });
  };
  document.getElementById('backToDashboardBtn').onclick=()=>{studyCreatedView.classList.remove('active');dashboardView.classList.add('active');};
  document.getElementById('copyLinkBtn').onclick=()=>navigator.clipboard.writeText(studyLinkInput.value).then(()=>alert('Link copied!'));
  document.getElementById('backToDashboardFromResultsBtn').onclick=()=>{resultsView.classList.remove('active');dashboardView.classList.add('active');};

  // Participant category controls
  document.getElementById('addCategoryBtn').onclick=()=>addCategory();
  document.getElementById('submitSortingBtn').onclick=()=>submitSorting();

  // Auth state change
  auth.onAuthStateChanged(user=>{
    if(user){authView.classList.remove('active');dashboardView.classList.add('active');showDashboard(user.uid);}
    else{dashboardView.classList.remove('active');authView.classList.add('active');}
  });

  function showDashboard(uid){
  db.ref(`users/${uid}/studies`).on('value', snap=>{
    studiesList.innerHTML = '';
    const data = snap.val() || {};

    Object.entries(data).forEach(([studyId, study])=>{
      const div = document.createElement('div');
      div.className = 'study-item';
      div.innerHTML = `
        <span>${study.name}</span>
        <button class="btn btn-success">Results</button>`;
      div.querySelector('button').onclick = () => viewResults(uid, studyId);
      studiesList.appendChild(div);
    });
  });
}
  // Parse link for participant
  const params=new URLSearchParams(location.search);const uid=params.get('uid'),studyId=params.get('study');
  if(uid&&studyId){loadParticipantView(uid,studyId);}

  function loadParticipantView(uid,studyId){
    db.ref(`users/${uid}/studies/${studyId}`).once('value').then(snap=>{
      const study=snap.val();if(!study){alert('Study not found');return;}
      participantStudyName.textContent=study.name;
      if(study.instructions){participantInstructions.textContent=study.instructions;participantInstructions.classList.remove('hidden');}
      availableCardsContainer.innerHTML='';study.cards.forEach(card=>{
        const d=document.createElement('div');d.className='card';d.textContent=card;d.dataset.cardText=card;
        availableCardsContainer.appendChild(d);
      });
      new Sortable(availableCardsContainer,{group:'shared',animation:150});
      sortingArea.innerHTML='';addCategory();
      participantView.classList.add('active');authView.classList.remove('active');dashboardView.classList.remove('active');
      participantView.dataset.uid=uid;participantView.dataset.studyId=studyId;
    });
  }
  function addCategory(){
    const div=document.createElement('div');div.className='category';
    div.innerHTML=`<input type='text' class='category-name' placeholder='Category name'><div class='dropzone'></div>`;
    sortingArea.appendChild(div);new Sortable(div.querySelector('.dropzone'),{group:'shared',animation:150});
  }
  function submitSorting(){
    const uid=participantView.dataset.uid,studyId=participantView.dataset.studyId;
    const cats=[];sortingArea.querySelectorAll('.category').forEach(c=>{
      const name=c.querySelector('.category-name').value.trim()||'Unnamed';
      const cards=[...c.querySelectorAll('.card')].map(card=>card.dataset.cardText);
      if(cards.length>0)cats.push({name,cards});
    });
    if(cats.length===0){alert('Please sort at least one card.');return;}
    const result={timestamp:new Date().toISOString(),categories:cats};
    db.ref(`users/${uid}/studies/${studyId}/results`).push(result).then(()=>{
      participantView.innerHTML='<h2>Thank you!</h2><p>Your responses have been recorded.</p>';
    });
  }
  function viewResults(uid,studyId){
    db.ref(`users/${uid}/studies/${studyId}`).once('value').then(snap=>{
      const study=snap.val();resultsStudyName.textContent=study.name;
      db.ref(`users/${uid}/studies/${studyId}/results`).once('value').then(snap2=>{
        const results=snap2.val()||{};resultsContainer.innerHTML='';aggregateResults.innerHTML='';
        const arr=Object.values(results);
        if(arr.length===0){resultsContainer.innerHTML='<p>No results yet.</p>';return;}
        // Each participant's results
        arr.forEach((res,i)=>{
          const div=document.createElement('div');div.innerHTML=`<h4>Participant ${i+1}</h4>`;
          res.categories.forEach(cat=>{
            div.innerHTML+=`<p><strong>${cat.name}</strong> ${(cat.cards||[]).map(c=>'<span class="category-card">'+c+'</span>').join('')}</p>`;
          });resultsContainer.appendChild(div);
        });
        // Aggregate analysis
        const cards=study.cards;const matrix={};cards.forEach(a=>{matrix[a]={};cards.forEach(b=>matrix[a][b]=0);});
        let totalCats=0;arr.forEach(r=>{
          totalCats+=r.categories.length;
          r.categories.forEach(cat=>{const cs=cat.cards;cs.forEach(a=>cs.forEach(b=>matrix[a][b]++));});
        });
        let html=`<p>Participants: ${arr.length}</p><p>Avg categories: ${(totalCats/arr.length).toFixed(2)}</p>`;
        html+='<table><tr><th></th>'+cards.map(c=>'<th>'+c+'</th>').join('')+'</tr>';
        cards.forEach(a=>{html+='<tr><th>'+a+'</th>'+cards.map(b=>'<td>'+matrix[a][b]+'</td>').join('')+'</tr>';});
        html+='</table>';aggregateResults.innerHTML=html;
        dashboardView.classList.remove('active');resultsView.classList.add('active');
      });
    });
  }
});
</script>
</body>
</html>


