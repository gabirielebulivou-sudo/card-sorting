<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Open Card Sorting Tool</title>
  <style>
    :root { --primary:#4a6fa5; --secondary:#6b8cae; --accent:#ff6b6b; --light:#f8f9fa; --dark:#343a40; --success:#28a745; --border:#dee2e6; --gray-light:#f1f3f5; --gray-dark:#6c757d; }
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',system-ui,-apple-system,Roboto,Arial,sans-serif}
    body{background:#f5f7fa;color:var(--dark);line-height:1.5}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{background:var(--primary);color:white;padding:1rem;text-align:center;margin-bottom:2rem;border-radius:5px}
    .view{display:none;background:white;padding:2rem;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.1);margin-bottom:2rem}
    .active{display:block}
    .btn{padding:.75rem 1.25rem;background:var(--primary);color:white;border:none;border-radius:4px;cursor:pointer;margin:.25rem;touch-action:manipulation;font-size:1rem;min-height:44px}
    .btn:hover{background:var(--secondary)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn-success{background:var(--success)}
    .btn-accent{background:var(--accent);color:#fff}
    .btn-accent:hover{filter:brightness(0.95)}
    .study-item{border:1px solid var(--border);padding:.75rem;margin-bottom:.5rem;display:flex;justify-content:space-between;align-items:center;gap:.5rem;flex-wrap:wrap}
    .study-actions{display:flex;gap:.25rem;flex-wrap:wrap}
    label{display:block;margin:.25rem 0 .25rem;font-weight:600}
    input,textarea{width:100%;padding:.5rem;margin-bottom:1rem;border:1px solid var(--border);border-radius:4px}
    .muted{color:#6c757d}
    .badge{display:inline-block;padding:.1rem .4rem;border-radius:.25rem;font-size:.8rem;background:#edf2ff;color:#2f4e8b;border:1px solid #dbe4ff}
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- SortableJS for drag-drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
  <div class="container">
    <header><h1>Open Card Sorting Tool</h1></header>

    <!-- Auth View -->
    <div id="authView" class="view active">
      <h2 id="authHeading">Researcher Login</h2>
      <form id="authForm" novalidate>
        <label for="email">Email</label>
        <input type="email" id="email" required autocomplete="username">
        <label for="password">Password</label>
        <input type="password" id="password" required autocomplete="current-password">
        <div>
          <button id="loginBtn" type="submit" class="btn">Login</button>
          <button id="signupBtn" type="button" class="btn btn-accent">Sign Up</button>
        </div>
      </form>
    </div>

    <!-- Dashboard -->
    <div id="dashboardView" class="view">
      <h2>Dashboard</h2>
      <div>
        <button id="createStudyBtn" class="btn">Create New Study</button>
        <button id="logoutBtn" class="btn btn-accent">Logout</button>
      </div>
      <h3>Your Studies</h3>
      <div id="studiesList" aria-live="polite"></div>
    </div>

    <!-- Setup View for New Study -->
    <div id="setupView" class="view">
      <h2>Create a New Study</h2>
      <label for="studyName">Study name</label>
      <input type="text" id="studyName" required>
      <label for="cardsInput">Cards (one per line)</label>
      <textarea id="cardsInput" rows="8" required></textarea>
      <label for="instructionsInput">Instructions</label>
      <textarea id="instructionsInput" rows="4"></textarea>
      <div>
        <button id="saveStudyBtn" class="btn btn-success">Save Study</button>
        <button id="cancelCreateBtn" class="btn">Cancel</button>
      </div>
    </div>

    <!-- After Creating Study -->
    <div id="studyCreatedView" class="view">
      <h2>Study Created!</h2>
      <label for="studyLink">Share this link with participants</label>
      <input type="text" id="studyLink" readonly>
      <div>
        <button id="copyLinkBtn" class="btn">Copy Link</button>
        <button id="backToDashboardBtn" class="btn">Back to Dashboard</button>
      </div>
    </div>

    <!-- Participant & Results view are similar to what we built earlier -->
    <div id="participantView" class="view"><h2>Participant Study</h2><p>Placeholder for participant flow… (you can slot in your earlier participant UI here)</p></div>
    <div id="resultsView" class="view"><h2>Study Results</h2><p>Placeholder for results breakdown… (slot in result rendering code)</p></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Firebase Config
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_APP.firebaseapp.com",
    databaseURL: "https://YOUR_APP-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // DOM
  const authView=document.getElementById('authView');
  const dashboardView=document.getElementById('dashboardView');
  const setupView=document.getElementById('setupView');
  const studyCreatedView=document.getElementById('studyCreatedView');
  const studiesList=document.getElementById('studiesList');
  const studyNameInput=document.getElementById('studyName');
  const cardsInput=document.getElementById('cardsInput');
  const instructionsInput=document.getElementById('instructionsInput');
  const studyLinkInput=document.getElementById('studyLink');

  function show(view){[authView,dashboardView,setupView,studyCreatedView].forEach(v=>v.classList.remove('active'));view.classList.add('active');}

  // Auth
  async function doLogin(){try{await auth.signInWithEmailAndPassword(email.value,password.value);}catch(e){alert(e.message);}}
  async function doSignup(){try{await auth.createUserWithEmailAndPassword(email.value,password.value);}catch(e){alert(e.message);}}
  auth.onAuthStateChanged(user=>{if(user){show(dashboardView);showDashboard(user.uid);} else show(authView);});

  authForm.onsubmit=e=>{e.preventDefault();doLogin();}
  loginBtn.onclick=doLogin; signupBtn.onclick=doSignup;
  logoutBtn.onclick=()=>auth.signOut();

  // Create study
  createStudyBtn.onclick=()=>{show(setupView);}
  cancelCreateBtn.onclick=()=>{show(dashboardView);}
  saveStudyBtn.onclick=()=>{
    const user=auth.currentUser; if(!user) return alert("Login required");
    const studyId="study_"+Date.now();
    const study={id:studyId,name:studyNameInput.value.trim(),cards:cardsInput.value.split("\n").map(l=>l.trim()).filter(Boolean),instructions:instructionsInput.value.trim(),createdAt:new Date().toISOString(),ownerUid:user.uid,isPublic:true};
    db.ref(`users/${user.uid}/studies/${studyId}`).set(study).then(()=>{
      studyLinkInput.value=location.origin+location.pathname+`?uid=${user.uid}&study=${studyId}`;
      show(studyCreatedView);
    });
  };
  backToDashboardBtn.onclick=()=>show(dashboardView);
  copyLinkBtn.onclick=()=>{navigator.clipboard.writeText(studyLinkInput.value).then(()=>alert("Link copied"));}

  // Show dashboard
  function showDashboard(uid){
    studiesList.innerHTML='';
    db.ref(`users/${uid}/studies`).once('value').then(snap=>{
      const data=snap.val()||{};
      Object.entries(data).forEach(([id,study])=>{
        addStudyToDashboard(uid,id,study);
      });
    });
  }

  function addStudyToDashboard(uid,studyId,study){
    const div=document.createElement('div');
    div.className="study-item";
    div.innerHTML=`<div>${study.name||"(Untitled)"} <span class="badge">${study.isPublic?"Published":"Unpublished"}</span></div>`;
    const actions=document.createElement('div');actions.className='study-actions';
    const share=document.createElement('button');share.className='btn';share.textContent='Share Link';
    share.onclick=()=>navigator.clipboard.writeText(location.origin+location.pathname+`?uid=${uid}&study=${studyId}`).then(()=>alert("Link copied"));
    const toggle=document.createElement('button');toggle.className='btn';toggle.textContent=study.isPublic?"Unpublish":"Publish";
    toggle.onclick=()=>{db.ref(`users/${uid}/studies/${studyId}/isPublic`).set(!study.isPublic);};
    const del=document.createElement('button');del.className='btn btn-accent';del.textContent='Delete';
    del.onclick=()=>db.ref(`users/${uid}/studies/${studyId}`).remove().then(()=>div.remove());
    const res=document.createElement('button');res.className='btn btn-success';res.textContent='Results';
    res.onclick=()=>alert("Results view - placeholder"); // hook in resultsView rendering
    actions.append(share,toggle,res,del);
    div.append(actions);studiesList.append(div);
  }
});
</script>
</body>
</html>
