<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pasifika Open Card Sorting Tool</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #4a6fa5; --secondary: #6b8cae; --accent: #ff6b6b; --light: #f8f9fa; --dark: #343a40;
      --success: #28a745; --border: #dee2e6; --orange: #f59e0b; --orange-dark: #d97706;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Poppins', 'Segoe UI', system-ui, -apple-system, Roboto, Arial, sans-serif; }
    html, body { height: 100%; }
    body { background: #f8fafc; color: var(--dark); line-height: 1.6; font-size: 16px; }

    /* NEW: App Layout */
    .app-layout { display: grid; grid-template-rows: auto 1fr; grid-template-columns: 60px 1fr; height: 100%; }
    #appHeader { grid-area: 1 / 2 / 2 / 3; background: #fff; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: flex-end; padding: 0 2rem; height: 60px; }
    #appSidebar { grid-area: 1 / 1 / 3 / 2; background: #fff; border-right: 1px solid var(--border); padding: 1rem 0; display: flex; flex-direction: column; align-items: center; gap: 1rem; }
    #appMain { grid-area: 2 / 2 / 3 / 3; overflow-y: auto; padding: 2rem; }
    .sidebar-icon { font-size: 1.5rem; cursor: pointer; color: #9ca3af; }
    .sidebar-icon:hover { color: var(--primary); }
    #userProfile { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; }
    #userAvatar { width: 32px; height: 32px; border-radius: 50%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; }

    .container { max-width: 1200px; margin: 0 auto; }
    .simple-header { text-align: center; margin-bottom: 2rem; }
    
    .view { display: none; background: transparent; padding: 0; border-radius: 0; box-shadow: none; }
    .view.active { display: block; }
    .view-card { background: white; padding: 2rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,.05); border: 1px solid var(--border); }
    
    .btn { padding: .5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-size: 0.95rem; font-weight: 600; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { filter: brightness(1.1); }
    .btn-orange { background: var(--orange); color: white; }
    .btn-orange:hover { background: var(--orange-dark); }
    .btn-secondary { background: #e2e8f0; color: var(--dark); }
    .btn-secondary:hover { background: #cbd5e1; }
    .btn-accent { background: var(--accent); color: #fff; }
    .btn-accent:hover { filter: brightness(0.95); }

    .hidden { display: none !important; }
    .muted { color: #64748b; }
    
    /* NEW: Dashboard Styles */
    #dashboardView .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
    #dashboardView h2 { font-size: 2rem; }
    .study-card { background: #fff; border: 1px solid var(--border); border-radius: 12px; margin-bottom: 1.5rem; padding: 1.5rem; }
    .study-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
    .study-card-title { display: flex; align-items: center; gap: 1rem; }
    .study-card-title h3 { margin: 0; font-size: 1.25rem; }
    .study-card-icon { font-size: 1.5rem; color: var(--primary); }
    .study-card-body { padding-top: 1rem; }
    .actions-menu { position: relative; }
    .actions-menu-content { display: none; position: absolute; right: 0; top: 100%; background: white; border: 1px solid var(--border); border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); z-index: 100; min-width: 200px; }
    .actions-menu:hover .actions-menu-content { display: block; }
    .actions-menu-content button { display: block; width: 100%; text-align: left; background: none; border: none; padding: 0.75rem 1rem; cursor: pointer; }
    .actions-menu-content button:hover { background: #f1f5f9; }
    .empty-dashboard { text-align: center; padding: 4rem 2rem; border: 2px dashed var(--border); border-radius: 12px; background: #fafafa; }
    
    /* NEW: Setup/Edit View Styles */
    #setupView .setup-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); }
    #setupStudyName { font-size: 1.5rem; margin: 0; }
    #setupView .tabs { margin: 0 0 1.5rem 0; }

    /* Cards */
    .card { background: white; border: 1px solid var(--border); padding: 1rem; margin: .25rem; border-radius: 6px; cursor: grab; user-select: none; box-shadow: 0 1px 0 rgba(0,0,0,0.05); position: relative; font-size: 1rem; }
    .info-icon { position: absolute; top: 6px; right: 6px; background: transparent; border: none; color: #6b7280; font-size: 18px; cursor: pointer; }
    
    /* Participant Workspace */
    .workspace { display: grid; grid-template-columns: 300px 1fr 1fr 1fr; gap: 16px; align-items: start; }
    #availableCardsContainer { background: #e2e8f0; border-radius: 10px; padding: 12px; position: sticky; top: 12px; max-height: calc(100vh - 180px); overflow-y: auto; }
    .category-columns-wrap { grid-column: 2 / 5; display: contents; }
    .category-column { min-height: 60vh; display: flex; flex-direction: column; gap: 16px; }
    .drop-zone-placeholder { border: 2px dashed #cbd5e1; border-radius: 10px; min-height: 110px; padding: 14px; background: #f8fafc; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-weight: 600; text-align: center; }
    .toolbar { margin-bottom: .5rem; display: flex; gap: .5rem; align-items: center; flex-wrap: wrap; justify-content: flex-end; grid-column: 1 / -1; }
    .category { background: #fff; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.06); border: 1px solid var(--border); }
    .cat-header { background: #334155; color: #fff; padding: .5rem .75rem; }
    .cat-title-input { background: transparent; border: none; color: #fff; font-weight: 600; width: 100%; outline: none; padding: .15rem .25rem; font-size: 1rem; }
    .cat-body { padding: .5rem; background: #f8fafc; margin: .5rem; border: 1px solid var(--border); border-radius: 8px; min-height: 80px; }
    .cat-footer { text-align: center; font-size: .75rem; color: #64748b; padding: .25rem .5rem .6rem; text-transform: uppercase; }

    /* Results Page Styles */
    #participantsPieChartWrap { display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem; padding: 1rem; background: #f8fafc; border-radius: 8px; border: 1px solid var(--border); }
    #participantsPieChart { width: 100px; height: 100px; border-radius: 50%; }
    .legend-dot { width: 12px; height: 12px; border-radius: 50%; }
    .matrix-table-wrap { overflow-x: auto; padding: 1rem; background-color: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef; }
    .similarity-matrix { border-collapse: collapse; width: 100%; font-size: 0.9rem; color: var(--dark); }
    .similarity-matrix th, .similarity-matrix td { border: 1px solid #dee2e6; padding: 0.5rem; text-align: center; min-width: 60px; height: 36px; }
    .similarity-matrix .label-cell { text-align: left; font-weight: 600; background-color: #e9ecef; padding-left: 1rem; }
    .similarity-matrix thead th { position: sticky; top: 0; background-color: #f8f9fa; z-index: 10; }
    #matrixTooltip { position: absolute; display: none; background: rgba(10,20,30,0.9); color: white; padding: 8px 12px; border-radius: 6px; z-index: 10000; pointer-events: none; }
    .results-table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.95rem; }
    .results-table th, .results-table td { border: 1px solid var(--border); padding: 0.75rem; text-align: left; }
  </style>
</head>
<body>

  <!-- NEW: Main App Shell for Researchers -->
  <div class="app-layout">
    <header id="appHeader" class="hidden">
      <div id="userProfile">
        <span id="userName"></span>
        <div id="userAvatar"></div>
        <button id="logoutBtn" class="btn btn-secondary" style="margin-left: 1rem;">Logout</button>
      </div>
    </header>
    <aside id="appSidebar" class="hidden">
      <div class="sidebar-icon">üè†</div>
      <div class="sidebar-icon">üí°</div>
      <div class="sidebar-icon">üë•</div>
    </aside>

    <main id="appMain">
      <div class="container">
        <!-- Views will be rendered inside here -->
      </div>
    </main>
  </div>
  
  <div id="matrixTooltip"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const firebaseConfig = {
        apiKey: "AIzaSyAu1hawycY2uQgzWolaHeTfCdWtSWux7XA",
        authDomain: "card-sorting-tool-762a3.firebaseapp.com",
        databaseURL: "https://card-sorting-tool-762a3-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "card-sorting-tool-762a3",
        storageBucket: "card-sorting-tool-762a3.firebasestorage.app",
        messagingSenderId: "361630774945",
        appId: "1:361630774945:web:402edb363d388a61baa2e0",
        measurementId: "G-BGV3P2HQZP"
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.database();

      // Main App Shell
      const appHeader = document.getElementById('appHeader');
      const appSidebar = document.getElementById('appSidebar');
      const appMainContainer = document.querySelector('#appMain .container');

      // Global state
      let currentViews = {};
      let lastResultsCache = null;
      let currentEditingStudyId = null;

      // Helpers
      function sanitizeText(v) { return String(v ?? '').replace(/<[^>]*>/g, '').replace(/[\u0000-\u001F\u007F]/g, '').replace(/\s+/g, ' ').trimStart().slice(0, 500); }
      function finalSanitize(v) { return sanitizeText(v).trim(); }
      function makeShareLink(uid, studyId) { const base = new URL(window.location.href); base.search = ''; base.hash = ''; return `${base.toString()}?uid=${uid}&study=${studyId}`; }

      // --- TEMPLATES ---
      // Using template literals for cleaner HTML generation
      const getAuthViewHTML = () => `
        <div class="view" id="authView">
          <div style="max-width: 400px; margin: 4rem auto;">
            <div class="view-card">
              <h2 style="text-align: center; margin-bottom: 2rem;">Researcher Login</h2>
              <form id="authForm" novalidate>
                <label for="displayName">Full name (for new sign-ups)</label>
                <input type="text" id="displayName" autocomplete="name"/>
                <label for="email">Email</label>
                <input type="email" id="email" autocomplete="username" required/>
                <label for="password">Password</label>
                <input type="password" id="password" autocomplete="current-password" required/>
                <div>
                  <button id="loginBtn" type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                  <button id="signupBtn" type="button" class="btn btn-secondary" style="width: 100%; margin-top: 0.5rem;">Sign Up</button>
                </div>
              </form>
            </div>
          </div>
        </div>`;
        
      const getDashboardViewHTML = (userName) => `
        <div class="view" id="dashboardView">
            <div class="dashboard-header">
                <h2>Hello, ${userName}</h2>
                <button id="createStudyBtn" class="btn btn-orange">Ôºã New study</button>
            </div>
            <div id="studiesList"></div>
        </div>`;

      const getSetupViewHTML = () => `
        <div class="view" id="setupView">
            <div class="setup-header">
                <h2 id="setupStudyName">New Card Sorting Study</h2>
                <div>
                    <button id="previewStudyBtn" class="btn btn-secondary">Preview</button>
                    <button id="launchStudyBtn" class="btn btn-orange">Launch</button>
                </div>
            </div>
            <div class="view-card">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="general">General</button>
                    <button class="tab-btn" data-tab="cards">Cards</button>
                </div>
                <div id="tabGeneral" class="tab-pane active">
                    <label for="studyName">Study name</label>
                    <input type="text" id="studyName" required/>
                    <label for="instructionsInput">Welcome Message / Instructions (optional)</label>
                    <textarea id="instructionsInput" rows="4"></textarea>
                </div>
                <div id="tabCards" class="tab-pane">
                    <label><input type="checkbox" id="enableDescriptions"/> Add descriptions (tooltips) to cards</label>
                    <div id="simpleCardsWrap">
                        <label for="cardsInput">Cards (one per line)</label>
                        <textarea id="cardsInput" rows="8"></textarea>
                    </div>
                    <div id="builderWrap" class="builder-wrap hidden">
                        <div class="builder-head">
                            <strong>Cards and descriptions</strong>
                            <button type="button" id="addCardRowBtn" class="btn btn-secondary">Add Card</button>
                        </div>
                        <div id="builderRows" class="builder-rows"></div>
                    </div>
                </div>
            </div>
        </div>`;
      
      const getParticipantViewHTML = () => `
        <div class="view" id="participantView">
          <div class="simple-header">
            <h1 id="participantStudyName" style="font-size: 2rem;"></h1>
            <p id="cardDescriptionInfo" class="muted hidden">Click the ‚ÑπÔ∏è icon on a card to see its description.</p>
          </div>
          <div class="workspace">
            <div class="toolbar">
              <button id="showInstructionsBtn" class="btn btn-secondary">Instructions</button>
              <button id="fullscreenBtn" class="btn btn-secondary">Full Screen</button>
              <button id="submitSortingBtn" class="btn btn-primary">Finish Sorting</button>
            </div>
            <aside id="availableCardsContainer">
              <h3>Unsorted Cards</h3>
              <div id="availableCards" class="cards-list"></div>
            </aside>
            <div class="category-columns-wrap">
              <div class="category-column"></div> <div class="category-column"></div> <div class="category-column"></div>
            </div>
          </div>
        </div>`;
      
      const getResultsViewHTML = () => `
        <div class="view" id="resultsView">
            <h2>Study Results: <span id="resultsStudyName"></span></h2>
            <div class="tabs">
              <button class="tab-btn active" data-tab="participants">Participants</button>
              <button class="tab-btn" data-tab="categories">Categories</button>
              <button class="tab-btn" data-tab="matrix">Similarity Matrix</button>
            </div>
            <div id="tabParticipants" class="tab-pane active"><div id="participantsPieChartWrap"></div><div id="participantsDetails"></div></div>
            <div id="tabCategories" class="tab-pane"><div id="categoriesSummary"></div><div class="chart-wrap"><div class="chart" id="categoriesChart"></div><div class="xlabels" id="categoriesLabels"></div></div></div>
            <div id="tabMatrix" class="tab-pane"><div id="matrixMeta"></div><div id="matrixTableWrap" class="matrix-table-wrap"></div></div>
        </div>`;

      // --- VIEW MANAGEMENT ---
      function showView(viewName, ...args) {
          appMainContainer.innerHTML = '';
          let viewHTML = '';
          switch(viewName) {
              case 'auth': viewHTML = getAuthViewHTML(); break;
              case 'dashboard': viewHTML = getDashboardViewHTML(...args); break;
              case 'setup': viewHTML = getSetupViewHTML(); break;
              case 'participant': viewHTML = getParticipantViewHTML(); break;
              case 'results': viewHTML = getResultsViewHTML(); break;
          }
          appMainContainer.innerHTML = viewHTML;
          const viewElement = appMainContainer.querySelector('.view');
          if (viewElement) viewElement.classList.add('active');
          return viewElement;
      }

      // --- AUTHENTICATION & APP SHELL ---
      auth.onAuthStateChanged(user => {
          const params = new URLSearchParams(location.search);
          const isParticipantLink = params.has('uid') && params.has('study');

          if (user) {
              // Researcher is logged in
              appHeader.classList.remove('hidden');
              appSidebar.classList.remove('hidden');
              document.getElementById('userName').textContent = user.displayName || user.email;
              document.getElementById('userAvatar').textContent = (user.displayName || user.email).charAt(0).toUpperCase();
              document.getElementById('logoutBtn').onclick = () => auth.signOut();
              showDashboard(user);
          } else if (isParticipantLink) {
              // Participant view
              appHeader.classList.add('hidden');
              appSidebar.classList.add('hidden');
              loadParticipantView(params.get('uid'), params.get('study'));
          } else {
              // Not logged in, show auth page
              appHeader.classList.add('hidden');
              appSidebar.classList.add('hidden');
              const view = showView('auth');
              view.querySelector('#loginBtn').onclick = async (e) => { e.preventDefault(); try { await auth.signInWithEmailAndPassword(view.querySelector('#email').value, view.querySelector('#password').value); } catch (err) { alert(err.message); } };
              view.querySelector('#signupBtn').onclick = async () => { try { const name = finalSanitize(view.querySelector('#displayName').value); if (!name) { alert('Please enter full name'); return; } const cred = await auth.createUserWithEmailAndPassword(view.querySelector('#email').value, view.querySelector('#password').value); await cred.user.updateProfile({ displayName: name }); } catch (err) { alert(err.message); } };
          }
      });

      // --- DASHBOARD LOGIC ---
      function showDashboard(user) {
          const view = showView('dashboard', user.displayName);
          view.querySelector('#createStudyBtn').onclick = () => showSetupView(user.uid);
          const studiesList = view.querySelector('#studiesList');
          db.ref(`users/${user.uid}/studies`).once('value').then(snap => {
              const studies = snap.val();
              if (!studies) {
                  studiesList.innerHTML = `<div class="empty-dashboard"><h3>Organize content to perfection</h3><p>Create your first card sorting study to get started.</p></div>`;
                  return;
              }
              Object.entries(studies).forEach(([studyId, study]) => {
                  const card = document.createElement('div');
                  card.className = 'study-card';
                  card.innerHTML = `
                      <div class="study-card-header">
                          <div class="study-card-title">
                              <span class="study-card-icon">üóÇÔ∏è</span>
                              <h3>${study.name || '(Untitled Study)'}</h3>
                          </div>
                          <div class="actions-menu">
                              <button class="btn btn-secondary">Setup ‚ñæ</button>
                              <div class="actions-menu-content">
                                  <button class="action-preview">Study preview</button>
                                  <button class="action-copy-link">Copy study address</button>
                                  <button class="action-clone">Clone study</button>
                                  <button class="action-delete" style="color: var(--accent);">Delete study</button>
                              </div>
                          </div>
                      </div>
                      <div class="study-card-body">
                          <button class="btn btn-primary action-results">View Results</button>
                      </div>
                  `;
                  card.querySelector('.action-preview').onclick = () => window.open(makeShareLink(user.uid, studyId), '_blank');
                  card.querySelector('.action-copy-link').onclick = async () => { await navigator.clipboard.writeText(makeShareLink(user.uid, studyId)); alert('Link copied!'); };
                  card.querySelector('.action-clone').onclick = () => cloneStudy(user.uid, studyId);
                  card.querySelector('.action-delete').onclick = () => deleteStudy(user.uid, studyId, study.name);
                  card.querySelector('.action-results').onclick = () => viewResults(user.uid, studyId);
                  list.appendChild(card);
              });
          });
      }

      async function cloneStudy(uid, studyId) {
          if (!confirm("Are you sure you want to clone this study?")) return;
          const studyRef = db.ref(`users/${uid}/studies/${studyId}`);
          const snap = await studyRef.once('value');
          const studyData = snap.val();
          if (studyData) {
              const newStudyId = 'study_' + Date.now();
              const newStudyData = { ...studyData, name: studyData.name + ' (Copy)', createdAt: new Date().toISOString(), results: null };
              await db.ref(`users/${uid}/studies/${newStudyId}`).set(newStudyData);
              alert("Study cloned successfully!");
              showDashboard(auth.currentUser);
          }
      }

      async function deleteStudy(uid, studyId, studyName) {
          if (!confirm(`Are you sure you want to delete "${studyName}" and all its results? This cannot be undone.`)) return;
          await db.ref(`users/${uid}/studies/${studyId}`).remove();
          alert("Study deleted.");
          showDashboard(auth.currentUser);
      }

      // --- SETUP/EDIT VIEW LOGIC ---
      function showSetupView(uid, studyId = null) {
          currentEditingStudyId = studyId;
          const view = showView('setup');
          
          const studyNameInput = view.querySelector('#studyName');
          const setupStudyName = view.querySelector('#setupStudyName');
          studyNameInput.oninput = () => { setupStudyName.textContent = studyNameInput.value || 'New Card Sorting Study'; };

          view.querySelector('#previewStudyBtn').onclick = () => {
              if (currentEditingStudyId) {
                  window.open(makeShareLink(uid, currentEditingStudyId), '_blank');
              } else {
                  alert("Please launch the study first to get a preview link.");
              }
          };
          
          view.querySelector('#launchStudyBtn').onclick = () => saveStudy(uid);
          
          // Tab logic
          const tabs = view.querySelectorAll('.tab-btn');
          const panes = view.querySelectorAll('.tab-pane');
          tabs.forEach(tab => {
              tab.onclick = () => {
                  tabs.forEach(t => t.classList.remove('active'));
                  panes.forEach(p => p.classList.remove('active'));
                  tab.classList.add('active');
                  view.querySelector(`#tab${tab.dataset.tab.charAt(0).toUpperCase() + tab.dataset.tab.slice(1)}`).classList.add('active');
              };
          });

          // Builder logic
          const enableDescriptions = view.querySelector('#enableDescriptions');
          const builderWrap = view.querySelector('#builderWrap');
          const simpleCardsWrap = view.querySelector('#simpleCardsWrap');
          const builderRows = view.querySelector('#builderRows');
          
          const addCardRow = (name = '', desc = '') => {
            const row = document.createElement('div'); row.className = 'builder-row';
            row.innerHTML = `<input type="text" value="${name}" placeholder="Card name"/> <input type="text" value="${desc}" placeholder="Description"/> <button type="button" class="row-del">√ó</button>`;
            row.querySelector('.row-del').onclick = () => row.remove();
            builderRows.appendChild(row);
          };
          view.querySelector('#addCardRowBtn').onclick = () => addCardRow();
          
          enableDescriptions.onchange = () => {
              builderWrap.classList.toggle('hidden', !enableDescriptions.checked);
              simpleCardsWrap.classList.toggle('hidden', enableDescriptions.checked);
          };
      }
      
      async function saveStudy(uid) {
          const studyData = {
              name: finalSanitize(document.getElementById('studyName').value),
              instructions: finalSanitize(document.getElementById('instructionsInput').value),
              hasDescriptions: document.getElementById('enableDescriptions').checked,
              createdAt: new Date().toISOString(),
              ownerUid: uid,
              isPublic: true,
              cards: []
          };
          if (!studyData.name) { alert("Please enter a study name."); return; }

          if (studyData.hasDescriptions) {
              studyData.cards = Array.from(document.querySelectorAll('#builderRows .builder-row')).map(r => ({ text: finalSanitize(r.children[0].value), desc: finalSanitize(r.children[1].value) })).filter(c => c.text);
          } else {
              studyData.cards = document.getElementById('cardsInput').value.split('\n').map(finalSanitize).filter(Boolean);
          }

          if (studyData.cards.length === 0) { alert("Please add at least one card."); return; }

          const studyId = currentEditingStudyId || 'study_' + Date.now();
          await db.ref(`users/${uid}/studies/${studyId}`).set(studyData);
          alert("Study launched successfully!");
          showDashboard(auth.currentUser);
      }

      // --- RESULTS & PARTICIPANT LOGIC (FROM PREVIOUS VERSIONS, ADAPTED) ---
      
      function viewResults(uid, studyId) {
          db.ref(`users/${uid}/studies/${studyId}`).once('value').then(snap => {
              const study = snap.val();
              if (!study) { alert("Study not found."); return; }
              const view = showView('results');
              view.querySelector('#resultsStudyName').textContent = study.name;
              db.ref(`users/${uid}/studies/${studyId}/results`).once('value').then(snap2 => {
                  buildResultsUI(study, snap2.val() || {});
              });
          });
      }

      function buildResultsUI(study, resultsObj) {
        const arr = Object.values(resultsObj || {}).sort((a, b) => new Date(a.timestamp || 0) - new Date(b.timestamp || 0));
        lastResultsCache = null; document.getElementById('downloadCsvBtn').disabled = true; document.getElementById('downloadMatrixBtn').disabled = true;
        const participantsPieChartWrap = document.getElementById('participantsPieChartWrap'), participantsDetails = document.getElementById('participantsDetails'), categoriesSummary = document.getElementById('categoriesSummary'), categoriesChart = document.getElementById('categoriesChart'), categoriesLabels = document.getElementById('categoriesLabels'), matrixMeta = document.getElementById('matrixMeta'), matrixTableWrap = document.getElementById('matrixTableWrap');
        participantsPieChartWrap.innerHTML = ''; participantsDetails.innerHTML = ''; categoriesSummary.textContent = '';
        categoriesChart.innerHTML = ''; categoriesLabels.innerHTML = ''; matrixMeta.textContent = ''; matrixTableWrap.innerHTML = '';

        if (arr.length === 0) {
            participantsDetails.innerHTML = '<p>No results yet.</p>';
            return;
        }

        const completed = arr.filter(r => r.status === 'completed' && Array.isArray(r.categories));
        const startedCount = arr.length, completedCount = completed.length, abandonedCount = startedCount - completedCount;
        const completionRate = startedCount > 0 ? (completedCount / startedCount) * 100 : 0;
        
        // Participants Tab
        const pieAngle = completionRate * 3.6;
        participantsPieChartWrap.innerHTML = `<div id="participantsPieChart" style="background: conic-gradient(var(--success) 0deg, var(--success) ${pieAngle}deg, var(--accent) ${pieAngle}deg, var(--accent) 360deg);"></div><div><h3>Participant Summary</h3><p><strong>${completionRate.toFixed(1)}%</strong> Completion Rate</p><ul><li><span class="legend-dot" style="background: var(--success);"></span> Completed: <strong>${completedCount}</strong></li><li><span class="legend-dot" style="background: var(--accent);"></span> Abandoned: <strong>${abandonedCount}</strong></li><li>Total Started: <strong>${startedCount}</strong></li></ul></div>`;
        const pTable = document.createElement('table'); pTable.className = 'results-table';
        pTable.innerHTML = `<thead><tr><th>#</th><th>Name</th><th>ID</th><th>Course</th><th>Duration</th><th>Categories</th></tr></thead><tbody></tbody>`;
        pTable.querySelector('tbody').innerHTML = completed.map((res, i) => {
            const pinfo = res.participant || {};
            return `<tr><td>${i + 1}</td><td>${pinfo.name || 'N/A'}</td><td>${pinfo.idNumber || 'N/A'}</td><td>${pinfo.course || 'N/A'}</td><td>${typeof res.durationMs === 'number' ? formatDuration(res.durationMs) : 'N/A'}</td><td>${(res.categories || []).length}</td></tr>`;
        }).join('');
        participantsDetails.appendChild(pTable);

        // Categories Tab
        const catsPer = completed.map(r => r.categories.length);
        if (catsPer.length > 0) { const avgCats = catsPer.reduce((a, b) => a + b, 0) / catsPer.length;
            categoriesSummary.textContent = `Average categories created: ${avgCats.toFixed(2)} (n=${completedCount})`;
            const dist = new Map(); catsPer.forEach(n => dist.set(n, (dist.get(n) || 0) + 1));
            const maxBuckets = Math.max(...dist.keys());
            const counts = Array.from({ length: maxBuckets }, (_, i) => dist.get(i + 1) || 0);
            const peak = Math.max(...counts, 1);
            counts.forEach((count, idx) => {
                const bar = document.createElement('div'); bar.className = 'bar'; bar.style.height = `${Math.round((count / peak) * 100)}%`;
                bar.innerHTML = `<span>${count}</span>`; categoriesChart.appendChild(bar);
                const xl = document.createElement('div'); xl.className = 'xlabel'; xl.textContent = String(idx + 1); categoriesLabels.appendChild(xl);
            });
           }

        // Similarity Matrix Tab
        const cardTexts = (study?.cards || []).map(c => typeof c === 'string' ? c : (c?.text || '')).filter(Boolean);
        const matrixCounts = {}; cardTexts.forEach(a => { matrixCounts[a] = {}; cardTexts.forEach(b => matrixCounts[a][b] = 0); });
        completed.forEach(r => { (r.categories || []).forEach(cat => { (cat.cards || []).forEach((a, i) => { for (let j = i + 1; j < cat.cards.length; j++) { const b = cat.cards[j]; matrixCounts[a][b]++; matrixCounts[b][a]++; } }); }); });
        
        matrixMeta.innerHTML = `<p class="muted">Percentages show how often cards were grouped together (n=${completedCount}).</p>`;
        const mTable = document.createElement('table'); mTable.className = 'similarity-matrix';
        mTable.innerHTML = `<thead><tr><th></th>${cardTexts.map(c => `<th>${c}</th>`).join('')}</tr></thead><tbody></tbody>`;
        mTable.querySelector('tbody').innerHTML = cardTexts.map(card_i => `<tr><th class="label-cell">${card_i}</th>${cardTexts.map(card_j => { const pct = completedCount > 0 ? (matrixCounts[card_i][card_j] / completedCount * 100) : 0; const alpha = 0.05 + (pct * 0.0095); return `<td style="background-color: hsla(210, 100%, 50%, ${alpha})" data-pct="${pct.toFixed(0)}" data-card-i="${card_i}" data-card-j="${card_j}">${pct.toFixed(0)}</td>`; }).join('')}</tr>`).join('');
        matrixTableWrap.appendChild(mTable);
        
        lastResultsCache = { arr, completed, completedCount, study, cards: cardTexts, matrixCounts };
        document.getElementById('downloadCsvBtn').disabled = false;
        document.getElementById('downloadMatrixBtn').disabled = false;
      }
      
      // Matrix Tooltip Logic
      matrixTableWrap.addEventListener('mousemove', e => {
          const cell = e.target.closest('td');
          if (!cell || !cell.dataset.cardI) { matrixTooltip.style.display = 'none'; return; }
          matrixTooltip.style.display = 'block';
          matrixTooltip.style.left = `${e.pageX + 15}px`;
          matrixTooltip.style.top = `${e.pageY + 15}px`;
          matrixTooltip.innerHTML = `<div class="pair">${cell.dataset.cardI} &<br>${cell.dataset.cardJ}</div><div>Agreement: <strong>${cell.dataset.pct}%</strong></div>`;
      });
      matrixTableWrap.addEventListener('mouseleave', () => matrixTooltip.style.display = 'none');
      
      // Share & Public View Logic
      function setupShareControls(uid, studyId, study) { shareSection.classList.remove('hidden'); toggleResultsPublic.checked = !!study.resultsPublic; publicResultsLink.value = makePublicResultsLink(uid, studyId); publicResultsLinkRow.classList.toggle('hidden', !study.resultsPublic); toggleResultsPublic.onchange = async () => { const val = toggleResultsPublic.checked; publicResultsLinkRow.classList.toggle('hidden', !val); await db.ref(`users/${uid}/studies/${studyId}/resultsPublic`).set(val); }; copyPublicResultsBtn.onclick = async () => { await navigator.clipboard.writeText(publicResultsLink.value); alert('Public results link copied!'); }; }
      function viewResults(uid, studyId) { db.ref(`users/${uid}/studies/${studyId}`).once('value').then(snap => { const study = snap.val(); resultsStudyName.textContent = study?.name || ''; setupShareControls(uid, studyId, study || {}); db.ref(`users/${uid}/studies/${studyId}/results`).once('value').then(snap2 => buildResultsUI(study || {}, snap2.val() || {})); }); }
      function loadPublicResults(uid, studyId) { shareSection.classList.add('hidden'); db.ref(`users/${uid}/studies/${studyId}`).once('value').then(snap => { const study = snap.val(); resultsStudyName.textContent = study?.name || ''; if (!study || !study.resultsPublic) { participantsDetails.innerHTML = '<p>These results are not publicly available.</p>'; activateTab('participants'); return; } db.ref(`users/${uid}/studies/${studyId}/results`).once('value').then(snap2 => buildResultsUI(study, snap2.val() || {})); }); }
      
      // CSV Export Logic
      downloadCsvBtn.onclick = () => { if (!lastResultsCache) return; const { arr, study } = lastResultsCache; const studyName = (study?.name || 'study').replace(/[^\w\-]+/g, '_'); const headers = ['Participant #','Timestamp','Name','ID Number','Course','Nationality','Ethnicity','HomeOutsideSuvaNausori','Category','Card']; const lines = [headers.join(',')]; let idx = 0; arr.filter(r => r.status === 'completed').forEach(res => { idx++; const p = res.participant || {}; const ts = res.timestamp || res.completedAt || ''; (res.categories || []).forEach(cat => { (cat.cards || []).forEach(card => lines.push([csvEscape(idx),csvEscape(ts),csvEscape(p.name),csvEscape(p.idNumber),csvEscape(p.course),csvEscape(p.nationality),csvEscape(p.ethnicity),csvEscape(p.outsideHome),csvEscape(cat.name),csvEscape(card)].join(','))); }); }); downloadCSV(`${studyName}_results.csv`, lines.join('\n')); };
      downloadMatrixBtn.onclick = () => { if (!lastResultsCache) return; const { study, cards, matrixCounts, completedCount } = lastResultsCache; const studyName = (study?.name || 'study').replace(/[^\w\-]+/g, '_'); const head = [''].concat(cards).map(csvEscape).join(','); const lines = [head]; cards.forEach(a => { const row = [csvEscape(a)]; cards.forEach(b => { const pct = completedCount > 0 ? (matrixCounts[a][b] / completedCount * 100) : 0; row.push(csvEscape(`${pct.toFixed(0)}%`)); }); lines.push(row.join(',')); }); downloadCSV(`${studyName}_similarity_matrix.csv`, lines.join('\n')); };
      
      // Initial Routing
      if (isPublicResultsLink) { show(resultsView); loadPublicResults(pUid, pStudyId); }
      else if (hasParticipantLink) { show(participantView); loadParticipantView(pUid, pStudyId); }

    });
  </script>
</body>
</html>
